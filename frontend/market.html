<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitchLense ‚Äî Market Performance</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <script>
      tailwind.config = { theme: { extend: { colors: { background:'#1E1E21', surface:'#2E3137', text:'#ffffff', secondary:'#cfd4dd', accent:'#f1d85b' }}}}
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body class="bg-background text-text font-sans antialiased overflow-x-hidden bg-solid">
    <div class="h-screen flex flex-col p-3 gap-3">
      <header class="h-16 bg-[#2E3137] border border-white/10 rounded-[22px] flex items-center justify-between px-6 mobile-header">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-accent grid place-items-center"><img src="/static/logo.svg" class="w-5 h-5"/></div>
          <div class="text-base font-semibold">PitchLense</div>
        </div>
        <div class="flex items-center gap-3">
          <!-- Mobile menu button -->
          <button id="mobileMenuBtn" class="md:hidden w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
          </button>
          <button id="refreshBtn" title="Refresh Market Data" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10"/>
              <polyline points="1 20 1 14 7 14"/>
              <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
              <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
            </svg>
          </button>
          <div id="userProfileIcon" class="w-9 h-9 rounded-full border border-white/10 bg-[#FFF27A] grid place-items-center text-[#1E1E21] relative group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
            </svg>
            <div id="userEmailTooltip" class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              <span id="userEmailText">Loading...</span>
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-[#1E1E21]"></div>
            </div>
          </div>
        </div>
      </header>

      <div class="grid flex-1 min-h-0 mobile-navbar" style="grid-template-columns: 84px 1fr; gap:12px;">
        <!-- Mobile responsive styles -->
        <style>
          @media (max-width: 768px) {
            .mobile-navbar {
              grid-template-columns: 1fr !important;
              gap: 8px !important;
            }
            .mobile-main {
              padding: 12px !important;
            }
            .mobile-header {
              padding: 12px 16px !important;
            }
            #pitchlense-navbar {
              display: none !important;
            }
            .flex.items-center.justify-between {
              flex-direction: row !important;
              align-items: center !important;
              gap: 8px !important;
            }
            #aiSummaryBtn {
              display: none !important;
            }
          }
          @media (max-width: 480px) {
            .mobile-card {
              padding: 16px !important;
            }
            .mobile-header {
              padding: 8px 12px !important;
            }
            .mobile-main {
              padding: 8px !important;
            }
            #aiSummaryModal .bg-\[#2C2F34\] {
              margin: 8px !important;
              max-height: calc(100vh - 16px) !important;
            }
            #aiSummaryModal .p-6 {
              padding: 16px !important;
            }
            #aiSummaryModal .text-xl {
              font-size: 1.125rem !important;
            }
            #aiSummaryModal .space-y-6 > * + * {
              margin-top: 16px !important;
            }
            #aiSummaryBtn {
              padding: 8px 12px !important;
              font-size: 0.875rem !important;
            }
            #aiSummaryBtn svg {
              width: 16px !important;
              height: 16px !important;
            }
          }
        </style>
        <aside id="pitchlense-navbar" class="bg-[#2C2F34] border border-white/10 rounded-[18px] flex flex-col items-center py-4 gap-3">
          <!-- Navbar content will be rendered by navbar.js -->
        </aside>

        <main class="flex-1 overflow-y-auto p-4 mobile-main">
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
                  <path d="M3 3v18h18"/>
                  <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                </svg>
                Market Performance
              </h2>
              <p class="text-white/60 mt-1" id="lastUpdate">Last updated: Loading...</p>
            </div>
            <button id="aiSummaryBtn" class="flex items-center gap-2 px-4 py-2 bg-[#FFF27A] text-[#1E1E21] rounded-lg font-medium hover:bg-[#FFF27A]/90 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
                <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
                <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"/>
                <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"/>
              </svg>
              AI Summary
            </button>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="min-h-[60vh] grid place-items-center">
            <div class="text-center">
              <div class="mx-auto w-20 h-20 rounded-2xl bg-white/5 border border-white/10 grid place-items-center mb-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FFF27A]"></div>
              </div>
              <div class="text-lg font-semibold text-white">Loading Market Data...</div>
              <div class="text-sm text-white/60 mt-1">Fetching latest market information</div>
            </div>
          </div>

          <!-- Main Content -->
          <div id="mainContent" class="hidden">
            <!-- Commodities Overview - KPI Section -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üõ¢Ô∏è Commodities Overview</h3>
              <div id="commoditiesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Commodities will be populated here -->
              </div>
            </div>

            <!-- Top Gainers & Losers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <span class="text-green-400">‚ñ≤</span> Top 10 Gainers
                </h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="gainersChart"></canvas>
                </div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <span class="text-red-400">‚ñº</span> Top 10 Losers
                </h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="losersChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Treasury Rates -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìä US Treasury Rates</h3>
              <div class="relative overflow-hidden" style="height: 350px;">
                <canvas id="treasuryChart"></canvas>
              </div>
            </div>

            <!-- Economic Indicators -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìà Economic Indicators</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">GDP</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="gdpChart"></canvas>
                  </div>
                </div>
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">Real GDP Per Capita</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="gdpPerCapitaChart"></canvas>
                  </div>
                </div>
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">Unemployment Rate</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="unemploymentChart"></canvas>
                  </div>
                </div>
                <div class="card p-6 md:col-span-2 xl:col-span-3">
                  <h4 class="text-md font-medium text-white mb-3">US Recession Probabilities</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="recessionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sector & Industry Performance -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">üè≠ Sector Performance (Energy)</h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="sectorChart"></canvas>
                </div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">üß¨ Industry Performance (Biotechnology)</h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="industryChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Sector PE Ratio -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìä Historical Sector P/E Ratio (Energy)</h3>
              <div class="relative overflow-hidden" style="height: 300px;">
                <canvas id="sectorPEChart"></canvas>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- AI Summary Modal -->
    <div id="aiSummaryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2C2F34] border border-white/10 rounded-[18px] w-full max-w-4xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-[#FFF27A] grid place-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 12l2 2 4-4"/>
                  <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
                  <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
                  <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"/>
                  <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3"/>
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-white">AI Market Analysis</h3>
                <p class="text-white/60 text-sm">Comprehensive market insights and recommendations</p>
              </div>
            </div>
            <button id="closeAiSummaryModal" class="w-8 h-8 grid place-items-center rounded-full bg-white/10 hover:bg-white/20 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>

          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <!-- Loading State -->
            <div id="aiLoadingState" class="text-center py-12">
              <div class="mx-auto w-16 h-16 rounded-2xl bg-white/5 border border-white/10 grid place-items-center mb-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FFF27A]"></div>
              </div>
              <div class="text-lg font-semibold text-white">Analyzing Market Data...</div>
              <div class="text-sm text-white/60 mt-1">Generating AI insights and recommendations</div>
            </div>

            <!-- AI Summary Content -->
            <div id="aiSummaryContent" class="hidden space-y-6">
              <!-- Market Summary -->
              <div class="card p-6">
                <h4 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h18"/>
                    <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                  </svg>
                  Market Summary
                </h4>
                <div id="marketSummary" class="text-white/80 leading-relaxed"></div>
              </div>

              <!-- Investment Recommendations -->
              <div class="card p-6">
                <h4 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                  Investment Recommendations
                </h4>
                <div id="investmentRecommendations" class="text-white/80 leading-relaxed"></div>
              </div>

              <!-- Investment Strategy -->
              <div class="card p-6">
                <h4 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                  </svg>
                  Investment Strategy
                </h4>
                <div id="investmentStrategy" class="text-white/80 leading-relaxed"></div>
              </div>
            </div>

            <!-- Error State -->
            <div id="aiErrorState" class="hidden text-center py-12">
              <div class="mx-auto w-16 h-16 rounded-2xl bg-red-500/10 border border-red-500/20 grid place-items-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              </div>
              <div class="text-lg font-semibold text-white">Analysis Failed</div>
              <div class="text-sm text-white/60 mt-1">Unable to generate AI insights. Please try again.</div>
              <button id="retryAiAnalysis" class="mt-4 px-4 py-2 bg-[#FFF27A] text-[#1E1E21] rounded-lg font-medium hover:bg-[#FFF27A]/90 transition-colors">
                Retry Analysis
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/cache-util.js"></script>
    <script>
      const FMP_API_KEY = 'WwNxldd0G8oDcMy1V0FPNIirF74a1p4E';
      let charts = {};
      let marketData = {};

      // Commodity symbols
      const commodities = [
        { symbol: "GCUSD", name: "Gold", icon: "ü•á" },
        { symbol: "SIUSD", name: "Silver", icon: "ü•à" },
        { symbol: "BZUSD", name: "Brent Crude", icon: "üõ¢Ô∏è" }
      ];

      // Authentication check
      function checkAuth() {
        fetch('/api/auth/me').then(r => r.json()).then(d => {
          if (!d.user) {
            window.location.href = '/auth.html';
          } else {
            const userEmailText = document.getElementById('userEmailText');
            if (userEmailText) {
              userEmailText.textContent = d.user.email;
            }
          }
        }).catch(() => window.location.href = '/auth.html');
      }

      // Format number
      function formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
        return num.toFixed(2);
      }

      // Fetch all market data
      async function fetchMarketData() {
        try {
          document.getElementById('loadingState').classList.remove('hidden');
          document.getElementById('mainContent').classList.add('hidden');

          // Fetch all data in parallel
          const [
            gainers,
            losers,
            treasury,
            gdp,
            gdpPerCapita,
            unemployment,
            recession,
            sectorPerf,
            industryPerf,
            sectorPE,
            ...commoditiesData
          ] = await Promise.allSettled([
            cachedFetch(`https://financialmodelingprep.com/stable/biggest-gainers?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/biggest-losers?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/treasury-rates?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=GDP&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=realGDPPerCapita&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=unemploymentRate&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=smoothedUSRecessionProbabilities&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-sector-performance?sector=Energy&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-industry-performance?industry=Biotechnology&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-sector-pe?sector=Energy&apikey=${FMP_API_KEY}`).then(r => r.json()),
            ...commodities.slice(0, 20).map(c => 
              cachedFetch(`https://financialmodelingprep.com/stable/quote?symbol=${c.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json())
            )
          ]);

          // Update charts with fetched data
          updateGainersLosers(
            gainers.status === 'fulfilled' ? gainers.value : [],
            losers.status === 'fulfilled' ? losers.value : []
          );
          
          updateTreasuryRates(treasury.status === 'fulfilled' ? treasury.value : []);
          updateEconomicIndicators({
            gdp: gdp.status === 'fulfilled' ? gdp.value : [],
            gdpPerCapita: gdpPerCapita.status === 'fulfilled' ? gdpPerCapita.value : [],
            unemployment: unemployment.status === 'fulfilled' ? unemployment.value : [],
            recession: recession.status === 'fulfilled' ? recession.value : []
          });
          
          updateSectorIndustry(
            sectorPerf.status === 'fulfilled' ? sectorPerf.value : [],
            industryPerf.status === 'fulfilled' ? industryPerf.value : [],
            sectorPE.status === 'fulfilled' ? sectorPE.value : []
          );
          
          updateCommodities(commoditiesData);

          // Store market data for AI analysis
          marketData = {
            gainers: gainers.status === 'fulfilled' ? gainers.value : [],
            losers: losers.status === 'fulfilled' ? losers.value : [],
            treasury: treasury.status === 'fulfilled' ? treasury.value : [],
            gdp: gdp.status === 'fulfilled' ? gdp.value : [],
            gdpPerCapita: gdpPerCapita.status === 'fulfilled' ? gdpPerCapita.value : [],
            unemployment: unemployment.status === 'fulfilled' ? unemployment.value : [],
            recession: recession.status === 'fulfilled' ? recession.value : [],
            sectorPerf: sectorPerf.status === 'fulfilled' ? sectorPerf.value : [],
            industryPerf: industryPerf.status === 'fulfilled' ? industryPerf.value : [],
            sectorPE: sectorPE.status === 'fulfilled' ? sectorPE.value : [],
            commodities: commoditiesData.filter(r => r.status === 'fulfilled' && r.value && r.value[0]).map(r => r.value[0])
          };

          document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleString()}`;
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');

        } catch (error) {
          console.error('Error fetching market data:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error Loading Data',
            text: 'Failed to fetch market data. Please try again.',
            background: '#2C2F34',
            color: '#fff'
          });
        }
      }

      // Update Gainers & Losers Charts
      function updateGainersLosers(gainers, losers) {
        const topGainers = gainers.slice(0, 10);
        const topLosers = losers.slice(0, 10);

        // Destroy existing charts
        if (charts.gainers) charts.gainers.destroy();
        if (charts.losers) charts.losers.destroy();

        // Gainers Chart
        const gainersCtx = document.getElementById('gainersChart').getContext('2d');
        charts.gainers = new Chart(gainersCtx, {
          type: 'bar',
          data: {
            labels: topGainers.map(g => g.symbol),
            datasets: [{
              label: 'Change %',
              data: topGainers.map(g => g.changesPercentage),
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const item = topGainers[context.dataIndex];
                    return `${item.name}: +${item.changesPercentage.toFixed(2)}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });

        // Losers Chart
        const losersCtx = document.getElementById('losersChart').getContext('2d');
        charts.losers = new Chart(losersCtx, {
          type: 'bar',
          data: {
            labels: topLosers.map(l => l.symbol),
            datasets: [{
              label: 'Change %',
              data: topLosers.map(l => l.changesPercentage),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderColor: 'rgba(239, 68, 68, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const item = topLosers[context.dataIndex];
                    return `${item.name}: ${item.changesPercentage.toFixed(2)}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // Update Treasury Rates Chart
      function updateTreasuryRates(data) {
        if (!data || data.length === 0) return;

        const latest = data[0];
        if (charts.treasury) charts.treasury.destroy();

        const ctx = document.getElementById('treasuryChart').getContext('2d');
        charts.treasury = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['1M', '2M', '3M', '6M', '1Y', '2Y', '3Y', '5Y', '7Y', '10Y', '20Y', '30Y'],
            datasets: [{
              label: 'Yield %',
              data: [
                latest.month1, latest.month2, latest.month3, latest.month6,
                latest.year1, latest.year2, latest.year3, latest.year5,
                latest.year7, latest.year10, latest.year20, latest.year30
              ],
              borderColor: '#FFF27A',
              backgroundColor: 'rgba(255, 242, 122, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // Update Economic Indicators
      function updateEconomicIndicators(indicators) {
        // GDP Chart
        if (indicators.gdp && indicators.gdp.length > 0) {
          const gdpData = indicators.gdp.slice(0, 20).reverse();
          if (charts.gdp) charts.gdp.destroy();
          
          const ctx = document.getElementById('gdpChart').getContext('2d');
          charts.gdp = new Chart(ctx, {
            type: 'line',
            data: {
              labels: gdpData.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'GDP (Billions)',
                data: gdpData.map(d => d.value),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // GDP Per Capita Chart
        if (indicators.gdpPerCapita && indicators.gdpPerCapita.length > 0) {
          const data = indicators.gdpPerCapita.slice(0, 20).reverse();
          if (charts.gdpPerCapita) charts.gdpPerCapita.destroy();
          
          const ctx = document.getElementById('gdpPerCapitaChart').getContext('2d');
          charts.gdpPerCapita = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'GDP Per Capita',
                data: data.map(d => d.value),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }


        // Unemployment Chart
        if (indicators.unemployment && indicators.unemployment.length > 0) {
          const data = indicators.unemployment.slice(0, 20).reverse();
          if (charts.unemployment) charts.unemployment.destroy();
          
          const ctx = document.getElementById('unemploymentChart').getContext('2d');
          charts.unemployment = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'Unemployment %',
                data: data.map(d => d.value),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Recession Probabilities Chart
        if (indicators.recession && indicators.recession.length > 0) {
          const data = indicators.recession.slice(0, 20).reverse();
          if (charts.recession) charts.recession.destroy();
          
          const ctx = document.getElementById('recessionChart').getContext('2d');
          charts.recession = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'Recession Probability %',
                data: data.map(d => d.value),
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Update Sector & Industry Charts
      function updateSectorIndustry(sectorData, industryData, sectorPEData) {
        // Sector Performance
        if (sectorData && sectorData.length > 0) {
          const data = sectorData.slice(0, 30).reverse();
          if (charts.sector) charts.sector.destroy();
          
          const ctx = document.getElementById('sectorChart').getContext('2d');
          charts.sector = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'Average Change %',
                data: data.map(d => d.averageChange),
                borderColor: '#FFF27A',
                backgroundColor: 'rgba(255, 242, 122, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Industry Performance
        if (industryData && industryData.length > 0) {
          const data = industryData.slice(0, 30).reverse();
          if (charts.industry) charts.industry.destroy();
          
          const ctx = document.getElementById('industryChart').getContext('2d');
          charts.industry = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'Average Change %',
                data: data.map(d => d.averageChange),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Sector P/E Ratio
        if (sectorPEData && sectorPEData.length > 0) {
          const data = sectorPEData.slice(0, 30).reverse();
          if (charts.sectorPE) charts.sectorPE.destroy();
          
          const ctx = document.getElementById('sectorPEChart').getContext('2d');
          charts.sectorPE = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'P/E Ratio',
                data: data.map(d => d.pe),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Update Commodities Grid
      function updateCommodities(commoditiesData) {
        const grid = document.getElementById('commoditiesGrid');
        grid.innerHTML = '';

        commoditiesData.forEach((result, index) => {
          if (result.status !== 'fulfilled' || !result.value || !result.value[0]) return;

          const data = result.value[0];
          const commodity = commodities[index];
          const isPositive = data.changePercentage >= 0;
          const color = isPositive ? 'text-green-400' : 'text-red-400';
          const bgColor = isPositive ? 'bg-green-500/10' : 'bg-red-500/10';

          const card = document.createElement('div');
          card.className = `p-4 rounded-lg border border-white/10 ${bgColor}`;
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-2xl">${commodity.icon}</span>
              <span class="${color} text-xs font-semibold">${isPositive ? '+' : ''}${data.changePercentage.toFixed(2)}%</span>
            </div>
            <div class="text-white font-medium text-sm mb-1">${commodity.name}</div>
            <div class="text-white/80 text-xs">${data.symbol}</div>
            <div class="text-white font-bold mt-2">$${data.price.toFixed(2)}</div>
            <div class="${color} text-xs">${isPositive ? '+' : ''}${data.change.toFixed(2)}</div>
          `;
          grid.appendChild(card);
        });
      }

      // Collect comprehensive market data for AI analysis
      function collectMarketDataForAI() {
        const data = {
          timestamp: new Date().toISOString(),
          marketOverview: {
            topGainers: marketData.gainers?.slice(0, 10).map(g => ({
              symbol: g.symbol,
              name: g.name,
              change: g.changesPercentage,
              price: g.price
            })) || [],
            topLosers: marketData.losers?.slice(0, 10).map(l => ({
              symbol: l.symbol,
              name: l.name,
              change: l.changesPercentage,
              price: l.price
            })) || [],
            commodities: marketData.commodities?.map(c => ({
              symbol: c.symbol,
              name: c.name,
              price: c.price,
              change: c.changePercentage
            })) || []
          },
          economicIndicators: {
            gdp: marketData.gdp?.slice(0, 5).map(d => ({
              date: d.date,
              value: d.value
            })) || [],
            gdpPerCapita: marketData.gdpPerCapita?.slice(0, 5).map(d => ({
              date: d.date,
              value: d.value
            })) || [],
            unemployment: marketData.unemployment?.slice(0, 5).map(d => ({
              date: d.date,
              value: d.value
            })) || [],
            recessionProbability: marketData.recession?.slice(0, 5).map(d => ({
              date: d.date,
              value: d.value
            })) || []
          },
          treasuryRates: marketData.treasury?.[0] ? {
            month1: marketData.treasury[0].month1,
            month3: marketData.treasury[0].month3,
            month6: marketData.treasury[0].month6,
            year1: marketData.treasury[0].year1,
            year2: marketData.treasury[0].year2,
            year5: marketData.treasury[0].year5,
            year10: marketData.treasury[0].year10,
            year30: marketData.treasury[0].year30
          } : null,
          sectorPerformance: {
            energy: marketData.sectorPerf?.slice(0, 10).map(d => ({
              date: d.date,
              averageChange: d.averageChange
            })) || [],
            biotechnology: marketData.industryPerf?.slice(0, 10).map(d => ({
              date: d.date,
              averageChange: d.averageChange
            })) || [],
            energyPE: marketData.sectorPE?.slice(0, 10).map(d => ({
              date: d.date,
              pe: d.pe
            })) || []
          }
        };
        return data;
      }

      // Generate AI analysis
      async function generateAIAnalysis() {
        try {
          const marketDataForAI = collectMarketDataForAI();
          
          // Show loading state
          document.getElementById('aiLoadingState').classList.remove('hidden');
          document.getElementById('aiSummaryContent').classList.add('hidden');
          document.getElementById('aiErrorState').classList.add('hidden');

          // Simulate AI analysis (replace with actual AI API call)
          await new Promise(resolve => setTimeout(resolve, 2000));

          // Generate comprehensive analysis
          const analysis = generateComprehensiveAnalysis(marketDataForAI);

          // Display results
          document.getElementById('marketSummary').innerHTML = analysis.summary;
          document.getElementById('investmentRecommendations').innerHTML = analysis.recommendations;
          document.getElementById('investmentStrategy').innerHTML = analysis.strategy;

          document.getElementById('aiLoadingState').classList.add('hidden');
          document.getElementById('aiSummaryContent').classList.remove('hidden');

        } catch (error) {
          console.error('Error generating AI analysis:', error);
          document.getElementById('aiLoadingState').classList.add('hidden');
          document.getElementById('aiErrorState').classList.remove('hidden');
        }
      }

      // Generate comprehensive market analysis
      function generateComprehensiveAnalysis(data) {
        const gainers = data.marketOverview.topGainers;
        const losers = data.marketOverview.topLosers;
        const commodities = data.marketOverview.commodities;
        const gdp = data.economicIndicators.gdp;
        const unemployment = data.economicIndicators.unemployment;
        const recession = data.economicIndicators.recessionProbability;
        const treasury = data.treasuryRates;

        // Calculate market sentiment
        const avgGainerChange = gainers.reduce((sum, g) => sum + g.change, 0) / gainers.length;
        const avgLoserChange = losers.reduce((sum, l) => sum + l.change, 0) / losers.length;
        const marketSentiment = avgGainerChange > Math.abs(avgLoserChange) ? 'bullish' : 'bearish';

        // Generate summary
        const summary = `
          <div class="space-y-4">
            <p><strong>Market Sentiment:</strong> <span class="text-${marketSentiment === 'bullish' ? 'green' : 'red'}-400 font-semibold">${marketSentiment.toUpperCase()}</span></p>
            
            <p><strong>Top Performers:</strong> ${gainers.slice(0, 3).map(g => `${g.symbol} (+${g.change.toFixed(2)}%)`).join(', ')}</p>
            
            <p><strong>Commodities Status:</strong> ${commodities.map(c => `${c.symbol}: $${c.price.toFixed(2)} (${c.change >= 0 ? '+' : ''}${c.change.toFixed(2)}%)`).join(', ')}</p>
            
            ${gdp.length > 0 ? `<p><strong>GDP Trend:</strong> Latest GDP at $${gdp[0].value.toFixed(1)}B (${gdp.length > 1 ? (gdp[0].value > gdp[1].value ? 'increasing' : 'decreasing') : 'current data'})</p>` : ''}
            
            ${unemployment.length > 0 ? `<p><strong>Unemployment Rate:</strong> ${unemployment[0].value.toFixed(2)}% (${unemployment.length > 1 ? (unemployment[0].value < unemployment[1].value ? 'improving' : 'worsening') : 'current data'})</p>` : ''}
            
            ${recession.length > 0 ? `<p><strong>Recession Probability:</strong> ${recession[0].value.toFixed(1)}% (${recession[0].value > 30 ? 'high risk' : recession[0].value > 15 ? 'moderate risk' : 'low risk'})</p>` : ''}
            
            ${treasury ? `<p><strong>Yield Curve:</strong> 10Y at ${treasury.year10.toFixed(2)}%, 2Y at ${treasury.year2.toFixed(2)}% (${treasury.year10 > treasury.year2 ? 'normal' : 'inverted'})</p>` : ''}
          </div>
        `;

        // Generate recommendations
        const recommendations = `
          <div class="space-y-4">
            <div class="p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
              <h5 class="font-semibold text-blue-400 mb-2">Sector Opportunities</h5>
              <p>Based on current market data, consider focusing on sectors showing resilience and growth potential.</p>
            </div>
            
            <div class="p-4 bg-green-500/10 border border-green-500/20 rounded-lg">
              <h5 class="font-semibold text-green-400 mb-2">Commodity Strategy</h5>
              <p>${commodities.map(c => `${c.symbol} is ${c.change >= 0 ? 'performing well' : 'under pressure'} at $${c.price.toFixed(2)}`).join('. ')}. Consider ${commodities.some(c => c.change >= 0) ? 'diversifying' : 'cautious'} commodity exposure.</p>
            </div>
            
            <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
              <h5 class="font-semibold text-yellow-400 mb-2">Risk Management</h5>
              <p>${recession.length > 0 && recession[0].value > 20 ? 'High recession probability suggests defensive positioning.' : 'Moderate risk environment allows for balanced growth and value strategies.'}</p>
            </div>
          </div>
        `;

        // Generate strategy
        const strategy = `
          <div class="space-y-4">
            <div class="p-4 bg-purple-500/10 border border-purple-500/20 rounded-lg">
              <h5 class="font-semibold text-purple-400 mb-2">Portfolio Allocation</h5>
              <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Equities (${marketSentiment === 'bullish' ? '60-70%' : '40-50%'}):</strong> Focus on ${marketSentiment === 'bullish' ? 'growth and momentum' : 'value and defensive'} stocks</li>
                <li><strong>Bonds (${marketSentiment === 'bullish' ? '20-30%' : '30-40%'}):</strong> ${treasury ? `Consider ${treasury.year10 > treasury.year2 ? 'longer-term' : 'shorter-term'} treasuries` : 'Diversified bond allocation'}</li>
                <li><strong>Commodities (10-15%):</strong> ${commodities.some(c => c.change >= 0) ? 'Selective exposure' : 'Minimal exposure'} based on current trends</li>
                <li><strong>Cash (5-10%):</strong> Maintain liquidity for opportunities</li>
              </ul>
            </div>
            
            <div class="p-4 bg-orange-500/10 border border-orange-500/20 rounded-lg">
              <h5 class="font-semibold text-orange-400 mb-2">Investment Timeline</h5>
              <ul class="list-disc list-inside space-y-1 text-sm">
                <li><strong>Short-term (1-3 months):</strong> Monitor ${gainers.slice(0, 2).map(g => g.symbol).join(' and ')} for momentum opportunities</li>
                <li><strong>Medium-term (3-12 months):</strong> ${unemployment.length > 0 && unemployment[0].value < 5 ? 'Favorable employment conditions support consumer spending' : 'Monitor employment trends for economic health'}</li>
                <li><strong>Long-term (1+ years):</strong> ${gdp.length > 0 ? 'GDP growth trajectory suggests' : 'Economic indicators suggest'} ${marketSentiment === 'bullish' ? 'continued expansion' : 'potential consolidation'}</li>
              </ul>
            </div>
            
            <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
              <h5 class="font-semibold text-red-400 mb-2">Risk Considerations</h5>
              <ul class="list-disc list-inside space-y-1 text-sm">
                <li>${recession.length > 0 && recession[0].value > 30 ? 'High recession probability - consider defensive positioning' : 'Moderate economic risk - balanced approach recommended'}</li>
                <li>${treasury && treasury.year10 < treasury.year2 ? 'Inverted yield curve signals potential economic headwinds' : 'Normal yield curve supports economic growth'}</li>
                <li>Monitor commodity price volatility for inflation impact</li>
                <li>Diversify across sectors to reduce concentration risk</li>
              </ul>
            </div>
          </div>
        `;

        return { summary, recommendations, strategy };
      }

      // Initialize
      async function init() {
        await fetchMarketData();

        // Set up refresh button
        document.getElementById('refreshBtn').addEventListener('click', fetchMarketData);
        
        // Set up AI summary button
        document.getElementById('aiSummaryBtn').addEventListener('click', () => {
          document.getElementById('aiSummaryModal').classList.remove('hidden');
          generateAIAnalysis();
        });

        // Set up modal close buttons
        document.getElementById('closeAiSummaryModal').addEventListener('click', () => {
          document.getElementById('aiSummaryModal').classList.add('hidden');
        });

        document.getElementById('retryAiAnalysis').addEventListener('click', () => {
          generateAIAnalysis();
        });

        // Close modal when clicking outside
        document.getElementById('aiSummaryModal').addEventListener('click', (e) => {
          if (e.target === document.getElementById('aiSummaryModal')) {
            document.getElementById('aiSummaryModal').classList.add('hidden');
          }
        });
      }

      // Start
      checkAuth();
      init();
    </script>
    
    <!-- Mobile Navigation Menu -->
    <div id="mobileMenu" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden md:hidden">
      <div class="bg-[#2C2F34] border border-white/10 rounded-[18px] m-4 p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">Navigation</h3>
          <button id="closeMobileMenu" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <nav id="mobileNavLinks" class="flex flex-col gap-2 text-white/80"></nav>

        <div class="border-t border-white/10 my-2"></div>
        <button id="mobileSignoutBtn" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white/80">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          <span>Sign out</span>
        </button>
      </div>
    </div>

    <!-- Mobile Menu JavaScript -->
    <script>
      // Mobile menu functionality
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      const closeMobileMenu = document.getElementById('closeMobileMenu');
      const mobileSignoutBtn = document.getElementById('mobileSignoutBtn');

      if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          mobileMenu.classList.remove('hidden');
        });
      }

      if (closeMobileMenu && mobileMenu) {
        closeMobileMenu.addEventListener('click', () => {
          mobileMenu.classList.add('hidden');
        });
      }

      if (mobileSignoutBtn) {
        mobileSignoutBtn.addEventListener('click', async () => {
          try { await fetch('/api/auth/logout',{method:'POST'}); } catch(e) {}
          window.location.href='/auth.html';
        });
      }

      // Close mobile menu when clicking outside
      if (mobileMenu) {
        mobileMenu.addEventListener('click', (e) => {
          if (e.target === mobileMenu) {
            mobileMenu.classList.add('hidden');
          }
        });
      }
    </script>
    
    <script src="/static/navbar.js"></script>
  </body>
</html>

