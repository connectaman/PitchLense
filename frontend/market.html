<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitchLense ‚Äî Market Performance</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <script>
      tailwind.config = { theme: { extend: { colors: { background:'#1E1E21', surface:'#2E3137', text:'#ffffff', secondary:'#cfd4dd', accent:'#f1d85b' }}}}
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body class="bg-background text-text font-sans antialiased overflow-x-hidden bg-solid">
    <div class="h-screen flex flex-col p-3 gap-3">
      <header class="h-16 bg-[#2E3137] border border-white/10 rounded-[22px] flex items-center justify-between px-6 mobile-header">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-accent grid place-items-center"><img src="/static/logo.svg" class="w-5 h-5"/></div>
          <div class="text-base font-semibold">PitchLense</div>
        </div>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" title="Refresh Market Data" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10"/>
              <polyline points="1 20 1 14 7 14"/>
              <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/>
              <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"/>
            </svg>
          </button>
          <div id="userProfileIcon" class="w-9 h-9 rounded-full border border-white/10 bg-[#FFF27A] grid place-items-center text-[#1E1E21] relative group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
            </svg>
            <div id="userEmailTooltip" class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              <span id="userEmailText">Loading...</span>
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-[#1E1E21]"></div>
            </div>
          </div>
        </div>
      </header>

      <div class="grid flex-1 min-h-0 mobile-navbar" style="grid-template-columns: 84px 1fr; gap:12px;">
        <aside id="pitchlense-navbar" class="bg-[#2C2F34] border border-white/10 rounded-[18px] flex flex-col items-center py-4 gap-3">
          <!-- Navbar content will be rendered by navbar.js -->
        </aside>

        <main class="flex-1 overflow-y-auto p-4 mobile-main">
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-accent">
                  <path d="M3 3v18h18"/>
                  <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                </svg>
                Market Performance
              </h2>
              <p class="text-white/60 mt-1" id="lastUpdate">Last updated: Loading...</p>
            </div>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="min-h-[60vh] grid place-items-center">
            <div class="text-center">
              <div class="mx-auto w-20 h-20 rounded-2xl bg-white/5 border border-white/10 grid place-items-center mb-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#FFF27A]"></div>
              </div>
              <div class="text-lg font-semibold text-white">Loading Market Data...</div>
              <div class="text-sm text-white/60 mt-1">Fetching latest market information</div>
            </div>
          </div>

          <!-- Main Content -->
          <div id="mainContent" class="hidden">
            <!-- Commodities Overview - KPI Section -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üõ¢Ô∏è Commodities Overview</h3>
              <div id="commoditiesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- Commodities will be populated here -->
              </div>
            </div>

            <!-- Top Gainers & Losers -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <span class="text-green-400">‚ñ≤</span> Top 10 Gainers
                </h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="gainersChart"></canvas>
                </div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                  <span class="text-red-400">‚ñº</span> Top 10 Losers
                </h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="losersChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Treasury Rates -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìä US Treasury Rates</h3>
              <div class="relative overflow-hidden" style="height: 350px;">
                <canvas id="treasuryChart"></canvas>
              </div>
            </div>

            <!-- Economic Indicators -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìà Economic Indicators</h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">GDP</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="gdpChart"></canvas>
                  </div>
                </div>
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">Real GDP Per Capita</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="gdpPerCapitaChart"></canvas>
                  </div>
                </div>
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">Inflation Rate</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="inflationChart"></canvas>
                  </div>
                </div>
                <div class="card p-6">
                  <h4 class="text-md font-medium text-white mb-3">Unemployment Rate</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="unemploymentChart"></canvas>
                  </div>
                </div>
                <div class="card p-6 lg:col-span-2">
                  <h4 class="text-md font-medium text-white mb-3">US Recession Probabilities</h4>
                  <div class="relative overflow-hidden" style="height: 250px;">
                    <canvas id="recessionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sector & Industry Performance -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">üè≠ Sector Performance (Energy)</h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="sectorChart"></canvas>
                </div>
              </div>
              <div class="card p-6">
                <h3 class="text-lg font-semibold text-white mb-4">üß¨ Industry Performance (Biotechnology)</h3>
                <div class="relative overflow-hidden" style="height: 300px;">
                  <canvas id="industryChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Sector PE Ratio -->
            <div class="card p-6 mb-6">
              <h3 class="text-lg font-semibold text-white mb-4">üìä Historical Sector P/E Ratio (Energy)</h3>
              <div class="relative overflow-hidden" style="height: 300px;">
                <canvas id="sectorPEChart"></canvas>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="/static/cache-util.js"></script>
    <script>
      const FMP_API_KEY = 'WwNxldd0G8oDcMy1V0FPNIirF74a1p4E';
      let charts = {};

      // Commodity symbols
      const commodities = [
        { symbol: "GCUSD", name: "Gold", icon: "ü•á" },
        { symbol: "SIUSD", name: "Silver", icon: "ü•à" },
        { symbol: "CLUSD", name: "Crude Oil", icon: "üõ¢Ô∏è" },
        { symbol: "NGUSD", name: "Natural Gas", icon: "‚ö°" },
        { symbol: "HGUSD", name: "Copper", icon: "üî©" },
        { symbol: "ZCUSX", name: "Corn", icon: "üåΩ" },
        { symbol: "ZSUSX", name: "Soybean", icon: "üå±" },
        { symbol: "KEUSX", name: "Wheat", icon: "üåæ" },
        { symbol: "KCUSX", name: "Coffee", icon: "‚òï" },
        { symbol: "SBUSX", name: "Sugar", icon: "üç¨" },
        { symbol: "CCUSD", name: "Cocoa", icon: "üç´" },
        { symbol: "CTUSX", name: "Cotton", icon: "üßµ" },
        { symbol: "OJUSX", name: "Orange Juice", icon: "üçä" },
        { symbol: "PLUSD", name: "Platinum", icon: "üíç" },
        { symbol: "PAUSD", name: "Palladium", icon: "üíé" },
        { symbol: "LEUSX", name: "Live Cattle", icon: "üêÑ" },
        { symbol: "HEUSX", name: "Lean Hogs", icon: "üêñ" },
        { symbol: "LBUSD", name: "Lumber", icon: "ü™µ" },
        { symbol: "BZUSD", name: "Brent Crude", icon: "üõ¢Ô∏è" },
        { symbol: "RBUSD", name: "Gasoline", icon: "‚õΩ" }
      ];

      // Authentication check
      function checkAuth() {
        fetch('/api/auth/me').then(r => r.json()).then(d => {
          if (!d.user) {
            window.location.href = '/auth.html';
          } else {
            const userEmailText = document.getElementById('userEmailText');
            if (userEmailText) {
              userEmailText.textContent = d.user.email;
            }
          }
        }).catch(() => window.location.href = '/auth.html');
      }

      // Format number
      function formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
        return num.toFixed(2);
      }

      // Fetch all market data
      async function fetchMarketData() {
        try {
          document.getElementById('loadingState').classList.remove('hidden');
          document.getElementById('mainContent').classList.add('hidden');

          // Fetch all data in parallel
          const [
            gainers,
            losers,
            treasury,
            gdp,
            gdpPerCapita,
            inflation,
            unemployment,
            recession,
            sectorPerf,
            industryPerf,
            sectorPE,
            ...commoditiesData
          ] = await Promise.allSettled([
            cachedFetch(`https://financialmodelingprep.com/stable/biggest-gainers?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/biggest-losers?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/treasury-rates?apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=GDP&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=realGDPPerCapita&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=inflation&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=unemploymentRate&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/economic-indicators?name=smoothedUSRecessionProbabilities&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-sector-performance?sector=Energy&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-industry-performance?industry=Biotechnology&apikey=${FMP_API_KEY}`).then(r => r.json()),
            cachedFetch(`https://financialmodelingprep.com/stable/historical-sector-pe?sector=Energy&apikey=${FMP_API_KEY}`).then(r => r.json()),
            ...commodities.slice(0, 20).map(c => 
              cachedFetch(`https://financialmodelingprep.com/stable/quote?symbol=${c.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json())
            )
          ]);

          // Update charts with fetched data
          updateGainersLosers(
            gainers.status === 'fulfilled' ? gainers.value : [],
            losers.status === 'fulfilled' ? losers.value : []
          );
          
          updateTreasuryRates(treasury.status === 'fulfilled' ? treasury.value : []);
          updateEconomicIndicators({
            gdp: gdp.status === 'fulfilled' ? gdp.value : [],
            gdpPerCapita: gdpPerCapita.status === 'fulfilled' ? gdpPerCapita.value : [],
            inflation: inflation.status === 'fulfilled' ? inflation.value : [],
            unemployment: unemployment.status === 'fulfilled' ? unemployment.value : [],
            recession: recession.status === 'fulfilled' ? recession.value : []
          });
          
          updateSectorIndustry(
            sectorPerf.status === 'fulfilled' ? sectorPerf.value : [],
            industryPerf.status === 'fulfilled' ? industryPerf.value : [],
            sectorPE.status === 'fulfilled' ? sectorPE.value : []
          );
          
          updateCommodities(commoditiesData);

          document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleString()}`;
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');

        } catch (error) {
          console.error('Error fetching market data:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error Loading Data',
            text: 'Failed to fetch market data. Please try again.',
            background: '#2C2F34',
            color: '#fff'
          });
        }
      }

      // Update Gainers & Losers Charts
      function updateGainersLosers(gainers, losers) {
        const topGainers = gainers.slice(0, 10);
        const topLosers = losers.slice(0, 10);

        // Destroy existing charts
        if (charts.gainers) charts.gainers.destroy();
        if (charts.losers) charts.losers.destroy();

        // Gainers Chart
        const gainersCtx = document.getElementById('gainersChart').getContext('2d');
        charts.gainers = new Chart(gainersCtx, {
          type: 'bar',
          data: {
            labels: topGainers.map(g => g.symbol),
            datasets: [{
              label: 'Change %',
              data: topGainers.map(g => g.changesPercentage),
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const item = topGainers[context.dataIndex];
                    return `${item.name}: +${item.changesPercentage.toFixed(2)}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });

        // Losers Chart
        const losersCtx = document.getElementById('losersChart').getContext('2d');
        charts.losers = new Chart(losersCtx, {
          type: 'bar',
          data: {
            labels: topLosers.map(l => l.symbol),
            datasets: [{
              label: 'Change %',
              data: topLosers.map(l => l.changesPercentage),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderColor: 'rgba(239, 68, 68, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const item = topLosers[context.dataIndex];
                    return `${item.name}: ${item.changesPercentage.toFixed(2)}%`;
                  }
                }
              }
            },
            scales: {
              y: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // Update Treasury Rates Chart
      function updateTreasuryRates(data) {
        if (!data || data.length === 0) return;

        const latest = data[0];
        if (charts.treasury) charts.treasury.destroy();

        const ctx = document.getElementById('treasuryChart').getContext('2d');
        charts.treasury = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['1M', '2M', '3M', '6M', '1Y', '2Y', '3Y', '5Y', '7Y', '10Y', '20Y', '30Y'],
            datasets: [{
              label: 'Yield %',
              data: [
                latest.month1, latest.month2, latest.month3, latest.month6,
                latest.year1, latest.year2, latest.year3, latest.year5,
                latest.year7, latest.year10, latest.year20, latest.year30
              ],
              borderColor: '#FFF27A',
              backgroundColor: 'rgba(255, 242, 122, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                grid: { display: false }
              }
            }
          }
        });
      }

      // Update Economic Indicators
      function updateEconomicIndicators(indicators) {
        // GDP Chart
        if (indicators.gdp && indicators.gdp.length > 0) {
          const gdpData = indicators.gdp.slice(0, 20).reverse();
          if (charts.gdp) charts.gdp.destroy();
          
          const ctx = document.getElementById('gdpChart').getContext('2d');
          charts.gdp = new Chart(ctx, {
            type: 'line',
            data: {
              labels: gdpData.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'GDP (Billions)',
                data: gdpData.map(d => d.value),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // GDP Per Capita Chart
        if (indicators.gdpPerCapita && indicators.gdpPerCapita.length > 0) {
          const data = indicators.gdpPerCapita.slice(0, 20).reverse();
          if (charts.gdpPerCapita) charts.gdpPerCapita.destroy();
          
          const ctx = document.getElementById('gdpPerCapitaChart').getContext('2d');
          charts.gdpPerCapita = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'GDP Per Capita',
                data: data.map(d => d.value),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Inflation Chart
        if (indicators.inflation && indicators.inflation.length > 0) {
          const data = indicators.inflation.slice(0, 20).reverse();
          if (charts.inflation) charts.inflation.destroy();
          
          const ctx = document.getElementById('inflationChart').getContext('2d');
          charts.inflation = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'Inflation %',
                data: data.map(d => d.value),
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Unemployment Chart
        if (indicators.unemployment && indicators.unemployment.length > 0) {
          const data = indicators.unemployment.slice(0, 20).reverse();
          if (charts.unemployment) charts.unemployment.destroy();
          
          const ctx = document.getElementById('unemploymentChart').getContext('2d');
          charts.unemployment = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'Unemployment %',
                data: data.map(d => d.value),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Recession Probabilities Chart
        if (indicators.recession && indicators.recession.length > 0) {
          const data = indicators.recession.slice(0, 20).reverse();
          if (charts.recession) charts.recession.destroy();
          
          const ctx = document.getElementById('recessionChart').getContext('2d');
          charts.recession = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })),
              datasets: [{
                label: 'Recession Probability %',
                data: data.map(d => d.value),
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Update Sector & Industry Charts
      function updateSectorIndustry(sectorData, industryData, sectorPEData) {
        // Sector Performance
        if (sectorData && sectorData.length > 0) {
          const data = sectorData.slice(0, 30).reverse();
          if (charts.sector) charts.sector.destroy();
          
          const ctx = document.getElementById('sectorChart').getContext('2d');
          charts.sector = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'Average Change %',
                data: data.map(d => d.averageChange),
                borderColor: '#FFF27A',
                backgroundColor: 'rgba(255, 242, 122, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Industry Performance
        if (industryData && industryData.length > 0) {
          const data = industryData.slice(0, 30).reverse();
          if (charts.industry) charts.industry.destroy();
          
          const ctx = document.getElementById('industryChart').getContext('2d');
          charts.industry = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'Average Change %',
                data: data.map(d => d.averageChange),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }

        // Sector P/E Ratio
        if (sectorPEData && sectorPEData.length > 0) {
          const data = sectorPEData.slice(0, 30).reverse();
          if (charts.sectorPE) charts.sectorPE.destroy();
          
          const ctx = document.getElementById('sectorPEChart').getContext('2d');
          charts.sectorPE = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
              datasets: [{
                label: 'P/E Ratio',
                data: data.map(d => d.pe),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 45, minRotation: 45 },
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Update Commodities Grid
      function updateCommodities(commoditiesData) {
        const grid = document.getElementById('commoditiesGrid');
        grid.innerHTML = '';

        commoditiesData.forEach((result, index) => {
          if (result.status !== 'fulfilled' || !result.value || !result.value[0]) return;

          const data = result.value[0];
          const commodity = commodities[index];
          const isPositive = data.changePercentage >= 0;
          const color = isPositive ? 'text-green-400' : 'text-red-400';
          const bgColor = isPositive ? 'bg-green-500/10' : 'bg-red-500/10';

          const card = document.createElement('div');
          card.className = `p-4 rounded-lg border border-white/10 ${bgColor}`;
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="text-2xl">${commodity.icon}</span>
              <span class="${color} text-xs font-semibold">${isPositive ? '+' : ''}${data.changePercentage.toFixed(2)}%</span>
            </div>
            <div class="text-white font-medium text-sm mb-1">${commodity.name}</div>
            <div class="text-white/80 text-xs">${data.symbol}</div>
            <div class="text-white font-bold mt-2">$${data.price.toFixed(2)}</div>
            <div class="${color} text-xs">${isPositive ? '+' : ''}${data.change.toFixed(2)}</div>
          `;
          grid.appendChild(card);
        });
      }

      // Initialize
      async function init() {
        await fetchMarketData();

        // Set up refresh button
        document.getElementById('refreshBtn').addEventListener('click', fetchMarketData);
      }

      // Start
      checkAuth();
      init();
    </script>
    <script src="/static/navbar.js"></script>
  </body>
</html>

