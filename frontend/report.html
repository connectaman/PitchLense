<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitchLense — Report</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: { colors: { background:'#1E1E21', surface:'#2E3137', text:'#ffffff', secondary:'#cfd4dd', accent:'#f1d85b' }}}}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        color: #f1d85b;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }
      .markdown-content h1 { font-size: 1.25rem; }
      .markdown-content h2 { font-size: 1.125rem; }
      .markdown-content h3 { font-size: 1rem; }
      .markdown-content p {
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }
      .markdown-content ul, .markdown-content ol {
        margin-left: 1rem;
        margin-bottom: 0.75rem;
      }
      .markdown-content li {
        margin-bottom: 0.25rem;
      }
      .markdown-content strong {
        color: #f1d85b;
        font-weight: 600;
      }
      .markdown-content code {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
      }
      .markdown-content pre {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
      }
      .markdown-content pre code {
        background: none;
        padding: 0;
      }
      .markdown-content blockquote {
        border-left: 3px solid #f1d85b;
        padding-left: 1rem;
        margin-left: 0;
        margin-bottom: 0.75rem;
        color: #cfd4dd;
      }
      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        background-color: rgba(255, 255, 255, 0.02);
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .markdown-content th, .markdown-content td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .markdown-content th {
        background-color: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: #f1d85b;
      }
      .markdown-content tr:hover {
        background-color: rgba(255, 255, 255, 0.02);
      }
      .markdown-content hr {
        border: none;
        height: 1px;
        background-color: rgba(255, 255, 255, 0.1);
        margin: 1.5rem 0;
      }
      .markdown-content a {
        color: #f1d85b;
        text-decoration: underline;
      }
      
      /* Star Rating Styles */
      .star-rating {
        display: flex;
        gap: 4px;
      }
      
      .star {
        font-size: 24px;
        color: #4a5568;
        cursor: pointer;
        transition: color 0.2s ease;
        user-select: none;
      }
      
      .star:hover,
      .star.active {
        color: #f1d85b;
      }
      
      .star.rated {
        color: #f1d85b;
      }
      
      /* Fix SVG color inheritance issues */
      svg {
        color: inherit;
      }
      
      /* Override SVG colors in specific contexts where they should be dark on yellow backgrounds */
      .bg-accent svg,
      button[class*="bg-accent"] svg,
      .bg-accent\/20 svg {
        color: #1E1E21 !important;
      }
      
      /* Fix specific elements with accent backgrounds */
      .w-10.h-10.rounded-full.bg-accent svg,
      .w-8.h-8.rounded-full.bg-accent svg {
        color: #1E1E21 !important;
      }
      
      /* Keep SVG colors as intended in navigation and other areas */
      nav svg,
      .sidebar svg,
      .navigation svg {
        color: currentColor;
      }
      
      /* Ensure SVGs in yellow buttons are dark */
      button.bg-accent svg,
      a.bg-accent svg {
        color: #1E1E21 !important;
      }
      .markdown-content a:hover {
        color: #f1d85b;
        opacity: 0.8;
      }
      
      /* Ensure send button is visible */
      #sendButton {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* Custom scrollbar for tooltip */
      .knowledge-graph-tooltip ::-webkit-scrollbar {
        width: 6px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-thumb {
        background: #f1d85b;
        border-radius: 3px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-thumb:hover {
        background: #e6c547;
      }
      
      /* File view toggle button styles */
      #fileViewToggle {
        transition: background-color 0.3s ease;
      }
      
      #fileViewToggle.bg-accent {
        background-color: #f1d85b;
      }
      
      #toggleThumb {
        transition: transform 0.3s ease;
      }
      
      .file-viewer {
        display: flex;
        flex-direction: column;
      }
      
      /* SweetAlert Dark Theme */
      .swal-dark-popup {
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      .swal-dark-input {
        background-color: #1E1E21 !important;
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
      }
      
      .swal-dark-input:focus {
        border-color: #FFF27A !important;
        outline: none !important;
      }
      
      .swal-dark-confirm {
        background-color: #FFF27A !important;
        color: #1E1E21 !important;
        font-weight: 600 !important;
      }
      
      .swal-dark-confirm:hover {
        background-color: #f0e068 !important;
      }
      
      .swal-dark-cancel {
        background-color: rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
      }
      
      .swal-dark-cancel:hover {
        background-color: rgba(255, 255, 255, 0.15) !important;
      }
      
      .swal2-input::placeholder {
        color: rgba(255, 255, 255, 0.5) !important;
      }
      
      .swal2-validation-message {
        background-color: #1E1E21 !important;
        color: #ef4444 !important;
        border-color: #ef4444 !important;
      }
      
      /* Edit modal dropdown styling */
      #editRiskLevel {
        color: white !important;
        background-color: rgba(255, 255, 255, 0.05) !important;
      }
      
      #editRiskLevel option {
        background-color: #1E1E21 !important;
        color: white !important;
      }
      
      #editRiskLevel:focus {
        border-color: #FFF27A !important;
        box-shadow: 0 0 0 1px #FFF27A !important;
      }
    </style>

        <style>
          @media (max-width: 768px) {
            .mobile-navbar {
              grid-template-columns: 1fr !important;
              gap: 8px !important;
            }
            #pitchlense-navbar {
              display: none !important;
            }
            .mobile-main {
              padding: 12px !important;
            }
            .mobile-header {
              padding: 12px 16px !important;
            }
            
            /* Sources modal mobile styles */
            #sourcesModal .bg-\[#1E1E21\] {
              margin: 8px !important;
              max-height: calc(100vh - 16px) !important;
            }
            #sourcesModal .p-6 {
              padding: 16px !important;
            }
            #sourcesModal .text-xl {
              font-size: 1.125rem !important;
            }
            #sourcesModal .space-y-4 > div {
              margin-bottom: 12px !important;
            }
            #sourcesModal .p-4 {
              padding: 12px !important;
            }
            #sourcesModal .w-8.h-8 {
              width: 24px !important;
              height: 24px !important;
            }
            #sourcesModal .text-sm {
              font-size: 0.75rem !important;
            }
            #sourcesModal .break-all {
              word-break: break-all !important;
              overflow-wrap: break-word !important;
            }
          }
        </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body class="bg-background text-text font-sans antialiased overflow-hidden bg-solid h-screen">
    <!-- Page Level Loader -->
    <div id="pageLoader" class="fixed inset-0 bg-background flex items-center justify-center z-50">
      <div class="flex flex-col items-center gap-6">
        <div class="relative">
          <!-- Outer ring -->
          <div class="w-16 h-16 border-4 border-accent/20 border-t-accent rounded-full animate-spin"></div>
          <!-- Inner ring -->
          <div class="absolute inset-2 w-12 h-12 border-4 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
          <!-- Center dot -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-2 h-2 bg-accent rounded-full animate-pulse"></div>
          </div>
        </div>
        <div class="text-center">
          <div class="text-lg font-semibold text-white mb-2">Loading Report</div>
          <div class="text-sm text-secondary">Fetching your report data...</div>
        </div>
      </div>
    </div>

    <div id="app" class="h-screen flex flex-col p-3 gap-3 hidden overflow-hidden">
      <header class="h-16 liquid-glass flex items-center justify-between px-6 mobile-header">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full grid place-items-center"><img src="/static/logo.svg" class="w-5 h-5"/></div>
          <div class="text-base font-semibold">PitchLense</div>
        </div>
        <div class="flex items-center gap-3">
          <div id="searchWrap" class="flex items-center gap-2">
            <button id="searchBtn" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21]">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </button>
            <input id="searchInput" type="text" placeholder="Search" class="h-9 w-0 opacity-0 px-0 bg-[#1E1E21] border border-white/10 rounded-full text-sm text-white/80 outline-none transition-all duration-200" />
          </div>
          <div id="userProfileIcon" class="w-9 h-9 rounded-full border border-white/10 bg-[#FFF27A] grid place-items-center text-[#1E1E21] relative group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
            </svg>
            <!-- User email tooltip -->
            <div id="userEmailTooltip" class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              <span id="userEmailText">Loading...</span>
              <!-- Tooltip arrow -->
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-[#1E1E21]"></div>
            </div>
          </div>
        </div>
      </header>
      
      <div class="grid flex-1 min-h-0 overflow-hidden mobile-navbar" style="grid-template-columns: 84px 1fr; gap:12px;">
      <aside id="pitchlense-navbar" class="bg-[#2C2F34] border border-white/10 rounded-[18px] flex flex-col items-center py-4 gap-3 h-full">
        <!-- Navbar content will be rendered by navbar.js -->
      </aside>
      <main class="h-full flex flex-col overflow-hidden mobile-main">
        <!-- Secondary Navigation Bar -->
        <nav class="liquid-glass mx-2 mb-3 flex-shrink-0 mobile-nav">
          <div class="flex items-center px-6 py-3">
            <button id="overallAnalysisTab" class="tab-button active px-4 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="overall">
              Overall Analysis
            </button>
            <button id="detailedAnalysisTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="detailed">
              Detailed Analysis
            </button>
            <button id="qnaTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="qna">
              Co-pilot
            </button>
            <button id="dependencyTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="dependency">
              Ecosight
            </button>
            <button id="uploadedFilesTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="files">
              Uploaded Files
            </button>
            <button id="followUpTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="followup">
              Ask Follow Up
            </button>
            <!-- Share Button with Dropdown -->
            <div class="relative ml-auto">
              <button id="shareButton" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21] hover:bg-accent/80 transition-colors" title="Share">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                  <polyline points="16,6 12,2 8,6"/>
                  <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
              </button>
              
              <!-- Share Dropdown -->
              <div id="shareDropdown" class="absolute right-0 top-full mt-2 w-48 bg-[#2E3137] border border-white/10 rounded-lg shadow-lg opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                <div class="py-2">
                  <button id="downloadPdfBtn" class="w-full px-4 py-3 text-left text-sm text-white hover:bg-white/5 flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <path d="M16 13H8"/>
                      <path d="M16 17H8"/>
                      <path d="M10 9H8"/>
                    </svg>
                    Download (PDF)
                  </button>
                  <button id="downloadPptxBtn" class="w-full px-4 py-3 text-left text-sm text-white hover:bg-white/5 flex items-center gap-3 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                      <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    Download (pptx)
                  </button>
                  <button id="shareEmailBtn" class="w-full px-4 py-3 text-left text-sm text-white hover:bg-white/5 flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                      <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Share via Email
                  </button>
                </div>
              </div>
            </div>
            
            <button id="toggleFeedbackForm" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors mr-2 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              Feedback
            </button>
            <button id="documentationTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2 flex items-center gap-2" data-tab="documentation">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Documentation
            </button>
          </div>
        </nav>
        
        <!-- Tab Content Container -->
        <div class="flex-1 min-h-0 overflow-hidden">
          <!-- Overall Analysis Tab (Default) -->
          <div id="overallAnalysisContent" class="tab-content active overall-analysis h-full overflow-y-auto">
            <section class="p-2 grid gap-3 items-start grid-cols-[2fr_1fr] h-full overflow-hidden">
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div class="card p-4 flex flex-col" style="height: 360px;">
                <div class="flex items-center justify-between">
                  <div class="text-sm">Growth Potential</div>
                  <div class="relative">
                    <button class="px-3 py-1 pill bg-[#1E1E21] border border-white/10 text-white/70 text-sm" id="growthPotentialInfo">i</button>
                    <!-- Tooltip -->
                    <div id="growthPotentialTooltip" class="absolute bottom-full right-0 mb-2 w-80 bg-[#2E3137] border border-white/10 rounded-lg p-4 opacity-0 pointer-events-none transition-all duration-200 z-50">
                      <div class="text-xs text-white/80 mb-2 font-semibold">Growth Potential Calculation</div>
                      <div class="space-y-1 text-xs" id="growthPotentialTooltipContent">
                        <!-- Dynamic content will be populated here -->
                      </div>
                    </div>
              </div>
                </div>
                <div class="flex-1 mt-2"><canvas id="growthPotentialChart" style="width:100%;height:100%;display:block"></canvas></div>
                <div class="mt-3 flex items-center justify-center text-xs">
                  <span class="flex items-center gap-2"><i class="inline-block w-2.5 h-2.5 rounded-full" id="growthPotentialLegend" style="background:#FFF27A"></i> Growth Potential: <span id="growthPotentialScore" class="font-semibold">6.4/10</span></span>
                </div>
              </div>
              <div class="card p-0">
                <div class="rounded-xl border border-white/10 relative overflow-hidden" style="height:320px">
                  <canvas id="radarChart" style="width:100%;height:100%;display:block;position:absolute;top:0;left:0;z-index:1"></canvas>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="card p-4 flex flex-col" style="height: 360px;">
                <div class="text-sm mb-3">Startup Analysis</div>
                <div class="flex-1 overflow-y-auto">
                  <ul id="startupAnalysisList" class="divide-y divide-white/10">
                    <!-- Startup analysis items will be populated here -->
                </ul>
                    </div>
              </div>
              <div class="card p-0">
                <div class="rounded-xl border border-white/10 relative overflow-hidden" style="height:320px">
                  <canvas id="marketValueChart" style="width:100%;height:100%;display:block;position:absolute;top:0;left:0;z-index:1;height:100%"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <!-- <div class="card p-4">
              <div class="text-sm mb-3">Your cards</div>
              <div class="rounded-xl p-4" style="background:linear-gradient(135deg,#6b70ff,#b286ff)">
                <div class="text-xs">National WBank</div>
                <div class="mt-6 text-lg tracking-widest">1253 5432 3521 3090</div>
                <div class="mt-2 text-xs">Exp 09/24</div>
              </div>
            </div> -->
            <div class="card p-4" style="height: 320px;">
              <div class="text-sm mb-2">Market Share</div>
              <div id="marketShareContainer" class="h-full overflow-y-auto">
                <!-- Market share data will be populated here -->
                    </div>
                  </div>
            <div class="card p-4 flex flex-col" style="height: 360px;">
              <!-- Tab Navigation -->
              <div class="flex items-center gap-2 mb-4">
                <button id="industryNewsTab" class="tab-button active px-3 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="news">
                  Industry News
                </button>
                <button id="internetDocumentsTab" class="tab-button px-3 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="documents">
                  Internet Documents
                </button>
              </div>
              
              <div class="flex-1 overflow-y-auto">
                <!-- Industry News Content -->
                <div id="industryNewsContent" class="news-tab-content">
                  <!-- Loading State -->
                  <div id="newsLoader" class="flex items-center justify-center py-8">
                    <div class="flex flex-col items-center gap-3">
                      <div class="relative">
                        <div class="w-8 h-8 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 w-8 h-8 border-2 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
                      </div>
                      <div class="text-xs text-secondary">Loading news...</div>
                    </div>
                  </div>
                  <!-- News Content -->
                  <ul id="newsList" class="space-y-3 hidden">
                    <!-- News items will be populated here -->
                  </ul>
                </div>

                <!-- Internet Documents Content -->
                <div id="internetDocumentsContent" class="news-tab-content hidden">
                  <!-- Loading State -->
                  <div id="documentsLoader" class="flex items-center justify-center py-8">
                    <div class="flex flex-col items-center gap-3">
                      <div class="relative">
                        <div class="w-8 h-8 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 w-8 h-8 border-2 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
                      </div>
                      <div class="text-xs text-secondary">Loading documents...</div>
                    </div>
                  </div>
                  <!-- Documents Content -->
                  <ul id="documentsList" class="space-y-3 hidden">
                    <!-- Document items will be populated here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
          </div>
          
          <!-- Detailed Analysis Tab -->
          <div id="detailedAnalysisContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Left Sidebar - Analysis Types (20%) -->
                <div class="w-1/5 h-full">
                  <div class="card p-4 h-full flex flex-col">
                    <h3 class="text-sm font-semibold mb-4 text-white flex-shrink-0">Analysis Types</h3>
                    <div id="analysisTypesList" class="space-y-2 flex-1 overflow-y-auto">
                      <!-- Analysis types will be populated here -->
            </div>
                    </div>
                  </div>
                
                <!-- Right Content Area (80%) -->
                <div class="w-4/5 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div id="detailedAnalysisContentArea" class="flex-1 overflow-y-auto">
                      <!-- Content will be populated here -->
                    </div>
                  </div>
                    </div>
                  </div>
            </section>
          </div>
          
          <!-- Co-pilot Tab -->
          <div id="qnaContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Chatbot Card -->
                <div class="flex-1 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-6">
                      <div class="w-10 h-10 rounded-full bg-accent grid place-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                      </div>
                      <div>
                        <h3 class="text-lg font-semibold text-white">Ask Pitchlense</h3>
                      </div>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-4 pr-2">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                          <img src="/static/logo.svg" alt="PitchLense" class="w-5 h-5" onError="this.style.display='none'; this.nextElementSibling.style.display='block';">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: none;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                          </svg>
                        </div>
                        <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%]">
                          <p class="text-sm text-white">Hello! I'm your AI assistant. I can help you understand your report data, answer questions about the analysis, and provide insights. What would you like to know?</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div class="flex gap-3">
                      <div class="flex-1 relative">
                        <input 
                          id="chatInput" 
                          type="text" 
                          placeholder="Ask a question about your report..." 
                          class="w-full h-12 px-4 pr-12 bg-[#1E1E21] border border-white/10 rounded-lg text-white placeholder:text-white/50 outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
                        />
                        <button 
                          id="sendButton" 
                          class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-accent hover:bg-accent/80 rounded-lg flex items-center justify-center text-white transition-colors z-10 border-2 border-accent"
                          title="Send message"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
          
          <!-- Uploaded Files Tab -->
          <div id="uploadedFilesContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Left Sidebar - File Names (20%) -->
                <div class="w-1/5 h-full">
                  <div class="card p-4 h-full flex flex-col">
                    <h3 class="text-sm font-semibold mb-4 text-white flex-shrink-0">Uploaded Files</h3>
                    <div id="uploadedFilesList" class="space-y-2 flex-1 overflow-y-auto">
                      <!-- File names will be populated here -->
                    </div>
                    </div>
                  </div>
                
                <!-- Right Content Area (80%) -->
                <div class="w-4/5 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                      <h3 class="text-lg font-semibold text-white">File Content</h3>
                      <div class="flex items-center gap-2">
                        <span id="viewModeText" class="text-sm text-white/60">Content View</span>
                        <button id="fileViewToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-gray-800" role="switch">
                          <span id="toggleThumb" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                        </button>
                        <span class="text-sm text-white/60">File View</span>
                      </div>
                    </div>
                    <div id="uploadedFileContentArea" class="flex-1 overflow-y-auto">
                      <!-- File content will be populated here -->
            </div>
              </div>
            </div>
          </div>
        </section>
          </div>

          <!-- Follow Up Questions Tab -->
          <div id="followUpContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Main Content Area -->
                <div class="flex-1 h-full">
                  <div class="card p-4 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold text-white">Follow-Up Questions for Founder</h3>
                      <div class="flex gap-2">
                        <button id="generateFollowUpBtn" class="px-4 py-2 bg-accent text-[#1E1E21] rounded-lg hover:bg-accent/80 transition-colors text-sm font-medium">
                          Generate New Questions
                        </button>
                        <button id="clearQuestionsBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm font-medium hidden">
                          Clear Questions
                        </button>
                        <button id="askFounderBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium hidden">
                          Ask Founder for Follow Up
                        </button>
                      </div>
                    </div>
                    <p class="text-white/70 text-sm mb-6">View existing follow-up queries or generate new questions based on the analysis.</p>
                    
                    <!-- Existing Follow-up Queries -->
                    <div id="existingFollowUpQueries" class="flex-1 overflow-y-auto">
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="followUpQueriesGrid">
                        <!-- Follow-up query cards will be populated here -->
                      </div>
                      
                      <!-- Empty State for existing queries -->
                      <div id="noExistingQueries" class="hidden flex items-center justify-center py-12 text-white/70">
                        <div class="text-center">
                          <div class="text-4xl mb-4">📝</div>
                          <h4 class="text-lg font-medium text-white mb-2">No Follow-up Queries Yet</h4>
                          <p class="text-sm">Generate your first set of follow-up questions to get started.</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="followUpLoading" class="hidden flex items-center justify-center py-8">
                      <div class="flex items-center gap-3">
                        <div class="w-6 h-6 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-white/70">Generating follow-up questions...</span>
                      </div>
                    </div>
                    
                    <!-- Questions Table -->
                    <div id="followUpQuestions" class="hidden flex-1 overflow-y-auto">
                      <div class="bg-[#1E1E21] border border-white/10 rounded-lg overflow-hidden">
                        <table class="w-full">
                          <thead class="bg-[#2E3137] border-b border-white/10">
                            <tr>
                              <th class="px-4 py-3 text-left text-sm font-medium text-white">#</th>
                              <th class="px-4 py-3 text-left text-sm font-medium text-white">Follow-Up Questions</th>
                              <th class="px-4 py-3 text-center text-sm font-medium text-white">Action</th>
                            </tr>
                          </thead>
                          <tbody id="followUpQuestionsBody" class="divide-y divide-white/10">
                            <!-- Questions will be populated here -->
                          </tbody>
                        </table>
                        
                        <!-- Add New Question Button -->
                        <div class="flex justify-center py-4 border-t border-white/10">
                          <button onclick="addNewQuestion()" class="flex items-center gap-2 px-4 py-2 bg-accent text-[#1E1E21] rounded-lg hover:bg-accent/80 transition-colors text-sm font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add New Question
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="followUpError" class="hidden text-center py-8">
                      <div class="text-red-400 mb-4">Failed to generate follow-up questions</div>
                      <button id="retryFollowUp" class="px-4 py-2 bg-accent text-[#1E1E21] rounded-lg hover:bg-accent/80 transition-colors">
                        Try Again
                      </button>
                    </div>

                    <!-- Empty State -->
                    <div id="followUpEmpty" class="flex items-center justify-center py-8 text-white/70">
                      <div class="text-center">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

          <!-- Dependency Tab -->
          <div id="dependencyContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="card p-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">Knowledge Graph</h3>
                  <div class="flex gap-2">
                    <button id="graphInfoBtn" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">What is this Graph?</button>
                    <button id="zoomIn" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Zoom In</button>
                    <button id="zoomOut" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Zoom Out</button>
                    <button id="resetView" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Reset</button>
                  </div>
                </div>
                <div class="flex-1 overflow-hidden relative">
                  <div id="knowledgeGraph" class="w-full h-full bg-[#1E1E21] rounded-lg border border-white/10">
                    <!-- D3.js Knowledge Graph will be rendered here -->
                  </div>
                  
                  <!-- Legend Card -->
                  <div class="absolute top-3 left-3 bg-[#2E3137] border border-white/10 rounded-lg p-3 shadow-lg z-10">
                    <div class="text-xs text-white/60 mb-2 font-semibold">Legend</div>
                    <div class="space-y-2">
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Your startup or company name positioned at the center of the graph, representing the focal point of all business relationships.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #f1d85b;"></div>
                        <span class="text-white/80 text-xs">Company</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Your startup or company name positioned at the center of the graph, representing the focal point of all business relationships.</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #3B82F6;"></div>
                        <span class="text-white/80 text-xs">Dependencies</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate.</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #10B981;"></div>
                        <span class="text-white/80 text-xs">Customers</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services.</div>
                        </div>
                      </div>
                    </div>
                    <!-- Controls legend -->
                    <div class="mt-3 pt-3 border-t border-white/10">
                      <div class="text-xs text-white/60 mb-2 font-semibold">Controls</div>
                      <div class="flex items-center gap-2">
                        <button id="legendZoomIn" class="w-8 h-8 rounded-md bg-[#1E1E21] border border-white/10 grid place-items-center text-white hover:bg-[#3E4147]" title="Zoom In" aria-label="Zoom In">
                          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                          </svg>
                        </button>
                        <button id="legendZoomOut" class="w-8 h-8 rounded-md bg-[#1E1E21] border border-white/10 grid place-items-center text-white hover:bg-[#3E4147]" title="Zoom Out" aria-label="Zoom Out">
                          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                          </svg>
                        </button>
                        <button id="legendReset" class="w-8 h-8 rounded-md bg-[#1E1E21] border border-white/10 grid place-items-center text-white hover:bg-[#3E4147]" title="Reset View" aria-label="Reset View">
                          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 10-8 12"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
      </main>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2E3137] border border-white/10 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-semibold text-white">Report Feedback</h2>
            <button id="closeFeedbackModal" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <p class="text-white/70 text-sm mb-6">Help us improve by sharing your experience with this report. Your feedback is valuable to us!</p>
            
            <!-- Feedback Rating Categories -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <!-- Overall Feedback -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Overall Feedback</label>
                <div class="flex items-center gap-2 star-rating" data-category="overall_feedback">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Risk Indicator Feedback -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Risk Indicator Feedback</label>
                <div class="flex items-center gap-2 star-rating" data-category="risk_indicator_feedback">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Did you get what you were looking for -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Did you get what you were looking for?</label>
                <div class="flex items-center gap-2 star-rating" data-category="got_what_looking_for">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Quality of Content Generation -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Quality of Content Generation</label>
                <div class="flex items-center gap-2 star-rating" data-category="content_quality">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Satisfaction on the Scores -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Satisfaction on the Scores</label>
                <div class="flex items-center gap-2 star-rating" data-category="scores_satisfaction">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Copilot Feedback -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Copilot Feedback</label>
                <div class="flex items-center gap-2 star-rating" data-category="copilot_feedback">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
              
              <!-- Ecosystem Feedback -->
              <div class="space-y-2">
                <label class="text-sm font-medium text-white">Ecosystem Feedback</label>
                <div class="flex items-center gap-2 star-rating" data-category="ecosystem_feedback">
                  <span class="star" data-rating="1">★</span>
                  <span class="star" data-rating="2">★</span>
                  <span class="star" data-rating="3">★</span>
                  <span class="star" data-rating="4">★</span>
                  <span class="star" data-rating="5">★</span>
                </div>
              </div>
            </div>
            
            <!-- Optional Feedback Note -->
            <div class="space-y-2 mb-6">
              <label class="text-sm font-medium text-white">Additional Comments (Optional)</label>
              <textarea 
                id="feedbackNote" 
                placeholder="Share any additional thoughts or suggestions..."
                class="w-full p-3 bg-[#1E1E21] border border-white/10 rounded-lg text-white placeholder-white/50 resize-none focus:outline-none focus:border-accent"
                rows="3"
              ></textarea>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 justify-end">
              <button id="cancelFeedback" class="px-6 py-2 bg-[#2E3137] border border-white/10 text-white rounded-lg hover:bg-[#3a3d44] transition-colors">
                Cancel
              </button>
              <button id="submitFeedback" class="px-6 py-2 bg-accent text-[#1E1E21] rounded-lg hover:opacity-80 transition-opacity font-medium">
                Submit Feedback
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documentation Modal -->
    <div id="documentationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2E3137] border border-white/10 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-semibold text-white flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              PitchLense Documentation
            </h2>
            <button id="closeDocumentation" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="space-y-6">
              <!-- Overview Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Overview</h3>
                <p class="text-white/80 text-sm leading-relaxed">
                  PitchLense is an AI-powered startup analysis platform that provides comprehensive risk assessment and growth potential evaluation for early-stage ventures. Our platform analyzes multiple dimensions of startup risk and provides actionable insights for investors, founders, and stakeholders.
                </p>
              </div>

              <!-- Features Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Key Features</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Overall Analysis</h4>
                    <p class="text-white/70 text-sm">Comprehensive dashboard showing market value trends, risk analysis, growth potential, and startup metrics.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Detailed Analysis</h4>
                    <p class="text-white/70 text-sm">In-depth risk assessment across 9 key dimensions including market, team, product, and financial risks.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Uploaded Files</h4>
                    <p class="text-white/70 text-sm">View and analyze uploaded documents including pitch decks, founder profiles, and business plans.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Industry News</h4>
                    <p class="text-white/70 text-sm">Stay updated with the latest industry news and market trends relevant to your analysis.</p>
                  </div>
                </div>
              </div>

              <!-- Risk Analysis Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Risk Analysis Framework</h3>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#FB5D5D] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">High Risk (7-10)</h4>
                      <p class="text-white/70 text-sm">Critical areas requiring immediate attention and mitigation strategies.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#FFF27A] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">Medium Risk (5-6)</h4>
                      <p class="text-white/70 text-sm">Areas that need monitoring and potential improvement over time.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#10B981] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">Low Risk (1-4)</h4>
                      <p class="text-white/70 text-sm">Strong areas that represent competitive advantages.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Key Risk Indicators Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Key Risk Indicators Investors Look For</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  Understanding these risk categories helps investors make informed decisions. PitchLense analyzes each of these dimensions to provide comprehensive risk assessment.
                </p>
                
                <div class="space-y-4">
                  <!-- Market Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Market Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Small or overstated TAM (Total Addressable Market)</li>
                      <li>• Weak growth rate in target industry</li>
                      <li>• Overcrowded space with strong incumbents</li>
                      <li>• Lack of differentiation → startup doesn't stand out</li>
                      <li>• Overdependence on a niche (market too narrow)</li>
                    </ul>
                  </div>

                  <!-- Product Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Product Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Product still at idea/MVP stage, no working version</li>
                      <li>• Unclear product–market fit → no proof customers want it</li>
                      <li>• High technical uncertainty → feasibility doubts</li>
                      <li>• Weak IP protection → easily copied by competitors</li>
                      <li>• Poor scalability of product/tech stack</li>
                    </ul>
                  </div>

                  <!-- Team/Founder Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Team / Founder Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Single founder (no co-founders or leadership depth)</li>
                      <li>• High founder churn risk (no vesting, unstable commitment)</li>
                      <li>• Skill gaps in key areas (tech, sales, operations)</li>
                      <li>• Past credibility issues (bad track record, lawsuits)</li>
                      <li>• Misaligned incentives or founder–investor conflicts</li>
                    </ul>
                  </div>

                  <!-- Financial Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Financial Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Inconsistent financial metrics (revenues don't match user growth)</li>
                      <li>• High burn rate with short runway (<12 months)</li>
                      <li>• Overly optimistic projections (inflated TAM, hockey-stick forecasts)</li>
                      <li>• High CAC vs LTV ratio → customer acquisition unsustainable</li>
                      <li>• Low or negative margins with no path to profitability</li>
                      <li>• Dependence on continuous external funding to survive</li>
                    </ul>
                  </div>

                  <!-- Customer & Traction Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Customer & Traction Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Low or no traction despite long time in market</li>
                      <li>• High churn rate (customers dropping off)</li>
                      <li>• Low retention/engagement (DAU/MAU weak)</li>
                      <li>• Lack of marquee customers or paying clients</li>
                      <li>• Dependence on one or two large customers (concentration risk)</li>
                    </ul>
                  </div>

                  <!-- Operational Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Operational Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Weak supply chain or vendor dependencies</li>
                      <li>• No clear go-to-market (GTM) strategy</li>
                      <li>• Inefficient operations → high costs for low output</li>
                      <li>• Poor execution history → delays, missed milestones</li>
                    </ul>
                  </div>

                  <!-- Competitive Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Competitive Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Strong incumbent competitors with deep pockets</li>
                      <li>• Low entry barriers → anyone can replicate</li>
                      <li>• Unclear defensibility (no moat: IP, network effects, brand)</li>
                    </ul>
                  </div>

                  <!-- Legal & Regulatory Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Legal & Regulatory Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Unregulated/grey areas (crypto, healthtech, fintech)</li>
                      <li>• Potential compliance issues (data privacy, labor laws, financial regulations)</li>
                      <li>• Pending lawsuits or legal disputes</li>
                    </ul>
                  </div>

                  <!-- Exit Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Exit Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Unclear exit pathways (IPO, M&A)</li>
                      <li>• Sector with low historical exit activity</li>
                      <li>• Unlikely to attract late-stage investors</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Investment Analysis Framework Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Investment Analysis Framework</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  Investors evaluate startups across multiple dimensions to create a comprehensive risk profile. Here's how PitchLense structures this analysis:
                </p>
                
                <div class="space-y-4">
                  <!-- Market Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Market Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>TAM, SAM, SOM:</strong> Total, Serviceable, and Obtainable markets</li>
                      <li>• <strong>Growth potential:</strong> CAGR, trends, adoption curve</li>
                      <li>• <strong>Competitive landscape:</strong> Incumbents, market crowding</li>
                      <li>• <strong>Differentiation:</strong> Unique value proposition</li>
                    </ul>
                  </div>

                  <!-- Product Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Product Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Stage:</strong> Idea, MVP, early traction, or product–market fit (PMF)</li>
                      <li>• <strong>Technology:</strong> Scalability, defensibility, innovation</li>
                      <li>• <strong>Moat:</strong> Patents, IP, data advantage, network effects</li>
                      <li>• <strong>Customer feedback:</strong> NPS, testimonials, early adoption signals</li>
                    </ul>
                  </div>

                  <!-- Team Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Team Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Founders' background:</strong> Prior startups, industry expertise, network</li>
                      <li>• <strong>Team balance:</strong> Tech, business, ops → complementary skills</li>
                      <li>• <strong>Commitment:</strong> Full-time vs side-project, long-term vision</li>
                      <li>• <strong>Execution ability:</strong> Track record of delivering milestones</li>
                    </ul>
                  </div>

                  <!-- Financial Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Financial Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Unit economics:</strong> CAC (Customer Acquisition Cost), LTV (Lifetime Value)</li>
                      <li>• <strong>Margins:</strong> Gross and net profitability</li>
                      <li>• <strong>Burn rate & runway:</strong> How long till cash runs out</li>
                      <li>• <strong>Revenue quality:</strong> Recurring vs one-off revenue</li>
                      <li>• <strong>Financial projections:</strong> Realistic vs over-optimistic forecasts</li>
                    </ul>
                  </div>

                  <!-- Traction Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Traction Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Customer base:</strong> Paying vs free users, marquee clients</li>
                      <li>• <strong>Growth rates:</strong> MoM or YoY revenue/users</li>
                      <li>• <strong>Retention & churn:</strong> Product stickiness</li>
                      <li>• <strong>Sales pipeline:</strong> Strong, weak, or non-existent</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Red Flags Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">🚩 Red Flags Investors Look For</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  These warning signs can significantly impact investment decisions and should be carefully evaluated:
                </p>
                
                <div class="space-y-3">
                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Market Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Tiny market or TAM exaggerated by founder</li>
                      <li>• No clear competitive advantage → "me-too startup"</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Product Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• No working MVP after long time</li>
                      <li>• Easily replicable → no moat</li>
                      <li>• Heavy dependence on buzzwords (AI, blockchain) without substance</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Team Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Solo founder → lack of diversity in leadership</li>
                      <li>• Frequent founder conflicts or departures</li>
                      <li>• Lack of skin in the game (founder not full-time or heavily diluted)</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Financial Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Burning too fast with <6 months runway</li>
                      <li>• Unrealistic projections ("10x in 1 year" with no evidence)</li>
                      <li>• Unit economics broken → CAC > LTV</li>
                      <li>• Overly complex or unclear cap table</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Traction Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• No paying customers despite years of work</li>
                      <li>• High churn → customers not staying</li>
                      <li>• Inflated vanity metrics (downloads, signups) without engagement</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Founder / Soft Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Lack of transparency in data shared with investors</li>
                      <li>• Pivoting too often without clear rationale</li>
                      <li>• Overconfidence / arrogance → "We don't have competitors" (big red flag)</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Growth Potential Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Growth Potential Calculation</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-3">
                  Our growth potential score is calculated using a weighted formula that considers key startup dimensions:
                </p>
                <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                  <div class="text-sm text-white/80 font-mono">
                    Growth Score = ∑(Dimension Score × Weightage)
                  </div>
                  <div class="mt-3 space-y-1 text-sm">
                    <div class="flex justify-between">
                      <span class="text-white/60">Market Potential</span>
                      <span class="text-white">30%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Product Strength</span>
                      <span class="text-white">10%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Team Quality</span>
                      <span class="text-white">20%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Financial Health</span>
                      <span class="text-white">10%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Traction & Growth</span>
                      <span class="text-white">30%</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Getting Started Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Getting Started</h3>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">1</div>
                    <div>
                      <h4 class="text-white font-medium">Upload Documents</h4>
                      <p class="text-white/70 text-sm">Upload your pitch deck, founder profile, and other relevant documents for analysis.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">2</div>
                    <div>
                      <h4 class="text-white font-medium">Review Analysis</h4>
                      <p class="text-white/70 text-sm">Examine the overall analysis dashboard for key insights and risk assessments.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">3</div>
                    <div>
                      <h4 class="text-white font-medium">Deep Dive</h4>
                      <p class="text-white/70 text-sm">Use the detailed analysis section to explore specific risk dimensions and recommendations.</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graph Info Modal -->
    <div id="graphInfoModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2E3137] border border-white/10 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-semibold text-white flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              What is this Graph?
            </h2>
            <button id="closeGraphInfo" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="space-y-6">
              <!-- Overview Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Business Logic Overview</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  This Ecosight visualizes the business relationships and dependencies of your company within its market ecosystem. The graph helps you understand how your business connects with other entities in your industry.
                </p>
              </div>

              <!-- Graph Structure -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Graph Structure</h3>
                <div class="space-y-4">
                  <!-- Center Node -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #f1d85b;"></div>
                      <h4 class="text-white font-medium">Center (Yellow)</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Your startup or company name is positioned at the center of the graph, representing the focal point of all business relationships.
                    </p>
                  </div>

                  <!-- Left Side -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #3B82F6;"></div>
                      <h4 class="text-white font-medium">Left Side (Blue) - Dependencies</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate. Examples include suppliers, service providers, technology partners, or industry platforms.
                    </p>
                  </div>

                  <!-- Right Side -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #10B981;"></div>
                      <h4 class="text-white font-medium">Right Side (Green) - Customers</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services. Examples include enterprise clients, end consumers, or other businesses in your value chain.
                    </p>
                  </div>
                </div>
              </div>

              <!-- How to Use -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">How to Use</h3>
                <ul class="text-white/70 text-sm space-y-2">
                  <li>• <strong>Hover</strong> over any node to see detailed information about that entity</li>
                  <li>• <strong>Drag</strong> nodes to rearrange the layout (center node cannot be moved)</li>
                  <li>• <strong>Zoom</strong> in/out to focus on specific areas of the graph</li>
                  <li>• <strong>Reset</strong> view to return to the default layout</li>
                </ul>
              </div>

              <!-- Legend -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Legend</h3>
                <div class="grid grid-cols-1 gap-3">
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #f1d85b;"></div>
                    <span class="text-white/70 text-sm">Company - Your business at the center</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #3B82F6;"></div>
                    <span class="text-white/70 text-sm">Dependencies - Entities your business relies on</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #10B981;"></div>
                    <span class="text-white/70 text-sm">Customers - Entities your business serves</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


      <!-- Circular Footer with Heart Icon -->
      <footer class="fixed bottom-4 right-4 z-50">
        <!-- Expanded Footer Content (Hidden by default) -->
        <div class="footer-expanded bg-[#2E3137] border border-white/10 rounded-[22px] px-4 py-3 mb-2 opacity-0 transform translate-y-2 pointer-events-none transition-all duration-300 ease-out">
        <div class="flex items-center justify-center gap-2 text-sm text-white/80 whitespace-nowrap overflow-x-auto">
          <span>Created with</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="#ef4444"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <span>by</span>
          <a href="https://amanulla.in/" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors font-medium">Aman Ulla</a>
          <span>,</span>
          <a href="#" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors font-medium">Srinivas Alva</a>
          <span class="text-white/40">|</span>
          <a href="https://vision.hack2skill.com/event/genaiexchangehackathon/?utm_source=hack2skill&utm_medium=homepage#overview" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors">Hack2Skill‑Google Hackathon</a>
          <span class="text-white/40">|</span>
          <div class="flex items-center gap-2">
            <a href="https://github.com/connectaman/PitchLense" target="_blank" rel="noopener noreferrer" title="GitHub" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2C6.48 2 2 6.58 2 12.26c0 4.52 2.87 8.35 6.84 9.71.5.09.68-.22.68-.49 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.37-3.37-1.37-.46-1.2-1.13-1.52-1.13-1.52-.92-.65.07-.64.07-.64 1.02.07 1.56 1.06 1.56 1.06.9 1.58 2.36 1.12 2.94.86.09-.67.35-1.12.63-1.38-2.22-.26-4.56-1.14-4.56-5.08 0-1.12.39-2.04 1.04-2.76-.1-.26-.45-1.32.1-2.75 0 0 .84-.27 2.76 1.05.8-.23 1.66-.35 2.52-.35s1.72.12 2.52.35c1.92-1.32 2.76-1.05 2.76-1.05.55 1.43.2 2.49.1 2.75.65.72 1.04 1.64 1.04 2.76 0 3.95-2.34 4.82-4.57 5.07.36.31.68.93.68 1.88 0 1.35-.01 2.45-.01 2.78 0 .27.18.58.69.48A10.03 10.03 0 0 0 22 12.26C22 6.58 17.52 2 12 2Z"/></svg>
            </a>
            <a href="https://pypi.org/project/pitchlense-mcp/" target="_blank" rel="noopener noreferrer" title="PyPI" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 3a4 4 0 0 1 4 4v3a2 2 0 0 1-2 2H8a4 4 0 0 1-4-4V5a2 2 0 0 1 2-2h6Zm-2 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm2 14a4 4 0 0 1-4-4v-3a2 2 0 0 1 2-2h6a4 4 0 0 1 4 4v3a2 2 0 0 1-2 2h-6Zm2-4a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"/></svg>
            </a>
            <a href="https://pitchlense-mcp.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer" title="Read the Docs" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 3h12a2 2 0 0 1 2 2v14l-3-2-3 2-3-2-3 2-3-2V5a2 2 0 0 1 2-2Zm2 4v2h8V7H7Zm0 4v2h8v-2H7Z"/></svg>
            </a>
          </div>
          </div>
        </div>
        
        <!-- Circular Heart Icon Button -->
        <div class="footer-circle w-12 h-12 bg-[#2E3137] border border-white/10 rounded-full flex items-center justify-center cursor-pointer hover:bg-[#3a3d44] transition-all duration-300 ease-out shadow-lg hover:shadow-xl">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="#ef4444" class="transition-transform duration-300 ease-out">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </div>
      </footer>
    </div>


    <script>
      // Global variables
      let reportData = null;
      let globalTooltipTimeout = null; // Global reference to tooltip timeout

      // Function to hide knowledge graph tooltip
      function hideKnowledgeGraphTooltip() {
        // Clear any existing timeout
        if (globalTooltipTimeout) {
          clearTimeout(globalTooltipTimeout);
          globalTooltipTimeout = null;
        }
        
        const existingTooltip = d3.select('.knowledge-graph-tooltip');
        if (!existingTooltip.empty()) {
          existingTooltip.style('opacity', 0);
          
          // Remove the tooltip completely after fade out
          globalTooltipTimeout = setTimeout(() => {
            existingTooltip.remove();
            globalTooltipTimeout = null;
          }, 200);
        }
      }

      // Tab functionality
      function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button:not([data-tab="news"]):not([data-tab="documents"])');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Handle documentation tab separately
            if (targetTab === 'documentation') {
              openDocumentationModal();
              return;
            }
            
            // Hide any visible knowledge graph tooltip when switching tabs
            hideKnowledgeGraphTooltip();
            
            // Remove active class from all main navigation buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Add active class to clicked button
            button.classList.add('active');
            
            // Show corresponding content
            let targetContent;
            if (targetTab === 'files') {
              targetContent = document.getElementById('uploadedFilesContent');
            } else if (targetTab === 'qna') {
              targetContent = document.getElementById('qnaContent');
            } else if (targetTab === 'dependency') {
              targetContent = document.getElementById('dependencyContent');
            } else if (targetTab === 'followup') {
              targetContent = document.getElementById('followUpContent');
            } else {
              targetContent = document.getElementById(`${targetTab}AnalysisContent`);
            }
            if (targetContent) {
              targetContent.classList.remove('hidden');
            }
          });
        });
      }

      // Open documentation modal
      function openDocumentationModal() {
        const modal = document.getElementById('documentationModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      }

      // Close documentation modal
      function closeDocumentationModal() {
        const modal = document.getElementById('documentationModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }
      }

      // Initialize documentation modal
      function initializeDocumentationModal() {
        const documentationBtn = document.getElementById('documentationTab');
        const closeBtn = document.getElementById('closeDocumentation');
        const modal = document.getElementById('documentationModal');
        
        if (documentationBtn) {
          documentationBtn.addEventListener('click', openDocumentationModal);
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeDocumentationModal);
        }
        
        if (modal) {
          // Close modal when clicking outside
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeDocumentationModal();
            }
          });
          
          // Close modal with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeDocumentationModal();
            }
          });
        }
      }

      // PDF Export Functionality
      async function exportToPDF() {
        // Check if jsPDF is available
        if (!window.jspdf || !window.jspdf.jsPDF) {
          throw new Error('jsPDF library not loaded. Please refresh the page and try again.');
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Set up fonts and colors
        doc.setFont('helvetica');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        let yPosition = margin;
        
        // Helper function to add text with word wrapping
        function addText(text, x, y, maxWidth, fontSize = 10, color = '#000000') {
          doc.setFontSize(fontSize);
          doc.setTextColor(color);
          const lines = doc.splitTextToSize(text, maxWidth);
          doc.text(lines, x, y);
          return y + (lines.length * fontSize * 0.35);
        }
        
        // Helper function to add a new page if needed
        function checkNewPage(requiredSpace) {
          if (yPosition + requiredSpace > pageHeight - margin) {
            doc.addPage();
            yPosition = margin;
            return true;
          }
          return false;
        }
        
        
        // Title
        doc.setFontSize(24);
        doc.setTextColor('#1E1E21');
        doc.text('PitchLense Analysis Report', margin, yPosition);
        yPosition += 15;
        
        // Report metadata
        if (window.reportData) {
          const reportData = window.reportData;
          doc.setFontSize(12);
          doc.setTextColor('#666666');
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, margin, yPosition);
          yPosition += 8;
          
          if (reportData.company_name) {
            doc.text(`Company: ${reportData.company_name}`, margin, yPosition);
            yPosition += 8;
          }
          
          if (reportData.industry) {
            doc.text(`Industry: ${reportData.industry}`, margin, yPosition);
            yPosition += 8;
          }
        }
        
        yPosition += 10;
        
        // Overall Analysis Section
        if (window.analyses) {
          doc.setFontSize(18);
          doc.setTextColor('#1E1E21');
          doc.text('Overall Analysis', margin, yPosition);
          yPosition += 12;
          
          // Overall score
          if (window.overallScore !== undefined) {
            doc.setFontSize(14);
            doc.setTextColor('#f1d85b');
            doc.text(`Overall Risk Score: ${window.overallScore}/10`, margin, yPosition);
            yPosition += 10;
          }
          
          // Risk level
          if (window.overallRiskLevel) {
            doc.setFontSize(12);
            doc.setTextColor('#666666');
            doc.text(`Risk Level: ${window.overallRiskLevel.toUpperCase()}`, margin, yPosition);
            yPosition += 8;
          }
          
          yPosition += 10;
          
          // Analysis categories with scores
          const analysisArray = Object.entries(window.analyses)
            .map(([key, analysis]) => ({
              name: key,
              ...analysis
            }))
            .filter(analysis => analysis.category_score !== undefined && analysis.category_score !== null)
            .sort((a, b) => b.category_score - a.category_score);
          
          doc.setFontSize(14);
          doc.setTextColor('#1E1E21');
          doc.text('Analysis Categories', margin, yPosition);
          yPosition += 10;
          
          analysisArray.forEach((analysis, index) => {
            checkNewPage(15);
            
            // Category name and score
            doc.setFontSize(12);
            doc.setTextColor('#1E1E21');
            doc.text(`${index + 1}. ${analysis.category_name || 'Unknown Category'}`, margin, yPosition);
            
            // Score on the right
            const scoreText = `${analysis.category_score}/10`;
            const scoreWidth = doc.getTextWidth(scoreText);
            doc.text(scoreText, pageWidth - margin - scoreWidth, yPosition);
            
            // Risk level
            if (analysis.overall_risk_level) {
              doc.setFontSize(10);
              doc.setTextColor('#666666');
              doc.text(`Risk: ${analysis.overall_risk_level.toUpperCase()}`, margin + 10, yPosition + 6);
            }
            
            yPosition += 12;
          });
          
          yPosition += 15;
        }
        
        
        
        // Detailed Analysis Section - NEW PAGE
        if (window.analyses) {
          doc.addPage(); // New page for detailed analysis
          yPosition = margin;
          
          doc.setFontSize(18);
          doc.setTextColor('#1E1E21');
          doc.text('Detailed Analysis', margin, yPosition);
          yPosition += 12;
          
          const analysisArray = Object.entries(window.analyses)
            .map(([key, analysis]) => ({
              name: key,
              ...analysis
            }))
            .sort((a, b) => {
              // Put LV-Analysis first
              const aIsLV = a.category_name && a.category_name.toLowerCase().includes('lv-analysis');
              const bIsLV = b.category_name && b.category_name.toLowerCase().includes('lv-analysis');
              if (aIsLV && !bIsLV) return -1;
              if (!aIsLV && bIsLV) return 1;
              return 0;
            });
          
          analysisArray.forEach((analysis, index) => {
            checkNewPage(30);
            
            // Category header
            doc.setFontSize(14);
            doc.setTextColor('#1E1E21');
            doc.text(`${analysis.category_name || 'Analysis'}`, margin, yPosition);
            yPosition += 8;
            
            // Score and risk level
            if (analysis.category_score !== undefined) {
              doc.setFontSize(10);
              doc.setTextColor('#666666');
              doc.text(`Score: ${analysis.category_score}/10`, margin, yPosition);
              if (analysis.overall_risk_level) {
                doc.text(`Risk Level: ${analysis.overall_risk_level.toUpperCase()}`, margin + 50, yPosition);
              }
              yPosition += 6;
            }
            
            // Summary
            if (analysis.summary) {
              doc.setFontSize(10);
              doc.setTextColor('#333333');
              yPosition = addText(`Summary: ${analysis.summary}`, margin, yPosition, pageWidth - 2 * margin, 10, '#333333');
              yPosition += 5;
            }
            
            // Detailed analysis result (for LV-Analysis and detailed business notes)
            const isLVAnalysis = analysis.category_name && analysis.category_name.toLowerCase().includes('lv-analysis');
            const isDetailedBusinessNote = analysis.analysis_type === 'detailed_business_note';
            
            if ((isLVAnalysis || isDetailedBusinessNote) && analysis.result && analysis.result.analysis_result) {
              doc.setFontSize(10);
              doc.setTextColor('#1E1E21');
              doc.text('Detailed Analysis:', margin, yPosition);
              yPosition += 6;
              
              // Convert markdown to plain text for PDF
              const plainText = analysis.result.analysis_result
                .replace(/#{1,6}\s+/g, '') // Remove markdown headers
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold formatting
                .replace(/\*(.*?)\*/g, '$1') // Remove italic formatting
                .replace(/`(.*?)`/g, '$1') // Remove code formatting
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to plain text
                .replace(/\n\n/g, '\n') // Reduce multiple newlines
                .trim();
              
              yPosition = addText(plainText, margin, yPosition, pageWidth - 2 * margin, 9, '#333333');
              yPosition += 10;
            }
            
            // Risk indicators
            if (analysis.indicators && analysis.indicators.length > 0) {
              doc.setFontSize(10);
              doc.setTextColor('#1E1E21');
              doc.text('Risk Indicators:', margin, yPosition);
              yPosition += 6;
              
              analysis.indicators.forEach((indicator, idx) => {
                checkNewPage(20);
                
                doc.setFontSize(9);
                doc.setTextColor('#333333');
                
                // Indicator name
                doc.text(`• ${indicator.indicator || 'Unknown Indicator'}`, margin + 5, yPosition);
                yPosition += 5;
                
                // Description
                if (indicator.description) {
                  yPosition = addText(`  ${indicator.description}`, margin + 5, yPosition, pageWidth - 2 * margin - 10, 8, '#666666');
                  yPosition += 3;
                }
                
                // Recommendation
                if (indicator.recommendation) {
                  doc.setTextColor('#1E1E21');
                  yPosition = addText(`  Recommendation: ${indicator.recommendation}`, margin + 5, yPosition, pageWidth - 2 * margin - 10, 8, '#1E1E21');
                  yPosition += 5;
                }
                
                yPosition += 3;
              });
            }
            
            yPosition += 15;
          });
        }
        
        // Footer
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor('#999999');
          doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
          doc.text('Generated by PitchLense', margin, pageHeight - 10);
        }
        
        // Save the PDF
        const fileName = `PitchLense_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
      }

      // PPTX Export Functionality
      async function exportToPPTX() {
        // Check if PptxGenJS is available
        if (!window.PptxGenJS) {
          throw new Error('PptxGenJS library not loaded. Please refresh the page and try again.');
        }

        const pptx = new window.PptxGenJS();
        
        // Set presentation properties
        pptx.author = 'PitchLense AI';
        pptx.company = 'PitchLense';
        pptx.title = 'PitchLense Analysis Report';
        pptx.subject = 'Startup Analysis Report';
        
        // Get report data
        const reportData = window.reportData || {};
        const report = reportData.report || {};
        const data = reportData.data || {};
        
        // Extract company information from the data (same as PDF export)
        const companyName = reportData.company_name || 'N/A';
        const industry = reportData.industry || 'N/A';
        const foundedDate = reportData.founded_date || 'N/A';
        const location = reportData.location || 'N/A';
        
        // Extract analyses
        const analysesObj = data.startup_analysis?.analyses || {};
        const analyses = Object.entries(analysesObj)
          .filter(([key, analysis]) => analysis.category_score !== undefined && analysis.category_score !== null)
          .map(([key, analysis]) => ({
            name: key,
            category_name: analysis.category_name || key,
            category_score: analysis.category_score || 0,
            overall_risk_level: analysis.overall_risk_level || 'unknown',
            overall_score: analysis.overall_score || 0,
            indicators: analysis.indicators || [],
            summary: analysis.summary || ''
          }));

        // Slide 1: Title Slide
        const titleSlide = pptx.addSlide();
        titleSlide.background = { color: '1E1E21' };
        
        titleSlide.addText('PitchLense AI-Powered Startup Analysis', {
          x: 1, y: 1.5, w: 8, h: 1,
          fontSize: 28,
          bold: true,
          color: 'FFFFFF',
          align: 'center'
        });
        
        titleSlide.addText(`${companyName} Analysis Report`, {
          x: 1, y: 2.5, w: 8, h: 0.8,
          fontSize: 20,
          color: 'FFF27A',
          align: 'center'
        });
        
        // Startup details box
        titleSlide.addShape('rect', {
          x: 1.5, y: 3.5, w: 7, h: 2,
          fill: { color: '2E3137' },
          line: { color: 'FFF27A', width: 2 }
        });
        
        const startupDetails = [
          `Company: ${companyName}`,
          `Industry: ${industry}`,
          `Founded: ${foundedDate}`,
          `Location: ${location}`,
          `Analysis Date: ${new Date().toLocaleDateString()}`
        ];
        
        titleSlide.addText(startupDetails.join('\n'), {
          x: 1.7, y: 3.7, w: 6.6, h: 1.6,
          fontSize: 12,
          color: 'FFFFFF',
          align: 'left'
        });
        
        titleSlide.addText('Powered by PitchLense AI', {
          x: 1, y: 6, w: 8, h: 0.5,
          fontSize: 14,
          color: 'CCCCCC',
          align: 'center'
        });

        // Slide 2: Growth Potential Score
        const growthSlide = pptx.addSlide();
        growthSlide.background = { color: 'F8F9FA' };
        
        growthSlide.addText('🎯 Growth Potential Assessment', {
          x: 0.5, y: 0.2, w: 9, h: 0.5,
          fontSize: 20,
          bold: true,
          color: '1E1E21',
          align: 'center'
        });
        
        // Calculate growth potential score
        const weightageMap = {
          'Market Risks': 0.30,
          'Product Risks': 0.10,
          'Team & Founder Risks': 0.20,
          'Financial Risks': 0.10,
          'Customer & Traction Risks': 0.30
        };
        
        let totalGrowthScore = 0;
        analyses.forEach(analysis => {
          const categoryName = analysis.category_name || analysis.name;
          const weightage = weightageMap[categoryName] || 0;
          if (weightage > 0 && analysis.category_score) {
            const growthScore = Math.max(1, 11 - analysis.category_score);
            totalGrowthScore += growthScore * weightage;
          }
        });
        
        const growthScore = Math.round(totalGrowthScore * 10) / 10;
        
        // Large score display - moved higher
        growthSlide.addText(`${growthScore}`, {
          x: 2, y: 0.8, w: 6, h: 1.2,
          fontSize: 40,
          bold: true,
          color: growthScore >= 7.5 ? '10b981' : growthScore >= 5 ? 'f59e0b' : 'ef4444',
          align: 'center'
        });
        
        growthSlide.addText('/10', {
          x: 5.5, y: 1.5, w: 2, h: 0.5,
          fontSize: 20,
          bold: true,
          color: '666666',
          align: 'center'
        });
        
        // Status text
        const statusText = growthScore >= 7.5 ? 'High Growth Potential' : 
                          growthScore >= 5 ? 'Moderate Growth Potential' : 'Needs Improvement';
        const statusColor = growthScore >= 7.5 ? '10b981' : 
                           growthScore >= 5 ? 'f59e0b' : 'ef4444';
        
        growthSlide.addText(statusText, {
          x: 1, y: 2, w: 8, h: 0.3,
          fontSize: 14,
          bold: true,
          color: statusColor,
          align: 'center'
        });
        
        // Score breakdown table - smaller and positioned better
        const breakdownData = [
          ['Category', 'Weight', 'Risk Score', 'Growth Score', 'Weighted Score'],
          ...analyses.map(analysis => {
            const categoryName = analysis.category_name || analysis.name;
            const weightage = weightageMap[categoryName] || 0;
            const growthScore = Math.max(1, 11 - (analysis.category_score || 0));
            const weightedScore = growthScore * weightage;
            return [
              categoryName,
              `${(weightage * 100).toFixed(0)}%`,
              `${analysis.category_score}/10`,
              `${growthScore.toFixed(1)}/10`,
              `${weightedScore.toFixed(2)}`
            ];
          })
        ];
        
        growthSlide.addTable(breakdownData, {
          x: 0.5, y: 2.5, w: 9, h: 4.5,
          fontSize: 9,
          border: { type: 'solid', color: 'CCCCCC', pt: 1 },
          fill: { color: 'FFFFFF' },
          color: '333333',
          align: 'center'
        });

        // Slide 3: Executive Summary
        const summarySlide = pptx.addSlide();
        summarySlide.background = { color: 'FFFFFF' };
        
        summarySlide.addText('📊 Executive Summary', {
          x: 0.5, y: 0.3, w: 9, h: 0.6,
          fontSize: 22,
          bold: true,
          color: '1E1E21',
          align: 'center'
        });
        
        // Summary statistics
        const summaryStats = [
          ['Metric', 'Value', 'Status'],
          ['Growth Potential', `${growthScore}/10`, growthScore >= 7.5 ? 'High' : growthScore >= 5 ? 'Moderate' : 'Low'],
          ['Risk Categories', `${analyses.length}`, 'Analyzed'],
          ['Overall Risk Level', analyses.length > 0 ? analyses[0].overall_risk_level || 'Unknown' : 'Unknown', 'Assessment'],
          ['Analysis Date', new Date().toLocaleDateString(), 'Current']
        ];
        
        summarySlide.addTable(summaryStats, {
          x: 1, y: 1.2, w: 8, h: 2.5,
          fontSize: 12,
          border: { type: 'solid', color: '1E1E21', pt: 1 },
          fill: { color: 'F8F9FA' },
          color: '333333',
          align: 'center'
        });
        
        // Key insights
        summarySlide.addText('Key Insights:', {
          x: 0.5, y: 4, w: 9, h: 0.4,
          fontSize: 16,
          bold: true,
          color: '1E1E21'
        });
        
        const insights = [
          `• Comprehensive analysis across ${analyses.length} risk categories`,
          `• Growth potential score of ${growthScore}/10 indicates ${growthScore >= 7.5 ? 'strong' : growthScore >= 5 ? 'moderate' : 'limited'} potential`,
          `• Risk assessment provides actionable insights for investment decisions`
        ];
        
        summarySlide.addText(insights.join('\n'), {
          x: 0.5, y: 4.5, w: 9, h: 2.5,
          fontSize: 12,
          color: '666666',
          valign: 'top'
        });

        // Slide 4: Risk Assessment Overview
        const riskSlide = pptx.addSlide();
        riskSlide.background = { color: 'F8F9FA' };
        
        riskSlide.addText('🎯 Risk Assessment Overview', {
          x: 0.5, y: 0.3, w: 9, h: 0.6,
          fontSize: 22,
          bold: true,
          color: '1E1E21',
          align: 'center'
        });
        
        // Create enhanced risk assessment table
        const riskTableData = [
          ['Category', 'Risk Level', 'Risk Score', 'Growth Score', 'Status'],
          ...analyses.slice(0, 6).map(analysis => {
            const growthScore = Math.max(1, 11 - (analysis.category_score || 0));
            const riskLevel = analysis.overall_risk_level || 'unknown';
            const statusColor = riskLevel === 'low' ? '🟢 Low Risk' : 
                               riskLevel === 'medium' ? '🟡 Medium Risk' : '🔴 High Risk';
            return [
              analysis.category_name || analysis.name,
              riskLevel.toUpperCase(),
              `${analysis.category_score}/10`,
              `${growthScore.toFixed(1)}/10`,
              statusColor
            ];
          })
        ];
        
        riskSlide.addTable(riskTableData, {
          x: 0.5, y: 1.2, w: 9, h: 5.5,
          fontSize: 10,
          border: { type: 'solid', color: '1E1E21', pt: 1 },
          fill: { color: 'FFFFFF' },
          color: '333333',
          align: 'center'
        });

        // Slide 5-10: Detailed Analysis (one slide per category)
        analyses.slice(0, 6).forEach((analysis, index) => {
          const detailSlide = pptx.addSlide();
          detailSlide.background = { color: 'FFFFFF' };
          
          // Header with gradient background effect
          detailSlide.addShape('rect', {
            x: 0, y: 0, w: 10, h: 0.8,
            fill: { color: '1E1E21' }
          });
          
          detailSlide.addText(`${index + 1}. ${analysis.category_name || analysis.name}`, {
            x: 0.5, y: 0.1, w: 9, h: 0.6,
            fontSize: 18,
            bold: true,
            color: 'FFFFFF',
            align: 'center'
          });
          
          // Risk and score info in top right corner - smaller
          const riskLevel = analysis.overall_risk_level || 'unknown';
          const riskColor = riskLevel === 'low' ? '10b981' : 
                           riskLevel === 'medium' ? 'f59e0b' : 'ef4444';
          
          detailSlide.addShape('rect', {
            x: 7, y: 1, w: 2.5, h: 0.4,
            fill: { color: riskColor }
          });
          
          detailSlide.addText(`${riskLevel.toUpperCase()}`, {
            x: 7, y: 1.1, w: 2.5, h: 0.2,
            fontSize: 10,
            bold: true,
            color: 'FFFFFF',
            align: 'center'
          });
          
          detailSlide.addShape('rect', {
            x: 7, y: 1.5, w: 2.5, h: 0.4,
            fill: { color: 'F8F9FA' },
            line: { color: '1E1E21', width: 1 }
          });
          
          detailSlide.addText(`${analysis.category_score}/10`, {
            x: 7, y: 1.6, w: 2.5, h: 0.2,
            fontSize: 10,
            bold: true,
            color: '1E1E21',
            align: 'center'
          });
          
          // Analysis summary - much smaller and more compact
          if (analysis.summary) {
            detailSlide.addText('📋 Analysis Summary', {
              x: 0.5, y: 2.2, w: 6, h: 0.3,
              fontSize: 12,
              bold: true,
              color: '1E1E21'
            });
            
            detailSlide.addShape('rect', {
              x: 0.5, y: 2.5, w: 6, h: 1.2,
              fill: { color: 'F8F9FA' },
              line: { color: 'CCCCCC', width: 1 }
            });
            
            detailSlide.addText(analysis.summary.substring(0, 200) + (analysis.summary.length > 200 ? '...' : ''), {
              x: 0.7, y: 2.7, w: 5.6, h: 0.8,
              fontSize: 8,
              color: '333333',
              valign: 'top'
            });
          }
          
          // Key indicators with table format - much smaller
          if (analysis.indicators && analysis.indicators.length > 0) {
            detailSlide.addText('🔍 Key Indicators', {
              x: 0.5, y: 3.8, w: 9, h: 0.3,
              fontSize: 12,
              bold: true,
              color: '1E1E21'
            });
            
            const indicatorsData = [
              ['Indicator', 'Assessment'],
              ...analysis.indicators.slice(0, 3).map(indicator => [
                indicator.indicator_name || 'N/A',
                (indicator.detailed_assessment || indicator.description || 'N/A').substring(0, 30) + '...'
              ])
            ];
            
            detailSlide.addTable(indicatorsData, {
              x: 0.5, y: 4.1, w: 9, h: 2,
              fontSize: 7,
              border: { type: 'solid', color: 'CCCCCC', pt: 1 },
              fill: { color: 'FFFFFF' },
              color: '333333',
              align: 'left'
            });
          }
        });


        // Final slide: Conclusion
        const conclusionSlide = pptx.addSlide();
        conclusionSlide.background = { color: '1E1E21' };
        
        conclusionSlide.addText('📊 Final Assessment', {
          x: 0.5, y: 0.3, w: 9, h: 0.6,
          fontSize: 22,
          bold: true,
          color: 'FFFFFF',
          align: 'center'
        });
        
        // Growth potential highlight
        conclusionSlide.addShape('rect', {
          x: 1, y: 1.2, w: 8, h: 1.2,
          fill: { color: 'FFF27A' },
          line: { color: '1E1E21', width: 2 }
        });
        
        conclusionSlide.addText(`Overall Growth Potential`, {
          x: 1, y: 1.4, w: 8, h: 0.4,
          fontSize: 16,
          bold: true,
          color: '1E1E21',
          align: 'center'
        });
        
        conclusionSlide.addText(`${growthScore}/10`, {
          x: 1, y: 1.8, w: 8, h: 0.6,
          fontSize: 36,
          bold: true,
          color: '1E1E21',
          align: 'center'
        });
        
        // Key takeaways
        conclusionSlide.addText('Key Takeaways:', {
          x: 0.5, y: 2.8, w: 9, h: 0.4,
          fontSize: 18,
          bold: true,
          color: 'FFFFFF'
        });
        
        const takeaways = [
          `• ${analyses.length} risk categories comprehensively analyzed`,
          `• Growth potential score: ${growthScore}/10 (${growthScore >= 7.5 ? 'High' : growthScore >= 5 ? 'Moderate' : 'Low'} potential)`,
          `• Risk assessment provides actionable investment insights`,
          `• Analysis powered by advanced AI algorithms`
        ];
        
        conclusionSlide.addText(takeaways.join('\n'), {
          x: 0.5, y: 3.3, w: 9, h: 2.5,
          fontSize: 12,
          color: 'CCCCCC',
          valign: 'top'
        });
        
        conclusionSlide.addText('Powered by PitchLense AI', {
          x: 0.5, y: 6, w: 9, h: 0.4,
          fontSize: 14,
          color: 'FFF27A',
          align: 'center',
          bold: true
        });

        // Thank You slide
        const thankYouSlide = pptx.addSlide();
        thankYouSlide.background = { color: '1E1E21' };
        
        // Thank you message
        thankYouSlide.addText('Thank You!', {
          x: 1, y: 2.5, w: 8, h: 1,
          fontSize: 36,
          bold: true,
          color: 'FFFFFF',
          align: 'center'
        });
        
        thankYouSlide.addText('For your attention and consideration', {
          x: 1, y: 3.7, w: 8, h: 0.6,
          fontSize: 20,
          color: 'FFF27A',
          align: 'center'
        });
        
        thankYouSlide.addText('PitchLense AI - Smart Investment Decisions', {
          x: 1, y: 5, w: 8, h: 0.4,
          fontSize: 16,
          color: 'CCCCCC',
          align: 'center',
          bold: true
        });

        // Save the presentation
        const fileName = `PitchLense_Analysis_${new Date().toISOString().split('T')[0]}.pptx`;
        await pptx.writeFile({ fileName });
      }
      
      // Generate HTML email content from report data
      function generateEmailHTML() {
        const reportData = window.reportData || {};
        const report = reportData.report || {};
        const data = reportData.data || {};
        
        // Extract analyses - it's an object, not an array
        const analysesObj = data.startup_analysis?.analyses || {};
        
        // Convert analyses object to array with proper structure
        const analyses = Object.entries(analysesObj)
          .filter(([key, analysis]) => analysis.category_score !== undefined && analysis.category_score !== null)
          .map(([key, analysis]) => ({
            name: key,
            category_name: analysis.category_name || key,
            category_score: analysis.category_score || 0,  // 1-10 scale
            overall_risk_level: analysis.overall_risk_level || 'unknown',
            overall_score: analysis.overall_score || 0,
            indicators: analysis.indicators || [],
            summary: analysis.summary || ''
          }));
        
        // Extract knowledge graph nodes
        const knowledgeGraph = data.knowledge_graph || {};
        let nodes = knowledgeGraph.nodes || [];
        if (!Array.isArray(nodes)) {
          nodes = [];
        }
        
        // Calculate growth potential score using the same formula as the app
        // Growth Score = 11 - Risk Score (inverted)
        const weightageMap = {
          'Market Risks': 0.30,
          'Product Risks': 0.10,
          'Team & Founder Risks': 0.20,
          'Financial Risks': 0.10,
          'Customer & Traction Risks': 0.30
        };
        
        let totalGrowthScore = 0;
        analyses.forEach(analysis => {
          const categoryName = analysis.category_name || analysis.name;
          const weightage = weightageMap[categoryName] || 0;
          if (weightage > 0 && analysis.category_score) {
            // Convert risk score to growth score (inverse)
            const growthScore = Math.max(1, 11 - analysis.category_score);
            totalGrowthScore += growthScore * weightage;
          }
        });
        
        const growthScore = Math.round(totalGrowthScore * 10) / 10; // Out of 10
        
        // Generate radar chart data (convert 1-10 score to percentage for bar width)
        const radarData = analyses.slice(0, 6).map(a => ({
          category: a.category_name || a.name,
          score: a.category_score || 0,
          percentage: ((a.category_score || 0) / 10) * 100
        }));
        
        // Generate HTML email
        return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchLense Analysis Report</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f4f4f4;">
    <table role="presentation" style="width: 100%; border-collapse: collapse;">
        <tr>
            <td style="padding: 40px 20px;">
                <table role="presentation" style="width: 100%; max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #1E1E21 0%, #2E3137 100%); padding: 40px 30px; text-align: center;">
                            <h1 style="margin: 0; color: #FFF27A; font-size: 28px; font-weight: bold;">PitchLense</h1>
                            <p style="margin: 10px 0 0; color: #ffffff; font-size: 14px; opacity: 0.9;">AI-Powered Startup Analysis Report</p>
                        </td>
                    </tr>
                    
                    <!-- Report Info -->
                    <tr>
                        <td style="padding: 30px;">
                            <h2 style="margin: 0 0 20px; color: #1E1E21; font-size: 22px;">${report.startup_name || 'Startup Analysis'}</h2>
                            
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
                                <tr>
                                    <td style="padding: 8px 0; color: #666; font-size: 14px; width: 40%;"><strong>Founder:</strong></td>
                                    <td style="padding: 8px 0; color: #333; font-size: 14px;">${report.founder_name || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; color: #666; font-size: 14px;"><strong>Launch Date:</strong></td>
                                    <td style="padding: 8px 0; color: #333; font-size: 14px;">${report.launch_date || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; color: #666; font-size: 14px;"><strong>Report Generated:</strong></td>
                                    <td style="padding: 8px 0; color: #333; font-size: 14px;">${new Date(report.created_at).toLocaleDateString() || 'N/A'}</td>
                                </tr>
                            </table>
                            
                            ${analyses.length > 0 ? `
                            <!-- Growth Potential KPI -->
                            <div style="background: linear-gradient(135deg, #FFF27A 0%, #f0e068 100%); padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 10px; color: #1E1E21; font-size: 16px; font-weight: 600;">🎯 Growth Potential Score</h3>
                                <div style="font-size: 48px; font-weight: bold; color: #1E1E21; margin: 10px 0;">${growthScore}<span style="font-size: 24px; color: #666;">/10</span></div>
                                <p style="margin: 5px 0 0; color: #333; font-size: 13px;">${growthScore >= 7.5 ? 'High Potential' : growthScore >= 5 ? 'Moderate Potential' : 'Needs Improvement'}</p>
                            </div>
                            
                            <!-- Radar Chart (Text Representation) -->
                            <h3 style="margin: 30px 0 15px; color: #1E1E21; font-size: 18px; border-bottom: 2px solid #FFF27A; padding-bottom: 8px;">📊 Risk Assessment Radar</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; background-color: #f9f9f9; padding: 15px; border-radius: 8px;">
                                ${radarData.map(item => {
                                    return `
                                    <tr>
                                        <td style="padding: 8px 0; width: 35%; color: #333; font-size: 13px; font-weight: 600;">${item.category}</td>
                                        <td style="padding: 8px 0;">
                                            <div style="background-color: #e0e0e0; height: 28px; border-radius: 14px; overflow: hidden; position: relative;">
                                                <div style="background: linear-gradient(90deg, #FFF27A 0%, #f0e068 100%); height: 100%; width: ${item.percentage}%; display: flex; align-items: center; justify-content: center; min-width: 50px;">
                                                    <span style="font-size: 12px; font-weight: bold; color: #1E1E21; text-align: center; white-space: nowrap;">${item.score}/10</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </table>
                            
                            <!-- Startup Analysis Risk Scores -->
                            <h3 style="margin: 30px 0 15px; color: #1E1E21; font-size: 18px; border-bottom: 2px solid #FFF27A; padding-bottom: 8px;">🎯 Risk Score Analysis</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #e0e0e0;">
                                <thead>
                                    <tr style="background-color: #f8f8f8;">
                                        <th style="padding: 12px; text-align: left; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Category</th>
                                        <th style="padding: 12px; text-align: center; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Risk Level</th>
                                        <th style="padding: 12px; text-align: center; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Risk Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analyses.map((analysis, index) => {
                                        const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
                                        const riskLevel = analysis.overall_risk_level || 'unknown';
                                        const riskColor = riskLevel === 'low' ? '#10b981' : riskLevel === 'medium' ? '#f59e0b' : riskLevel === 'high' ? '#ef4444' : '#9a8cff';
                                        return `
                                        <tr style="background-color: ${bgColor};">
                                            <td style="padding: 12px; color: #333; font-size: 13px; border: 1px solid #e0e0e0; font-weight: 600;">${analysis.category_name || analysis.name}</td>
                                            <td style="padding: 12px; font-size: 13px; border: 1px solid #e0e0e0; text-align: center;">
                                                <span style="display: inline-block; padding: 4px 12px; background-color: ${riskColor}; color: white; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: capitalize;">
                                                    ${riskLevel}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; color: #333; font-size: 14px; border: 1px solid #e0e0e0; font-weight: bold; text-align: center;">${analysis.category_score}/10</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            <!-- Knowledge Graph -->
                            ${nodes.length > 0 ? `
                            <h3 style="margin: 30px 0 15px; color: #1E1E21; font-size: 18px; border-bottom: 2px solid #FFF27A; padding-bottom: 8px;">🔗 Knowledge Graph</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #e0e0e0;">
                                <thead>
                                    <tr style="background-color: #f8f8f8;">
                                        <th style="padding: 12px; text-align: left; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Entity</th>
                                        <th style="padding: 12px; text-align: left; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Type</th>
                                        <th style="padding: 12px; text-align: left; color: #1E1E21; font-size: 13px; border: 1px solid #e0e0e0;">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${nodes.slice(0, 10).map((node, index) => {
                                        const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
                                        return `
                                        <tr style="background-color: ${bgColor};">
                                            <td style="padding: 12px; color: #333; font-size: 13px; border: 1px solid #e0e0e0; font-weight: 600;">${node.name || 'N/A'}</td>
                                            <td style="padding: 12px; color: #666; font-size: 12px; border: 1px solid #e0e0e0;">${node.type || node.category || 'N/A'}</td>
                                            <td style="padding: 12px; color: #666; font-size: 12px; border: 1px solid #e0e0e0;">${(node.description || node.hover_info || 'N/A').substring(0, 100)}${((node.description || node.hover_info || '').length > 100) ? '...' : ''}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            
                            <!-- Detailed Analysis Summary -->
                            <h3 style="margin: 30px 0 15px; color: #1E1E21; font-size: 18px; border-bottom: 2px solid #FFF27A; padding-bottom: 8px;">📝 Detailed Analysis</h3>
                            ${analyses.map((analysis, index) => {
                                const riskLevel = analysis.overall_risk_level || 'unknown';
                                const riskColor = riskLevel === 'low' ? '#10b981' : riskLevel === 'medium' ? '#f59e0b' : riskLevel === 'high' ? '#ef4444' : '#9a8cff';
                                return `
                                <div style="margin-bottom: 20px; padding: 18px; background-color: #f9f9f9; border-left: 4px solid ${riskColor}; border-radius: 4px;">
                                    <div style="margin-bottom: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <h4 style="margin: 0; color: #1E1E21; font-size: 16px; font-weight: 600;">${index + 1}. ${analysis.category_name || analysis.name}</h4>
                                            <span style="padding: 4px 12px; background-color: ${riskColor}; color: white; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: capitalize;">
                                                ${riskLevel}
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                                            <strong>Risk Score:</strong> ${analysis.category_score}/10 
                                            <span style="margin-left: 12px;"><strong>Overall Score:</strong> ${analysis.overall_score}/100</span>
                                        </div>
                                    </div>
                                    <p style="margin: 0 0 12px; color: #666; font-size: 13px; line-height: 1.6;">${analysis.summary || 'No detailed analysis available.'}</p>
                                    ${(analysis.indicators && Array.isArray(analysis.indicators) && analysis.indicators.length > 0) ? `
                                        <table style="width: 100%; border-collapse: collapse; margin-top: 12px; background-color: white;">
                                            <thead>
                                                <tr style="background-color: #f0f0f0;">
                                                    <th style="padding: 8px; text-align: left; color: #1E1E21; font-size: 12px; border: 1px solid #ddd;">Indicator</th>
                                                    <th style="padding: 8px; text-align: left; color: #1E1E21; font-size: 12px; border: 1px solid #ddd;">Assessment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${analysis.indicators.slice(0, 5).map(indicator => `
                                                    <tr>
                                                        <td style="padding: 8px; color: #333; font-size: 12px; border: 1px solid #ddd; font-weight: 600; width: 35%;">${indicator.indicator_name || 'N/A'}</td>
                                                        <td style="padding: 8px; color: #666; font-size: 11px; border: 1px solid #ddd; line-height: 1.5;">${(indicator.detailed_assessment || indicator.description || 'N/A').substring(0, 200)}${((indicator.detailed_assessment || indicator.description || '').length > 200) ? '...' : ''}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                            ` : '<p style="color: #666; font-size: 14px;">No analysis data available yet.</p>'}
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #f8f8f8; padding: 25px 30px; text-align: center; border-top: 1px solid #e0e0e0;">
                            <p style="margin: 0 0 10px; color: #1E1E21; font-size: 14px; font-weight: bold;">Powered by PitchLense</p>
                            <p style="margin: 0; color: #666; font-size: 12px;">AI-driven insights for smarter investment decisions</p>
                            <p style="margin: 15px 0 0; color: #999; font-size: 11px;">This report was generated automatically and contains confidential information.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
        `;
      }
      
      // Download file function
      function downloadFile(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // Convert existing sidebar to dynamic navbar
      (function(){
        try {
          var aside = document.querySelector('aside[class*="bg-[#2C2F34]"]') || document.querySelector('aside');
          if (aside && !aside.id) { aside.id = 'pitchlense-navbar'; }
        } catch(e) {}
      })();
      
      // Share report via email
      async function shareViaEmail(recipientEmail) {
        try {
          const reportData = window.reportData || {};
          const report = reportData.report || {};
          
          const emailHTML = generateEmailHTML();
          
          const response = await fetch('/api/reports/share-email', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
              to: recipientEmail,
              subject: 'PitchLense Report: ' + (report.startup_name || 'Startup Analysis'),
              html: emailHTML
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to send email');
          }
          
          return await response.json();
        } catch (error) {
          console.error('Error sharing via email:', error);
          throw error;
        }
      }
      
      // Initialize email share button
      function initializeEmailShare() {
        const shareEmailBtn = document.getElementById('shareEmailBtn');
        
        if (shareEmailBtn) {
          shareEmailBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Close dropdown
            const shareDropdown = document.getElementById('shareDropdown');
            if (shareDropdown) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
            
            // Show SweetAlert popup to ask for email
            const { value: email } = await Swal.fire({
              title: 'Share Report via Email',
              input: 'email',
              inputLabel: 'Enter recipient email address',
              inputPlaceholder: 'recipient@example.com',
              showCancelButton: true,
              confirmButtonText: 'Send Email',
              confirmButtonColor: '#FFF27A',
              cancelButtonColor: '#6c757d',
              background: '#2E3137',
              color: '#ffffff',
              inputValidator: (value) => {
                if (!value) {
                  return 'Please enter an email address';
                }
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                  return 'Please enter a valid email address';
                }
              },
              customClass: {
                popup: 'swal-dark-popup',
                title: 'swal-dark-title',
                input: 'swal-dark-input',
                confirmButton: 'swal-dark-confirm',
                cancelButton: 'swal-dark-cancel'
              }
            });
            
            if (email) {
              // Show loading
              Swal.fire({
                title: 'Sending Email...',
                html: 'Please wait while we send the report',
                allowOutsideClick: false,
                background: '#2E3137',
                color: '#ffffff',
                didOpen: () => {
                  Swal.showLoading();
                },
                customClass: {
                  popup: 'swal-dark-popup',
                  title: 'swal-dark-title'
                }
              });
              
              try {
                await shareViaEmail(email);
                
                // Success
                Swal.fire({
                  icon: 'success',
                  title: 'Email Sent!',
                  text: `Report successfully sent to ${email}`,
                  confirmButtonColor: '#FFF27A',
                  background: '#2E3137',
                  color: '#ffffff',
                  customClass: {
                    popup: 'swal-dark-popup',
                    title: 'swal-dark-title',
                    confirmButton: 'swal-dark-confirm'
                  }
                });
              } catch (error) {
                // Error
                Swal.fire({
                  icon: 'error',
                  title: 'Failed to Send Email',
                  text: error.message || 'An error occurred while sending the email',
                  confirmButtonColor: '#FFF27A',
                  background: '#2E3137',
                  color: '#ffffff',
                  customClass: {
                    popup: 'swal-dark-popup',
                    title: 'swal-dark-title',
                    confirmButton: 'swal-dark-confirm'
                  }
                });
              }
            }
          });
        }
      }
      
      // Initialize PDF download button
      function initializePDFDownload() {
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        // Debug log
        // Debug log
        
        if (downloadPdfBtn) {
          downloadPdfBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Close dropdown
            const shareDropdown = document.getElementById('shareDropdown');
            if (shareDropdown) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
            
            // Show loading state
            const originalText = downloadPdfBtn.innerHTML;
            downloadPdfBtn.innerHTML = `
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating PDF...
            `;
            downloadPdfBtn.disabled = true;
            
            // Generate PDF
            setTimeout(async () => {
              try {
                await exportToPDF();
              } catch (error) {
                console.error('Error generating PDF:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                alert(`Error generating PDF: ${errorMessage}`);
              } finally {
                // Restore button state
                downloadPdfBtn.innerHTML = originalText;
                downloadPdfBtn.disabled = false;
              }
            }, 100);
          });
        }
      }

      // Initialize PPTX download button
      function initializePPTXDownload() {
        const downloadPptxBtn = document.getElementById('downloadPptxBtn');
        if (downloadPptxBtn) {
          downloadPptxBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Close dropdown
            const shareDropdown = document.getElementById('shareDropdown');
            if (shareDropdown) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
            
            // Show loading state
            const originalText = downloadPptxBtn.innerHTML;
            downloadPptxBtn.innerHTML = `
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating PPTX...
            `;
            downloadPptxBtn.disabled = true;
            
            // Generate PPTX
            setTimeout(async () => {
              try {
                await exportToPPTX();
              } catch (error) {
                console.error('Error generating PPTX:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                alert(`Error generating PPTX: ${errorMessage}`);
              } finally {
                // Restore button state
                downloadPptxBtn.innerHTML = originalText;
                downloadPptxBtn.disabled = false;
              }
            }, 100);
          });
        }
      }

      // Initialize share dropdown
      function initializeShareDropdown() {
        const shareButton = document.getElementById('shareButton');
        const shareDropdown = document.getElementById('shareDropdown');
        
        if (shareButton && shareDropdown) {
          // Toggle dropdown on button click
          shareButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = !shareDropdown.classList.contains('invisible');
            
            if (isVisible) {
              // Hide dropdown
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            } else {
              // Show dropdown
              shareDropdown.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!shareButton.contains(e.target) && !shareDropdown.contains(e.target)) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
          
          // Close dropdown with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !shareDropdown.classList.contains('invisible')) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
        }
      }

      // Page loader functions
      function showPageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) loader.classList.remove('hidden');
      }

      function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        const app = document.getElementById('app');
        if (loader) loader.classList.add('hidden');
        if (app) app.classList.remove('hidden');
      }

      // Get report ID from URL
      function getReportIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('report_id');
      }

      // Format date for news items
      function formatNewsDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return dateString;
        }
      }

      // Show loading state
      function showNewsLoader() {
        const loader = document.getElementById('newsLoader');
        const newsList = document.getElementById('newsList');
        if (loader) loader.classList.remove('hidden');
        if (newsList) newsList.classList.add('hidden');
      }

      // Hide loading state
      function hideNewsLoader() {
        const loader = document.getElementById('newsLoader');
        const newsList = document.getElementById('newsList');
        if (loader) loader.classList.add('hidden');
        if (newsList) newsList.classList.remove('hidden');
      }

      // Populate market share section
      function populateMarketShare(marketSizeData) {
        const marketShareContainer = document.getElementById('marketShareContainer');
        if (!marketSizeData || !Array.isArray(marketSizeData) || marketSizeData.length === 0) {
          marketShareContainer.innerHTML = '<div class="text-sm text-secondary text-center py-4">No market data available</div>';
          return;
        }

        marketShareContainer.innerHTML = marketSizeData.map((segment, index) => {
          const colors = ['#f1d85b', '#78e6d0', '#ff6b6b', '#9a8cff', '#60a5fa'];
          const color = colors[index % colors.length];
          
          return `
            <div class="mb-3 last:mb-0">
              <div class="flex items-center justify-between text-xs text-secondary mb-1">
                <span>${segment.segment}</span>
                <span>${segment.share_percent}%</span>
              </div>
              <div class="progress">
                <span style="width:${segment.share_percent}%; background-color:${color};"></span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Create radar chart
      function createRadarChart(radarData) {
        const canvas = document.getElementById('radarChart');
        if (!canvas || !radarData || !radarData.dimensions || !radarData.scores) {
          return;
        }

        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext('2d');

        // Create base connected radar chart with DCDCDD fill
        const baseDataset = {
          label: 'Risk Analysis',
          data: radarData.scores,
          backgroundColor: 'rgba(220, 220, 221, 0.3)',
          borderColor: '#DCDCDD',
          borderWidth: 2,
          pointBackgroundColor: 'transparent',
          pointBorderColor: 'transparent',
          pointBorderWidth: 0,
          pointRadius: 0
        };

        // Create color-coded datasets for individual risk points
        const colorCodedDatasets = radarData.scores.map((score, index) => {
          let color;
          if (score <= 4) {
            color = '#4ade80'; // Green
          } else if (score <= 6) {
            color = '#f1d85b'; // Yellow
          } else {
            color = '#FB5D5D'; // Red
          }
          
          return {
            label: radarData.dimensions[index],
            data: Array(radarData.dimensions.length).fill(0).map((_, i) => i === index ? score : 0),
            backgroundColor: 'transparent',
            borderColor: 'transparent',
            borderWidth: 0,
            pointBackgroundColor: color,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
          };
        });

        // Combine base and color-coded datasets
        const datasets = [baseDataset, ...colorCodedDatasets];

        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: radarData.dimensions,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: 0
            },
            animation: {
              duration: 2500,
              easing: 'easeOutQuart',
              delay: function(context) {
                if (context.type === 'data' && context.mode === 'default') {
                  return context.dataIndex * 200; // Staggered animation for each dataset
                }
                return 0;
              }
            },
            plugins: {
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255,255,255,0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.parsed.r}/${radarData.scale}`;
                  }
                }
              },
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 11
                  },
                  generateLabels: function(chart) {
                    return [
                      {
                        text: 'Risk Profile',
                        fillStyle: '#DCDCDD',
                        strokeStyle: '#DCDCDD',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 0
                      },
                      {
                        text: 'Low Risk (1-4)',
                        fillStyle: '#4ade80',
                        strokeStyle: '#4ade80',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 1
                      },
                      {
                        text: 'Medium Risk (5-6)',
                        fillStyle: '#f1d85b',
                        strokeStyle: '#f1d85b',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 2
                      },
                      {
                        text: 'High Risk (7-10)',
                        fillStyle: '#FB5D5D',
                        strokeStyle: '#FB5D5D',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 3
                      }
                    ];
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: radarData.scale,
                min: 0,
                ticks: {
                  stepSize: 2,
                  color: '#ffffff',
                  font: {
                    size: 12,
                    weight: 'bold'
                  },
                  backdropColor: 'rgba(0,0,0,0.8)',
                  backdropPadding: 4
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                },
                angleLines: {
                  color: 'rgba(255,255,255,0.1)'
                },
                pointLabels: {
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 10
                  }
                }
              }
            }
          }
        });
      }

      // Helper function to determine risk level from score
      function getOverallRiskLevel(score) {
        if (score >= 8) return 'low';
        if (score >= 6) return 'medium';
        if (score >= 4) return 'high';
        return 'critical';
      }

      // Calculate growth potential score from startup analysis data
      function calculateGrowthPotential(analyses) {
        if (!analyses) return { score: 0, breakdown: [] };
        
        // Define the weightage mapping for Overall Analysis dimensions only
        const weightageMap = {
          'Market Potential': 0.30,    // Market Risk Analysis -> Market Potential
          'Product Strength': 0.10,    // Product Risk Analysis -> Product Strength  
          'Team Quality': 0.20,        // Team Risk Analysis -> Team Quality
          'Financial Health': 0.10,    // Financial Risk Analysis -> Financial Health
          'Traction & Growth': 0.30    // Customer Risk Analysis -> Traction & Growth
        };
        
        // Map API category names to Overall Analysis dimension names
        const categoryMapping = {
          'Market Risks': 'Market Potential',
          'Product Risks': 'Product Strength',
          'Team & Founder Risks': 'Team Quality',
          'Financial Risks': 'Financial Health',
          'Customer & Traction Risks': 'Traction & Growth'
        };
        
        let totalScore = 0;
        const breakdown = [];
        
        // Convert analyses object to array and calculate weighted scores
        Object.entries(analyses).forEach(([key, analysis]) => {
          if (analysis.category_score !== undefined && analysis.category_score !== null) {
            const apiCategoryName = analysis.category_name || key;
            const dimensionName = categoryMapping[apiCategoryName];
            
            if (dimensionName && weightageMap[dimensionName]) {
              const weightage = weightageMap[dimensionName];
              
              // Convert risk score to growth potential score (inverse relationship)
              // Higher risk score (1-10) = Lower growth potential (1-10)
              // Formula: growthScore = 11 - riskScore
              const growthScore = Math.max(1, 11 - analysis.category_score);
              const weightedScore = growthScore * weightage;
              totalScore += weightedScore;
              
              breakdown.push({
                dimension: dimensionName,
                score: Math.round(growthScore * 10) / 10,
                weightage: weightage * 100,
                weightedScore: Math.round(weightedScore * 10) / 10
              });
            }
          }
        });
        
        return {
          score: Math.round(totalScore * 10) / 10,
          breakdown: breakdown
        };
      }

      // Create growth potential donut chart
      function createGrowthPotentialChart(score, maxScore = 10) {
        const canvas = document.getElementById('growthPotentialChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const percentage = (score / maxScore) * 100;
        
        // Destroy existing chart if it exists
        if (window.growthPotentialChartInstance) {
          window.growthPotentialChartInstance.destroy();
        }
        
        // Determine color based on score ranges (1-10 scale)
        let chartColor = '#FFF27A'; // Default yellow (3.5-6.5)
        if (score >= 6.5) {
          chartColor = '#10B981'; // Green for 6.5 and above
        } else if (score < 3.5) {
          chartColor = '#FB5D5D'; // Red for 1-3.5
        }
        
        window.growthPotentialChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [percentage, 100 - percentage],
              backgroundColor: [chartColor, 'rgba(255,255,255,0.1)'],
              borderWidth: 0,
              cutout: '75%'
            }]
          },
          options: {
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: false
              }
            },
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              animateRotate: true,
              duration: 1000,
              easing: 'easeOutQuart'
            }
          }
        });
        
        // Update the score display and legend color
        const scoreElement = document.getElementById('growthPotentialScore');
        const legendElement = document.getElementById('growthPotentialLegend');
        if (scoreElement) {
          scoreElement.textContent = `${score}/${maxScore}`;
        }
        if (legendElement) {
          legendElement.style.background = chartColor;
        }
      }

      // Update growth potential tooltip with dynamic data
      function updateGrowthPotentialTooltip(breakdown) {
        const tooltipContent = document.getElementById('growthPotentialTooltipContent');
        if (!tooltipContent || !breakdown || breakdown.length === 0) return;
        
        const totalScore = breakdown.reduce((sum, item) => sum + item.weightedScore, 0);
        
        // Update the tooltip content with dynamic data
        const content = `
          <div class="text-xs text-white/70 mb-2 italic">Growth Score = ∑(Dimension Score × Weightage)</div>
          ${breakdown.map(item => `
            <div class="flex justify-between">
              <span class="text-white/60">${item.dimension}</span>
              <span class="text-white">${item.score} × ${item.weightage}% = ${item.weightedScore}</span>
            </div>
          `).join('')}
          <div class="border-t border-white/10 pt-1 mt-2">
            <div class="flex justify-between font-semibold">
              <span class="text-white">Total Score</span>
              <span class="text-[#f1d85b]">${Math.round(totalScore * 10) / 10} / 10</span>
            </div>
          </div>
        `;
        
        tooltipContent.innerHTML = content;
      }

      // Initialize growth potential info button hover functionality
      function initializeGrowthPotentialInfo() {
        const infoButton = document.getElementById('growthPotentialInfo');
        const tooltip = document.getElementById('growthPotentialTooltip');
        
        if (!infoButton || !tooltip) return;
        
        infoButton.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
          tooltip.style.pointerEvents = 'auto';
        });
        
        infoButton.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
          tooltip.style.pointerEvents = 'none';
        });
      }


      // Create market value chart
      function createMarketValueChart(marketValueData) {
        const canvas = document.getElementById('marketValueChart');
        if (!canvas || !marketValueData || !Array.isArray(marketValueData) || marketValueData.length === 0) {
          return;
        }

        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext('2d');

        // Prepare data
        const years = marketValueData.map(item => item.year.toString());
        const values = marketValueData.map(item => item.value_usd_billion);
        const maxValue = Math.max(...values);
        
        // Create colors array - yellow for current year and before, DCDCDD for future years
        const currentYear = new Date().getFullYear();
        const barColors = values.map((value, index) => {
          const year = marketValueData[index].year;
          return year <= currentYear ? '#f1d85b' : '#DCDCDD';
        });

        new Chart(ctx, {
          type: 'bar',
          data: { 
            labels: years, 
            datasets: [{ 
              data: values, 
              backgroundColor: barColors, 
              borderRadius: 10, 
              borderSkipped: false 
            }]
          },
          options: {
            responsive: true, 
            maintainAspectRatio: false,
            layout: {
              padding: 0
            },
            animation: {
              duration: 2000,
              easing: 'easeOutQuart',
              delay: function(context) {
                return context.dataIndex * 100; // Staggered animation
              }
            },
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255,255,255,0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                  title: function(context) {
                    return `Year: ${context[0].label}`;
                  },
                  label: function(context) {
                    return `Market Value: $${context.parsed.y.toFixed(1)}B`;
                  }
                }
              } 
            },
            scales: {
              x: { 
                grid: { display: false }, 
                ticks: { 
                  color: 'rgba(255,255,255,0.6)',
                  maxTicksLimit: years.length,
                  font: {
                    size: 10
                  }
                },
                title: {
                  display: true,
                  text: 'Year',
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              },
              y: { 
                beginAtZero: true, 
                max: Math.ceil(maxValue * 1.1), 
                grid: { color: 'rgba(255,255,255,0.08)' }, 
                ticks: { 
                  callback: (v) => `$${v}B`, 
                  color: 'rgba(255,255,255,0.6)' 
                },
                title: {
                  display: true,
                  text: 'Market Value (USD Billion)',
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }

      // Populate news section
      function populateNews(newsData) {
        const newsList = document.getElementById('newsList');
        if (!newsData || !newsData.results || newsData.results.length === 0) {
          newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No news available</li>';
          hideNewsLoader();
          return;
        }

        // Show all news items
        const newsItems = newsData.results;
        newsList.innerHTML = newsItems.map(news => {
          // Null checks for all fields
          if (!news || !news.source) {
            return ''; // Skip invalid news items
          }
          
          const title = news.title || 'No title';
          const source = news.source?.name || 'Unknown source';
          const date = formatNewsDate(news.date);
          const sourceIcon = news.source?.icon || '📰'; // Use source icon or fallback to news icon
          const link = news.link || '#';
          
          return `
            <li class="group">
              <a href="${link}" target="_blank" rel="noopener noreferrer" class="flex items-start gap-2 text-sm hover:bg-white/5 rounded-lg p-2 transition-colors">
                <div class="w-8 h-8 grid place-items-center rounded-lg bg-white/10 overflow-hidden flex-shrink-0">
                  <img src="${sourceIcon}" alt="${source}" class="w-6 h-6 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <span class="text-xs" style="display:none;">📰</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-white group-hover:text-accent transition-colors leading-tight">${title}</div>
                  <div class="text-xs text-secondary mt-1">${source} • ${date}</div>
                </div>
                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </div>
              </a>
            </li>
          `;
        }).join('');
        
        hideNewsLoader();
      }

      // Populate documents section
      function populateDocuments(documentsData) {
        const documentsList = document.getElementById('documentsList');
        if (!documentsData || !documentsData.results || documentsData.results.length === 0) {
          documentsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No documents available</li>';
          hideDocumentsLoader();
          return;
        }

        // Show all document items
        const documentItems = documentsData.results;
        documentsList.innerHTML = documentItems.map(doc => {
          const title = doc.title;
          const link = doc.link || '#';
          const snippet = doc.snippet || '';
          const displayedLink = doc.displayed_link || link;
          const fileFormat = doc.file_format || 'PDF';
          
          return `
            <li class="group">
              <a href="${link}" target="_blank" rel="noopener noreferrer" class="flex items-start gap-2 text-sm hover:bg-white/5 rounded-lg p-2 transition-colors">
                <div class="w-8 h-8 grid place-items-center rounded-lg bg-white/10 overflow-hidden flex-shrink-0">
                  <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-white group-hover:text-accent transition-colors leading-tight">${title}</div>
                  <div class="text-xs text-secondary mt-1">${displayedLink}</div>
                  ${snippet ? `<div class="text-xs text-white/60 mt-1 line-clamp-2">${snippet}</div>` : ''}
                  <div class="flex items-center gap-2 mt-1">
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-accent/20 text-accent">${fileFormat}</span>
                  </div>
                </div>
                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </div>
              </a>
            </li>
          `;
        }).join('');
        
        hideDocumentsLoader();
      }

      // Show documents loader
      function showDocumentsLoader() {
        const loader = document.getElementById('documentsLoader');
        const documentsList = document.getElementById('documentsList');
        
        if (loader) loader.classList.remove('hidden');
        if (documentsList) documentsList.classList.add('hidden');
      }

      // Hide documents loader
      function hideDocumentsLoader() {
        const loader = document.getElementById('documentsLoader');
        const documentsList = document.getElementById('documentsList');
        
        if (loader) loader.classList.add('hidden');
        if (documentsList) documentsList.classList.remove('hidden');
      }

      // Tab switching functionality for news/documents
      function switchNewsTab(tabName) {
        const industryNewsTab = document.getElementById('industryNewsTab');
        const internetDocumentsTab = document.getElementById('internetDocumentsTab');
        const industryNewsContent = document.getElementById('industryNewsContent');
        const internetDocumentsContent = document.getElementById('internetDocumentsContent');

        if (tabName === 'news') {
          // Activate news tab
          industryNewsTab.classList.add('active');
          internetDocumentsTab.classList.remove('active');
          
          industryNewsContent.classList.remove('hidden');
          internetDocumentsContent.classList.add('hidden');
        } else if (tabName === 'documents') {
          // Activate documents tab
          internetDocumentsTab.classList.add('active');
          industryNewsTab.classList.remove('active');
          
          internetDocumentsContent.classList.remove('hidden');
          industryNewsContent.classList.add('hidden');
        }
      }

      // Fetch report data
      async function fetchReportData() {
        const reportId = getReportIdFromUrl();
        if (!reportId) {
          // Show content even without report ID
          hidePageLoader();
          return;
        }

        // Show news loader when starting API call
        showNewsLoader();

        try {
          const response = await fetch(`/api/reports/${reportId}/data`, {
            credentials: 'include'
          });

          if (response.status === 401) {
            window.location.href = '/auth.html';
            return;
          }

          if (!response.ok) {
            // Show error state
            const newsList = document.getElementById('newsList');
            if (newsList) {
              newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">Failed to load news</li>';
              hideNewsLoader();
            }
            hidePageLoader();
            return;
          }

          const result = await response.json();
          reportData = result;
          
          // Store report data globally for PDF export
          window.reportData = result;
          
          // Populate news if available
          if (result.data && result.data.news) {
            populateNews(result.data.news);
          } else {
            // No news data available
            const newsList = document.getElementById('newsList');
            if (newsList) {
              newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No news data available</li>';
              hideNewsLoader();
            }
          }

          // Populate documents if available
          if (result.data && result.data.internet_documents) {
            populateDocuments(result.data.internet_documents);
          } else {
            // No documents data available
            const documentsList = document.getElementById('documentsList');
            if (documentsList) {
              documentsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No documents data available</li>';
              hideDocumentsLoader();
            }
          }

          // Populate market share if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.market_size) {
            populateMarketShare(result.data.startup_analysis.market_size);
          } else {
            // No market share data available
            const marketShareContainer = document.getElementById('marketShareContainer');
            if (marketShareContainer) {
              marketShareContainer.innerHTML = '<div class="text-sm text-secondary text-center py-4">No market data available</div>';
            }
          }

          // Create market value chart if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.market_value) {
            createMarketValueChart(result.data.startup_analysis.market_value);
          }

          // Create radar chart if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.radar_chart) {
            createRadarChart(result.data.startup_analysis.radar_chart);
          }

          // Populate startup analysis data
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.analyses) {
            populateStartupAnalysis(result.data.startup_analysis.analyses);
            populateDetailedAnalysisTypes(result.data.startup_analysis.analyses);
            
            // Calculate and display growth potential
            const growthPotential = calculateGrowthPotential(result.data.startup_analysis.analyses);
            createGrowthPotentialChart(growthPotential.score);
            updateGrowthPotentialTooltip(growthPotential.breakdown);
            
            // Store overall score and risk level globally for PDF export
            window.overallScore = growthPotential.score;
            window.overallRiskLevel = getOverallRiskLevel(growthPotential.score);
          }

          // LinkedIn analysis will be shown only in Team & Founder Risks analysis type
          // No need to populate it in overall analysis tab

          // Populate uploaded files data
          if (result.data && result.data.files && Array.isArray(result.data.files)) {
            populateUploadedFiles(result.data.files);
          }

          
          // Hide page loader after successful data fetch
          hidePageLoader();
        } catch (error) {
          console.error('Error fetching report data:', error);
          // Show error state
          const newsList = document.getElementById('newsList');
          if (newsList) {
            newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">Error loading news</li>';
            hideNewsLoader();
          }
          hidePageLoader();
        }
      }

      // Function to populate startup analysis data
      function populateStartupAnalysis(analyses) {
        // Store analyses data globally for PDF export
        window.analyses = analyses;
        
        const analysisList = document.getElementById('startupAnalysisList');
        if (!analysisList || !analyses) {
          return;
        }

        // Clear existing content
        analysisList.innerHTML = '';

        // Define colors for different risk levels
        const getRiskColor = (riskLevel) => {
          switch (riskLevel) {
            case 'low': return '#4ade80'; // Green
            case 'medium': return '#f1d85b'; // Yellow
            case 'high': return '#ff6b6b'; // Red
            case 'critical': return '#ef4444'; // Dark red
            default: return '#9a8cff'; // Purple
          }
        };

        // Convert analyses object to array, filter out undefined ratings, and sort by category score
        const analysisArray = Object.entries(analyses)
          .map(([key, analysis]) => ({
            name: key,
            ...analysis
          }))
          .filter(analysis => analysis.category_score !== undefined && analysis.category_score !== null)
          .sort((a, b) => b.category_score - a.category_score);

        // Create list items for each analysis
        analysisArray.forEach(analysis => {
          const percentage = (analysis.category_score / 10) * 100;
          const color = getRiskColor(analysis.overall_risk_level);
          
          // Create main analysis item
          const listItem = document.createElement('li');
          listItem.className = 'py-3';
          
          // Main analysis header
          const headerDiv = document.createElement('div');
          headerDiv.className = 'flex items-center gap-3 mb-2';
          headerDiv.innerHTML = `
            <span class="relative inline-grid place-items-center w-10 h-10 rounded-full" style="background:conic-gradient(${color} 0 ${percentage}%, transparent ${percentage}% 100%);">
              <span class="w-7 h-7 rounded-full bg-[#2E3137] grid place-items-center text-xs">${analysis.category_score}</span>
            </span>
            <div class="flex-1">
              <div class="text-sm">${analysis.category_name}</div>
              <div class="text-xs text-secondary">Risk: ${analysis.overall_risk_level}</div>
            </div>
            <div class="text-right text-xs">
              <div class="text-secondary">Score</div>
              <div class="text-white">${analysis.category_score}/10</div>
            </div>
          `;
          
          listItem.appendChild(headerDiv);
          
          // Add indicators if they exist
          if (analysis.indicators && Array.isArray(analysis.indicators)) {
            const indicatorsDiv = document.createElement('div');
            indicatorsDiv.className = 'ml-13 space-y-1';
            
            analysis.indicators.forEach(indicator => {
              if (indicator.score !== undefined && indicator.score !== null) {
                const indicatorPercentage = (indicator.score / 10) * 100;
                const indicatorColor = getRiskColor(indicator.risk_level);
                
                const indicatorItem = document.createElement('div');
                indicatorItem.className = 'flex items-center gap-2 text-xs';
                indicatorItem.innerHTML = `
                  <span class="relative inline-grid place-items-center w-6 h-6 rounded-full" style="background:conic-gradient(${indicatorColor} 0 ${indicatorPercentage}%, transparent ${indicatorPercentage}% 100%);">
                    <span class="w-4 h-4 rounded-full bg-[#2E3137] grid place-items-center text-xs" style="font-size: 8px;">${indicator.score}</span>
                  </span>
                  <div class="flex-1">
                    <div class="text-xs text-white/80">${indicator.indicator}</div>
                    <div class="text-xs text-white/50">${indicator.risk_level} (${indicator.score}/10)</div>
                  </div>
                `;
                
                indicatorsDiv.appendChild(indicatorItem);
              }
            });
            
            if (indicatorsDiv.children.length > 0) {
              listItem.appendChild(indicatorsDiv);
            }
          }
          
          analysisList.appendChild(listItem);
        });
      }

      // Function to populate detailed analysis types
      function populateDetailedAnalysisTypes(analyses) {
        const analysisTypesList = document.getElementById('analysisTypesList');
        if (!analysisTypesList || !analyses) {
          return;
        }

        // Clear existing content
        analysisTypesList.innerHTML = '';

        // Convert analyses object to array and prioritize LV-Analysis
        const analysisArray = Object.entries(analyses).map(([key, analysis]) => ({
          name: key,
          ...analysis
        })).sort((a, b) => {
          // Put LV-Analysis first
          const aIsLV = a.category_name && a.category_name.toLowerCase().includes('lv-analysis');
          const bIsLV = b.category_name && b.category_name.toLowerCase().includes('lv-analysis');
          
          if (aIsLV && !bIsLV) return -1;
          if (!aIsLV && bIsLV) return 1;
          return 0; // Keep original order for non-LV analyses
        });

        // Create analysis type buttons
        analysisArray.forEach((analysis, index) => {
          const button = document.createElement('button');
          button.className = `analysis-type-btn w-full text-left px-3 py-2 rounded-lg text-sm transition-all duration-200 ${index === 0 ? 'active' : ''}`;
          button.textContent = analysis.category_name;
          button.setAttribute('data-analysis-key', analysis.name);
          
          button.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.analysis-type-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Show detailed content
            showDetailedAnalysisContent(analysis);
          });
          
          analysisTypesList.appendChild(button);
        });

        // Show first analysis by default
        if (analysisArray.length > 0) {
          showDetailedAnalysisContent(analysisArray[0]);
        }
      }


      // Function to show detailed analysis content
      function showDetailedAnalysisContent(analysis) {
        const contentArea = document.getElementById('detailedAnalysisContentArea');
        if (!contentArea) {
          return;
        }

        // Create content with animation
        contentArea.style.opacity = '0';
        contentArea.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
          // Check for LinkedIn analysis in the report data - only show for Team & Founder Risks
          const linkedinAnalysis = window.reportData?.data?.linkedin_analysis;
          let linkedinAnalysisContent = '';
          
          // Only show LinkedIn analysis for Team & Founder Risks analysis type
          const isTeamFounderRisk = analysis.category_name && 
            (analysis.category_name.toLowerCase().includes('team') || 
             analysis.category_name.toLowerCase().includes('founder') ||
             analysis.category_name.toLowerCase().includes('team & founder'));
          
          if (linkedinAnalysis && linkedinAnalysis.primary_analysis && isTeamFounderRisk) {
            const primaryAnalysis = linkedinAnalysis.primary_analysis;
            linkedinAnalysisContent = `
              <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    LinkedIn Founder Analysis
                  </h3>
                  <div class="flex items-center gap-2">
                    <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-sm rounded-full">${primaryAnalysis.overallRating}</span>
                    <span class="text-2xl font-bold text-white">${primaryAnalysis.overallScore}/100</span>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Overall Summary -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-3">Overall Summary</h4>
                    <p class="text-white/80 text-sm leading-relaxed">${primaryAnalysis.overallSummary}</p>
                  </div>
                  
                  <!-- Key Strengths -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-3">Key Strengths</h4>
                    <ul class="space-y-2">
                      ${primaryAnalysis.keyStrengths.slice(0, 3).map(strength => `
                        <li class="flex items-start gap-2 text-white/80 text-sm">
                          <svg class="w-4 h-4 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>
                          <span>${strength.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</span>
                        </li>
                      `).join('')}
                    </ul>
                  </div>
                  
                  <!-- Competency Scores -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-3">Competency Scores</h4>
                    <div class="space-y-3">
                      ${primaryAnalysis.scores.map(score => `
                        <div class="flex items-center justify-between">
                          <span class="text-white/80 text-sm">${score.competency}</span>
                          <div class="flex items-center gap-2">
                            <div class="w-20 bg-white/10 rounded-full h-2">
                              <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full" style="width: ${score.score}%"></div>
                            </div>
                            <span class="text-white font-medium text-sm">${score.score}</span>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <!-- Key Metrics -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-3">Key Metrics</h4>
                    <div class="grid grid-cols-2 gap-3">
                      ${primaryAnalysis.detailedKPIs.slice(0, 6).map(kpi => `
                        <div class="text-center">
                          <div class="text-2xl mb-1">${kpi.icon}</div>
                          <div class="text-white font-medium text-sm">${kpi.value}</div>
                          <div class="text-white/60 text-xs">${kpi.metric}</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
                
                <!-- Investment Recommendation -->
                <div class="mt-6 bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                  <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Investment Recommendation
                  </h4>
                  <p class="text-white/80 text-sm leading-relaxed">${primaryAnalysis.investmentRecommendation}</p>
                </div>
              </div>
            `;
          }
          // Debug: Log the analysis object to see its structure
          // Check if this is a detailed business note with analysis_result
          let analysisResultContent = '';
          
          // Check for LV-Analysis specifically or detailed business note
          const isLVAnalysis = analysis.category_name && analysis.category_name.toLowerCase().includes('lv-analysis');
          const hasAnalysisResult = analysis.result && analysis.result.analysis_result;
          const isDetailedBusinessNote = analysis.analysis_type === 'detailed_business_note';
          
          if ((isLVAnalysis || isDetailedBusinessNote) && hasAnalysisResult) {
            try {
              // Render the analysis_result as markdown
              const markdownContent = marked.parse(analysis.result.analysis_result);
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                  <div class="markdown-content text-white/80 leading-relaxed">
                    ${markdownContent}
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Error parsing markdown:', error);
              // Fallback to plain text if markdown parsing fails
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                  <div class="text-white/80 leading-relaxed whitespace-pre-wrap">
                    ${analysis.result.analysis_result}
                  </div>
                </div>
              `;
            }
          } else if (isLVAnalysis) {
            // Additional fallback for LV-Analysis - check other possible data structures
            // Check if the analysis result is directly in the result object
            if (analysis.result && typeof analysis.result === 'string') {
              try {
                const markdownContent = marked.parse(analysis.result);
                analysisResultContent = `
                  <div class="mb-6">
                    <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                    <div class="markdown-content text-white/80 leading-relaxed">
                      ${markdownContent}
                    </div>
                  </div>
                `;
              } catch (error) {
                analysisResultContent = `
                  <div class="mb-6">
                    <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                    <div class="text-white/80 leading-relaxed whitespace-pre-wrap">
                      ${analysis.result}
                    </div>
                  </div>
                `;
              }
            }
            // Check if there's a summary or other content we can display
            else if (analysis.summary) {
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Analysis Summary</h3>
                  <div class="text-white/80 leading-relaxed">
                    ${analysis.summary}
                  </div>
                </div>
              `;
            }
          }

          contentArea.innerHTML = `
            <div class="analysis-content">
              ${linkedinAnalysisContent}
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h2 class="text-xl font-semibold text-white mb-2">${analysis.category_name || 'Analysis'}</h2>
                  <div class="flex items-center gap-4">
                    ${analysis.overall_risk_level ? `
                      <span class="px-3 py-1 rounded-full text-xs font-medium ${getRiskLevelClass(analysis.overall_risk_level)}">
                        ${analysis.overall_risk_level.toUpperCase()} RISK
                      </span>
                    ` : ''}
                    <span class="text-sm text-white/70">Score: ${analysis.category_score || 'N/A'}/10</span>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="sourcesBtn" class="sources-btn p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" 
                          data-analysis-key="${analysis.name}" title="View Sources">
                    <svg class="w-5 h-5 text-white/70 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <circle cx="12" cy="12" r="10" stroke-width="2"/>
                      <path d="M2 12h20" stroke-width="1.5"/>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" stroke-width="1.5"/>
                    </svg>
                  </button>
                  <button id="editAnalysisBtn" class="edit-analysis-btn p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" 
                          data-analysis-key="${analysis.name}" title="Edit Analysis">
                    <svg class="w-5 h-5 text-white/70 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="mb-6">
                <h3 class="text-lg font-medium text-white mb-3">Summary</h3>
                <p class="text-white/80 leading-relaxed">${analysis.summary || 'No summary available'}</p>
              </div>
              
              ${analysisResultContent}
              
              <div class="mb-6">
                <h3 class="text-lg font-medium text-white mb-4">Risk Indicators</h3>
                <div class="space-y-4">
                  ${analysis.indicators ? analysis.indicators.map(indicator => `
                    <div class="indicator-card p-4 rounded-lg border border-white/10">
                      <div class="flex items-start justify-between mb-3">
                        <h4 class="font-medium text-white">${indicator.indicator || 'Unknown Indicator'}</h4>
                        <div class="flex items-center gap-2">
                          ${indicator.risk_level ? `
                            <span class="px-2 py-1 rounded text-xs font-medium ${getRiskLevelClass(indicator.risk_level)}">
                              ${indicator.risk_level.toUpperCase()}
                            </span>
                          ` : ''}
                          <span class="text-sm text-white/70">${indicator.score || 'N/A'}/10</span>
                        </div>
                      </div>
                      <p class="text-white/70 text-sm mb-3">${indicator.description || 'No description available'}</p>
                      <div class="recommendation p-3 bg-white/5 rounded border-l-4 border-accent">
                        <p class="text-sm text-white/80"><strong>Recommendation:</strong> ${indicator.recommendation || 'No recommendation available'}</p>
                      </div>
                    </div>
                  `).join('') : '<p class="text-white/70">No indicators available</p>'}
                </div>
              </div>
            </div>
          `;
          
          // Animate in
          contentArea.style.transition = 'all 0.3s ease-out';
          contentArea.style.opacity = '1';
          contentArea.style.transform = 'translateX(0)';
          
          // Add event listener for edit button
          const editBtn = document.getElementById('editAnalysisBtn');
          if (editBtn) {
            editBtn.addEventListener('click', () => openEditModal(analysis));
          }
          
          // Add event listener for sources button
          const sourcesBtn = document.getElementById('sourcesBtn');
          if (sourcesBtn) {
            sourcesBtn.addEventListener('click', () => showSourcesModal(analysis));
          }
        }, 150);
      }

      // Function to show sources modal
      function showSourcesModal(analysis) {
        // Get sources from the analysis or from global report data
        let sources = [];
        
        // Check if analysis has sources in its result
        if (analysis.result && analysis.result.sources) {
          sources = analysis.result.sources;
        }
        // Check if analysis has sources in startup_context (for LV-Analysis)
        else if (analysis.startup_context && analysis.startup_context.sources) {
          sources = analysis.startup_context.sources;
        }
        // Check global sources from report data
        else if (window.reportData && window.reportData.data && window.reportData.data.startup_analysis && window.reportData.data.startup_analysis.sources) {
          sources = window.reportData.data.startup_analysis.sources;
        }
        
        // Create sources modal
        const modal = document.createElement('div');
        modal.id = 'sourcesModal';
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="bg-[#1E1E21] border border-white/10 rounded-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
              <h3 class="text-xl font-semibold text-white">Sources for ${analysis.category_name || 'Analysis'}</h3>
              <button id="closeSourcesModal" class="text-white/70 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
              ${sources.length > 0 ? `
                <div class="space-y-4">
                  ${sources.map((source, index) => `
                    <div class="bg-[#2C2F34] border border-white/10 rounded-lg p-4">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0 mt-1">
                          <span class="text-[#1E1E21] font-semibold text-sm">${index + 1}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                          <h4 class="text-white font-medium mb-2">${source.title || source.name || `Source ${index + 1}`}</h4>
                          ${source.url ? `
                            <a href="${source.url}" target="_blank" rel="noopener noreferrer" 
                               class="text-accent hover:text-accent/80 transition-colors break-all">
                              ${source.url}
                            </a>
                          ` : ''}
                          ${source.description ? `
                            <p class="text-white/70 text-sm mt-2">${source.description}</p>
                          ` : ''}
                          ${source.type ? `
                            <span class="inline-block px-2 py-1 bg-white/10 text-white/70 text-xs rounded-full mt-2">
                              ${source.type}
                            </span>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div class="text-center py-8">
                  <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-white/10 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-medium text-white mb-2">No Sources Available</h3>
                  <p class="text-white/70">No sources were found for this analysis.</p>
                </div>
              `}
            </div>
          </div>
        `;
        
        // Add modal to page
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = document.getElementById('closeSourcesModal');
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
        });
        
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
        
        // Close modal with Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      }

      // Helper function to get risk level CSS class
      function getRiskLevelClass(riskLevel) {
        switch (riskLevel) {
          case 'low': return 'bg-green-500/20 text-green-400 border border-green-500/30';
          case 'medium': return 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
          case 'high': return 'bg-red-500/20 text-red-400 border border-red-500/30';
          case 'critical': return 'bg-red-600/20 text-red-300 border border-red-600/30';
          default: return 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
        }
      }

      // Global variable to store current analysis being edited
      let currentEditingAnalysis = null;

      // Function to open edit modal
      function openEditModal(analysis) {
        currentEditingAnalysis = analysis;
        const modal = document.getElementById('editAnalysisModal');
        
        // Populate form fields
        document.getElementById('editAnalysisName').value = analysis.category_name || '';
        document.getElementById('editAnalysisSummary').value = analysis.summary || '';
        
        // Handle detailed analysis content
        let analysisResult = '';
        if (analysis.result && analysis.result.analysis_result) {
          analysisResult = analysis.result.analysis_result;
        } else if (analysis.result && typeof analysis.result === 'string') {
          analysisResult = analysis.result;
        }
        document.getElementById('editAnalysisResult').value = analysisResult;
        
        // Set risk level
        document.getElementById('editRiskLevel').value = analysis.overall_risk_level || 'low';
        
        // Set scores
        document.getElementById('editCategoryScore').value = analysis.category_score || 0;
        document.getElementById('editOverallScore').value = analysis.overall_score || 0;
        
        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      // Function to close edit modal
      function closeEditModal() {
        const modal = document.getElementById('editAnalysisModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        currentEditingAnalysis = null;
      }

      // Function to save edited analysis
      async function saveEditedAnalysis() {
        if (!currentEditingAnalysis) return;

        const formData = {
          summary: document.getElementById('editAnalysisSummary').value,
          analysis_result: document.getElementById('editAnalysisResult').value,
          overall_risk_level: document.getElementById('editRiskLevel').value,
          category_score: parseFloat(document.getElementById('editCategoryScore').value) || 0,
          overall_score: parseFloat(document.getElementById('editOverallScore').value) || 0
        };

        try {
          // Show loading state
          const saveBtn = document.getElementById('saveEditAnalysis');
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saving...';
          saveBtn.disabled = true;

          // Get report ID from URL
          const reportId = window.location.search.match(/report_id=([^&]+)/)?.[1];
          if (!reportId) {
            throw new Error('Report ID not found');
          }

          // Update the analysis in the global analyses object
          if (window.analyses && window.analyses[currentEditingAnalysis.name]) {
            const analysis = window.analyses[currentEditingAnalysis.name];
            
            // Update the analysis object
            analysis.summary = formData.summary;
            analysis.overall_risk_level = formData.overall_risk_level;
            analysis.category_score = formData.category_score;
            analysis.overall_score = formData.overall_score;
            
            // Update the result object
            if (analysis.result) {
              if (typeof analysis.result === 'object') {
                analysis.result.analysis_result = formData.analysis_result;
              } else {
                analysis.result = formData.analysis_result;
              }
            } else {
              analysis.result = { analysis_result: formData.analysis_result };
            }
          }

          // Send update to backend
          const response = await fetch(`/api/reports/${reportId}/analysis/${currentEditingAnalysis.name}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(formData)
          });

          if (!response.ok) {
            throw new Error(`Failed to save analysis: ${response.statusText}`);
          }

          // Refresh the current analysis display
          showDetailedAnalysisContent(currentEditingAnalysis);
          
          // Close modal
          closeEditModal();
          
          // Show success message
          showNotification('Analysis updated successfully!', 'success');

        } catch (error) {
          console.error('Error saving analysis:', error);
          showNotification('Failed to save analysis: ' + error.message, 'error');
        } finally {
          // Reset button state
          const saveBtn = document.getElementById('saveEditAnalysis');
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }

      // Function to show notification
      function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 ${
          type === 'success' ? 'bg-green-500' : 
          type === 'error' ? 'bg-red-500' : 
          'bg-blue-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
          notification.style.opacity = '1';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          notification.style.opacity = '0';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // Global variables for file viewing
      let isFileViewMode = false;
      let currentFileData = null;
      let fileUrls = null;

      // Initialize file view toggle
      function initializeFileViewToggle() {
        const toggleButton = document.getElementById('fileViewToggle');
        const toggleThumb = document.getElementById('toggleThumb');
        const viewModeText = document.getElementById('viewModeText');

        if (toggleButton && toggleThumb && viewModeText) {
          toggleButton.addEventListener('click', async () => {
            isFileViewMode = !isFileViewMode;
            
            // Update toggle appearance
            if (isFileViewMode) {
              toggleButton.classList.remove('bg-gray-600');
              toggleButton.classList.add('bg-accent');
              toggleThumb.classList.remove('translate-x-1');
              toggleThumb.classList.add('translate-x-6');
              viewModeText.textContent = 'File View';
            } else {
              toggleButton.classList.remove('bg-accent');
              toggleButton.classList.add('bg-gray-600');
              toggleThumb.classList.remove('translate-x-6');
              toggleThumb.classList.add('translate-x-1');
              viewModeText.textContent = 'Content View';
            }

            // Refresh current file display
            if (currentFileData) {
              await showUploadedFileContent(currentFileData);
            }
          });
        }
      }

      // Function to fetch file URLs for current report
      async function fetchFileUrls() {
        try {
          const reportId = window.location.search.match(/report_id=([^&]+)/)?.[1];
          if (!reportId) return null;

          const response = await fetch(`/api/reports/${reportId}/uploads`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to fetch file URLs');
          }

          const data = await response.json();
          return data.files;
        } catch (error) {
          console.error('Error fetching file URLs:', error);
          return null;
        }
      }

      // Function to render file viewer based on file type
      function renderFileViewer(file) {
        const extension = file.filename.split('.').pop()?.toLowerCase();
        
        if (!file.public_url) {
          return `
            <div class="flex items-center justify-center h-full">
              <div class="text-center">
                <p class="text-red-400 mb-2">Unable to load file</p>
                <p class="text-white/60 text-sm">${file.error || 'File URL not available'}</p>
              </div>
            </div>
          `;
        }

        switch (extension) {
          case 'pdf':
            return `
              <div class="h-full flex flex-col gap-4">
                <div class="flex gap-2 justify-center p-4 bg-white/5 rounded-lg">
                  <a href="${file.public_url}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-accent text-[#1E1E21] rounded-lg text-sm font-medium hover:opacity-90 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Open PDF
                  </a>
                  <button onclick="downloadFile('${file.public_url}', '${file.filename}')" class="px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-medium hover:bg-white/20 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download
                  </button>
                </div>
                <div class="flex-1 bg-white/5 rounded-lg p-4 overflow-hidden">
                  <object 
                    data="${file.public_url}" 
                    type="application/pdf"
                    class="w-full h-full rounded-lg"
                    title="${file.filename}">
                    <div class="h-full flex items-center justify-center">
                      <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-white/40">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                          <polyline points="14 2 14 8 20 8"></polyline>
                          <line x1="16" y1="13" x2="8" y2="13"></line>
                          <line x1="16" y1="17" x2="8" y2="17"></line>
                          <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <div class="text-white/80 mb-2 font-medium">${file.filename}</div>
                        <div class="text-white/60 text-sm mb-4">Browser does not support inline PDF viewing</div>
                        <div class="text-white/50 text-xs">Use the buttons above to open or download the PDF</div>
                      </div>
                    </div>
                  </object>
                </div>
              </div>
            `;
          
          case 'png':
          case 'jpg':
          case 'jpeg':
          case 'gif':
          case 'webp':
            return `
              <div class="flex items-center justify-center h-full">
                <img 
                  src="${file.public_url}" 
                  alt="${file.filename}"
                  class="max-w-full max-h-full object-contain rounded-lg"
                />
              </div>
            `;
          
          case 'pptx':
          case 'docx':
          case 'doc':
          case 'ppt':
            return `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-accent mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-white mb-2">${file.filename}</h3>
                  <p class="text-white/60 mb-4">This file type cannot be previewed directly in the browser.</p>
                  <a 
                    href="${file.public_url}" 
                    target="_blank" 
                    class="inline-flex items-center px-4 py-2 bg-accent text-black rounded-lg font-medium hover:bg-accent/90 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download & Open
                  </a>
                </div>
              </div>
            `;
          
          default:
            return `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-accent mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-white mb-2">${file.filename}</h3>
                  <p class="text-white/60 mb-4">File preview not available for this file type.</p>
                  <a 
                    href="${file.public_url}" 
                    target="_blank" 
                    class="inline-flex items-center px-4 py-2 bg-accent text-black rounded-lg font-medium hover:bg-accent/90 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download File
                  </a>
                </div>
              </div>
            `;
        }
      }

      // Function to populate uploaded files list
      function populateUploadedFiles(files) {
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        if (!uploadedFilesList || !files || !Array.isArray(files)) {
          return;
        }

        // Clear existing content
        uploadedFilesList.innerHTML = '';

        // Check if files array is empty
        if (files.length === 0) {
          uploadedFilesList.innerHTML = '<p class="text-white/60 text-sm">No files uploaded yet</p>';
          return;
        }

        // Create file buttons
        files.forEach((file, index) => {
          const button = document.createElement('button');
          button.className = `file-btn w-full text-left px-3 py-2 rounded-lg text-sm transition-all duration-200 ${index === 0 ? 'active' : ''}`;
          button.textContent = file.filename;
          button.setAttribute('data-file-index', index);
          
          button.addEventListener('click', async () => {
            // Remove active class from all buttons
            document.querySelectorAll('.file-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Show file content
            await showUploadedFileContent(file);
          });
          
          uploadedFilesList.appendChild(button);
        });

        // Show first file by default
        if (files.length > 0) {
          showUploadedFileContent(files[0]).catch(console.error);
        } else {
          // Show empty state message
          const contentArea = document.getElementById('uploadedFileContentArea');
          if (contentArea) {
            contentArea.innerHTML = `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <p class="text-white/60 text-lg mb-2">No files uploaded</p>
                  <p class="text-white/40 text-sm">Upload files to view their content here</p>
                </div>
              </div>
            `;
          }
        }
      }

      // Function to show uploaded file content
      async function showUploadedFileContent(file) {
        const contentArea = document.getElementById('uploadedFileContentArea');
        if (!contentArea) {
          return;
        }

        // Store current file data
        currentFileData = file;

        // Create content with animation
        contentArea.style.opacity = '0';
        contentArea.style.transform = 'translateX(20px)';
        
        setTimeout(async () => {
          let contentHtml = '';

          if (isFileViewMode) {
            // File view mode - show actual file
            if (!fileUrls) {
              fileUrls = await fetchFileUrls();
            }

            // Find the matching file URL data
            const fileUrlData = fileUrls?.find(f => f.filename === file.filename);
            
            if (fileUrlData) {
              contentHtml = `
                <div class="file-viewer h-full">
                  <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <div>
                      <h2 class="text-xl font-semibold text-white mb-2">${file.filename}</h2>
                      <div class="flex items-center gap-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">
                          ${file.filetype.toUpperCase()}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-500/20 text-gray-400 border border-gray-500/30">
                          ${file.file_extension.toUpperCase()}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="flex-1 overflow-hidden">
                    ${renderFileViewer({ ...file, public_url: fileUrlData.public_url, error: fileUrlData.error })}
                  </div>
                </div>
              `;
            } else {
              contentHtml = `
                <div class="flex items-center justify-center h-full">
                  <div class="text-center">
                    <p class="text-red-400 mb-2">File not found</p>
                    <p class="text-white/60 text-sm">Unable to retrieve file URL</p>
                  </div>
                </div>
              `;
            }
          } else {
            // Content view mode - show file content as before
            contentHtml = `
              <div class="file-content">
                <div class="flex items-center justify-between mb-6">
                  <div>
                    <h2 class="text-xl font-semibold text-white mb-2">${file.filename}</h2>
                    <div class="flex items-center gap-4">
                      <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">
                        ${file.filetype.toUpperCase()}
                      </span>
                      <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-500/20 text-gray-400 border border-gray-500/30">
                        ${file.file_extension.toUpperCase()}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-3">File Content</h3>
                  <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-white/80 leading-relaxed whitespace-pre-wrap">${file.content}</div>
                  </div>
                </div>
              </div>
            `;
          }

          contentArea.innerHTML = contentHtml;
          
          // Animate in
          contentArea.style.transition = 'all 0.3s ease-out';
          contentArea.style.opacity = '1';
          contentArea.style.transform = 'translateX(0)';
        }, 150);
      }

      // Initialize page
      // Chat functionality
      function initializeChat() {
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        function addMessage(message, isUser = false) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
          
          if (isUser) {
            messageDiv.innerHTML = `
              <div class="bg-accent text-black rounded-lg p-3 max-w-[80%]">
                <p class="text-sm">${message}</p>
              </div>
              <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
                </svg>
              </div>
            `;
          } else {
            // Render markdown for AI responses
            const htmlContent = marked.parse(message);
            messageDiv.innerHTML = `
              <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                <img src="/static/logo.svg" alt="PitchLense" class="w-5 h-5" onError="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: none;">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%] prose prose-invert prose-sm max-w-none">
                <div class="text-sm text-white markdown-content">${htmlContent}</div>
              </div>
            `;
          }
          
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
          const message = chatInput.value.trim();
          if (!message) return;
          // Add user message
          addMessage(message, true);
          chatInput.value = '';

          // Show loading indicator
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'flex items-start gap-3';
          loadingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
              <img src="/static/logo.svg" alt="PitchLense" class="w-5 h-5" onError="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: none;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%]">
              <div class="flex items-center gap-2">
                <span class="text-sm text-white/70">Generating answer</span>
                <div class="flex gap-1">
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce"></div>
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
              </div>
            </div>
          `;
          chatMessages.appendChild(loadingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          try {
            // Get report ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report_id');
            
            if (!reportId) {
              throw new Error('Report ID not found');
            }

            // Call the Co-pilot API
            const response = await fetch('/api/qna/ask', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'include',
              body: JSON.stringify({
                report_id: reportId,
                question: message
              })
            });

            // Remove loading indicator if it still exists
            if (loadingDiv && loadingDiv.parentNode) {
              chatMessages.removeChild(loadingDiv);
            }

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Failed to get response');
            }

            const data = await response.json();
            addMessage(data.response);

          } catch (error) {
            // Remove loading indicator if it still exists
            if (loadingDiv && loadingDiv.parentNode) {
              chatMessages.removeChild(loadingDiv);
            }
            addMessage(`Sorry, I encountered an error: ${error.message}`);
          }
        }

        // Load chat history
        async function loadChatHistory() {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report_id');
            
            if (!reportId) return;

            const response = await fetch(`/api/qna/history/${reportId}`, {
              credentials: 'include'
            });

            if (response.ok) {
              const data = await response.json();
              if (data.success && data.chats.length > 0) {
                // Clear existing messages except the welcome message
                const welcomeMessage = chatMessages.querySelector('.flex.items-start.gap-3');
                chatMessages.innerHTML = '';
                if (welcomeMessage) {
                  chatMessages.appendChild(welcomeMessage);
                }

                // Add chat history
                data.chats.forEach(chat => {
                  addMessage(chat.user_message, true);
                  addMessage(chat.ai_response, false);
                });
              }
            }
          } catch (error) {
            console.error('Failed to load chat history:', error);
          }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });

        // Load chat history when Co-pilot tab is opened
        const qnaTab = document.getElementById('qnaTab');
        if (qnaTab) {
          qnaTab.addEventListener('click', loadChatHistory);
        }

        // Initialize knowledge graph when Dependency tab is opened
        const dependencyTab = document.getElementById('dependencyTab');
        if (dependencyTab) {
          dependencyTab.addEventListener('click', () => {
            // Wait a bit for any pending data loading, then initialize
            setTimeout(() => {
              initializeKnowledgeGraph();
            }, 200);
          });
        }
      }

      // Knowledge Graph Visualization
      function initializeKnowledgeGraph() {
        const container = document.getElementById('knowledgeGraph');
        if (!container) return;

        // Clear any existing content
        container.innerHTML = '';

        // Remove any existing knowledge graph tooltips to prevent duplicates
        hideKnowledgeGraphTooltip();

        // Set up SVG dimensions - use full container width
        const width = container.clientWidth || 800;
        const height = container.clientHeight || 600;

        // Create SVG that fills the container
        const svg = d3.select('#knowledgeGraph')
          .append('svg')
          .attr('width', '100%')
          .attr('height', '100%')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .attr('preserveAspectRatio', 'xMidYMid meet')
          .style('display', 'block');

        // Create tooltip div - ensure only one exists
        let tooltip = d3.select('.knowledge-graph-tooltip');
        if (tooltip.empty()) {
          tooltip = d3.select('body')
            .append('div')
            .attr('class', 'knowledge-graph-tooltip')
            .style('position', 'fixed') // Changed to fixed for better positioning
            .style('background-color', '#2E3137')
            .style('color', '#ffffff')
            .style('padding', '12px')
            .style('border-radius', '8px')
            .style('border', '1px solid #f1d85b')
            .style('font-size', '12px')
            .style('pointer-events', 'auto') // Allow interaction with tooltip
            .style('opacity', 0)
            .style('z-index', 1000)
            .style('max-width', '600px') // Limit width (2x increase)
            .style('word-wrap', 'break-word') // Handle long text
            .style('box-shadow', '0 4px 12px rgba(0, 0, 0, 0.3)'); // Add shadow for better visibility
        } else {
          // Reset existing tooltip state
          tooltip.style('opacity', 0);
        }

        // Tooltip state management
        let tooltipTimeout;
        let tooltipVisible = false;

        // Add mouse leave handler to the container to hide tooltip when leaving graph area
        d3.select('#knowledgeGraph').on('mouseleave', function() {
          // Hide tooltip when mouse leaves the knowledge graph container
          if (tooltipVisible) {
            tooltip.style('opacity', 0);
            tooltipVisible = false;
          }
          // Clear any pending timeouts
          if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
            tooltipTimeout = null;
          }
          if (globalTooltipTimeout) {
            clearTimeout(globalTooltipTimeout);
            globalTooltipTimeout = null;
          }
        });

        // Zoom behavior
        const zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on('zoom', function(event) {
            g.attr('transform', event.transform);
          });

        svg.call(zoom);

        // Main group for all elements
        const g = svg.append('g');

        // Use actual API data or fallback to sample data
        let apiKnowledgeGraph = window.reportData?.data?.knowledge_graph;

        // Transform API data to proper format for D3.js
        let knowledgeGraph;

        // Check if we have valid data right away
        if (apiKnowledgeGraph && apiKnowledgeGraph.nodes && apiKnowledgeGraph.nodes.length > 0) {
          processApiData();
        } else if (apiKnowledgeGraph && apiKnowledgeGraph.root) {
          processApiData();
        } else if (apiKnowledgeGraph && (apiKnowledgeGraph.dependencies || apiKnowledgeGraph.dependents)) {
          processApiData();
        } else {
          // Wait for data if it's not available yet
          function waitForData(attempt = 0) {
            const maxAttempts = 5;
            const delayMs = 300;

            // Re-fetch the data in case it loaded while we were waiting
            apiKnowledgeGraph = window.reportData?.data?.knowledge_graph;

            if (apiKnowledgeGraph && apiKnowledgeGraph.nodes && apiKnowledgeGraph.nodes.length > 0) {
              processApiData();
            } else if (apiKnowledgeGraph && apiKnowledgeGraph.root) {
              processApiData();
            } else if (apiKnowledgeGraph && (apiKnowledgeGraph.dependencies || apiKnowledgeGraph.dependents)) {
              processApiData();
            } else if (attempt < maxAttempts && window.reportData) {
              setTimeout(() => waitForData(attempt + 1), delayMs);
            } else {
              // Force show the data if it exists but condition failed
              const finalCheckGraph = window.reportData?.data?.knowledge_graph;
              if (finalCheckGraph) {
                apiKnowledgeGraph = finalCheckGraph;
                processApiData();
                return;
              }

              showFallback();
            }
          }

          waitForData();
        }

        // Variables no longer needed since we removed position logic

        function processApiData() {
          // Transform API data structure to D3.js format with proper positioning
          // Handle both old format (nodes/edges) and new format (root/dependencies/dependents)

          let nodes = [];
          let edges = [];

          // Check if it's the new format with root/dependencies/dependents
          if (apiKnowledgeGraph.root && (apiKnowledgeGraph.dependencies || apiKnowledgeGraph.dependents)) {
            console.log('Processing new format knowledge graph');
            
            // Add root node
            nodes.push({
              id: apiKnowledgeGraph.root.name || 'root',
              name: apiKnowledgeGraph.root.name || 'Company',
              type: apiKnowledgeGraph.root.type || 'company',
              description: apiKnowledgeGraph.root.description || '',
              category: apiKnowledgeGraph.root.type || 'company',
              position: { x: 0, y: 0 },
              isRoot: true,
              news: [],
              market_data: {},
              relationship: ''
            });

            // Process dependencies (left side)
            if (apiKnowledgeGraph.dependencies && Array.isArray(apiKnowledgeGraph.dependencies)) {
              apiKnowledgeGraph.dependencies.forEach((dep, index) => {
                const nodeId = dep.entity_name || `dep_${index}`;
                nodes.push({
                  id: nodeId,
                  name: dep.entity_name || `Dependency ${index + 1}`,
                  type: dep.entity_type || 'dependency',
                  description: dep.relationship || '',
                  category: dep.entity_type || 'dependency',
                  position: { x: -1, y: (index - apiKnowledgeGraph.dependencies.length / 2) * 0.3 },
                  isRoot: false,
                  news: dep.news || [],
                  market_data: {
                    stock_data: dep.stock_data,
                    trade_data: dep.trade_data,
                    market_info: dep.market_info,
                    market_sources: dep.market_sources
                  },
                  relationship: dep.relationship || '',
                  hover_info: dep.market_info || dep.relationship || ''
                });

                // Create edge from dependency to root
                edges.push({
                  source: nodeId,
                  target: apiKnowledgeGraph.root.name || 'root',
                  relationship: dep.relationship || 'dependency',
                  strength: 0.7
                });
              });
            }

            // Process dependents (right side)
            if (apiKnowledgeGraph.dependents && Array.isArray(apiKnowledgeGraph.dependents)) {
              apiKnowledgeGraph.dependents.forEach((dep, index) => {
                const nodeId = dep.entity_name || `dependent_${index}`;
                nodes.push({
                  id: nodeId,
                  name: dep.entity_name || `Dependent ${index + 1}`,
                  type: dep.entity_type || 'dependent',
                  description: dep.relationship || '',
                  category: dep.entity_type || 'dependent',
                  position: { x: 1, y: (index - apiKnowledgeGraph.dependents.length / 2) * 0.3 },
                  isRoot: false,
                  news: dep.news || [],
                  market_data: {
                    stock_data: dep.stock_data,
                    trade_data: dep.trade_data,
                    market_info: dep.market_info,
                    market_sources: dep.market_sources
                  },
                  relationship: dep.relationship || '',
                  hover_info: dep.market_info || dep.relationship || ''
                });

                // Create edge from root to dependent
                edges.push({
                  source: apiKnowledgeGraph.root.name || 'root',
                  target: nodeId,
                  relationship: dep.relationship || 'dependent',
                  strength: 0.7
                });
              });
            }

          } else if (apiKnowledgeGraph.nodes && apiKnowledgeGraph.edges) {
            // Handle old format with nodes and edges
            console.log('Processing old format knowledge graph');
            
            nodes = [
              // Add root node if it exists
              ...(apiKnowledgeGraph.root ? [{
                id: apiKnowledgeGraph.root.id,
                name: apiKnowledgeGraph.root.name,
                type: apiKnowledgeGraph.root.type,
                description: apiKnowledgeGraph.root.description,
                category: apiKnowledgeGraph.root.type,
                position: apiKnowledgeGraph.root.position || { x: 0, y: 0 },
                isRoot: true,
                news: [],
                market_data: {},
                relationship: ''
              }] : []),
              // Add all nodes from API
              ...(apiKnowledgeGraph.nodes || []).map(node => {
                // Skip invalid nodes
                if (!node || !node.id || !node.name) {
                  return null;
                }
                
                const pos = node.position || { x: 0, y: 0 };
                return {
                  id: node.id,
                  name: node.name,
                  type: node.type || 'unknown',
                  category: node.category || node.type || 'unknown',
                  description: node.description || '',
                  position: pos,
                  isRoot: false,
                  relationship: node.relationship || '',
                  news: node.news || [],
                  market_data: node.market_data || {},
                  hover_info: node.hover_info || ''
                };
              }).filter(Boolean) // Remove null entries
            ];

            edges = apiKnowledgeGraph.edges ? apiKnowledgeGraph.edges.map(edge => ({
              source: edge.from,
              target: edge.to,
              relationship: edge.relationship,
              strength: edge.strength || 0.5
            })) : [];
          } else {
            console.error('Unknown knowledge graph format:', apiKnowledgeGraph);
            showFallback();
            return;
          }

          knowledgeGraph = {
            nodes: nodes,
            edges: edges
          };

          console.log('Processed knowledge graph:', knowledgeGraph);
          console.log('Total nodes:', knowledgeGraph.nodes.length);
          console.log('Total edges:', knowledgeGraph.edges.length);
          
          // Log metadata if available
          if (apiKnowledgeGraph.metadata) {
            console.log('Graph metadata:', apiKnowledgeGraph.metadata);
          }
          
          // Add a summary display for large graphs
          if (knowledgeGraph.nodes.length > 10) {
            const summary = document.createElement('div');
            summary.className = 'absolute top-4 right-4 bg-[#1E1E21] border border-white/10 rounded-lg p-3 text-white text-sm';
            summary.innerHTML = `
              <div class="font-semibold mb-1">Ecosystem Overview</div>
              <div>Nodes: ${knowledgeGraph.nodes.length}</div>
              <div>Connections: ${knowledgeGraph.edges.length}</div>
              ${apiKnowledgeGraph.metadata ? `<div>Dependencies: ${apiKnowledgeGraph.metadata.total_dependencies || 0}</div>` : ''}
              ${apiKnowledgeGraph.metadata ? `<div>Dependents: ${apiKnowledgeGraph.metadata.total_dependents || 0}</div>` : ''}
            `;
            document.getElementById('knowledgeGraph').appendChild(summary);
          }
          
          // Now that we have the data, continue with visualization
          continueWithVisualization();
        }

        function showFallback() {
          // Show fallback message if no data
          const container = document.getElementById('knowledgeGraph');
          if (container) {
            container.innerHTML = `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="w-24 h-24 mx-auto mb-6 bg-[#2E3137] rounded-full flex items-center justify-center">
                  <svg class="w-12 h-12 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">No Knowledge Graph Data</h3>
                <p class="text-white/60 max-w-md">
                  Knowledge graph data will be available once the system processes dependency relationships and generates the visualization.
                </p>
              </div>
            `;
          }
          return;
        }

        function continueWithVisualization() {
          // Get container dimensions for centering
          const container = document.getElementById('knowledgeGraph');
          const containerWidth = container ? container.clientWidth : width;
          const containerHeight = container ? container.clientHeight : height;
          const centerX = containerWidth / 2;
          const centerY = containerHeight / 2;

          // Safety checks
          if (!knowledgeGraph || !knowledgeGraph.nodes || !knowledgeGraph.edges) {
            console.error('Knowledge graph data is missing or malformed:', knowledgeGraph);
            showFallback();
            return;
          }

          // Color function based on position: root=yellow, left=blue, right=green
          function getNodeColor(node) {
            // Check if it's the root node
            if (node.isRoot || node.name === 'Sia' || node.type === 'company') {
              return '#f1d85b'; // Yellow for root node
            }
            
            const pos = node.position || { x: 0, y: 0 };
            if (pos.x < 0) {
              return '#3B82F6'; // Blue for left side (dependencies)
            } else if (pos.x > 0) {
              return '#10B981'; // Green for right side (dependents)
            } else {
              return '#8B5CF6'; // Purple for center/neutral
            }
          }

          // Declare simulation variable first so drag handlers can access it
          let simulation;

          // Drag functions - define before using them
          function dragstarted(event, d) {
            if (!d) {
              console.error('Drag started with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            if (simulation && !event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            if (!d) {
              console.error('Drag with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!d) {
              console.error('Drag ended with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            if (simulation && !event.active) simulation.alphaTarget(0);
            // Don't completely free the node, allow some movement but maintain general position
            d.fx = null;
            d.fy = null;
          }

          // Draw edges
          const link = g.selectAll('.link')
            .data(knowledgeGraph.edges)
            .enter()
            .append('line')
            .attr('class', 'link')
            .attr('stroke', '#ffffff')
            .attr('stroke-width', d => (d.strength || 0.5) * 3)
            .attr('stroke-opacity', 0.6)
            .style('pointer-events', 'none'); // Prevent hover events on edges

          // Draw nodes
          const node = g.selectAll('.node')
            .data(knowledgeGraph.nodes)
            .enter()
            .append('g')
            .attr('class', 'node')
            .style('cursor', 'pointer');

          // Node circles - adjust size based on node type
          const nodeCircles = node.append('circle')
            .attr('r', d => d.isRoot ? 25 : 18) // Larger root node, smaller others
            .attr('fill', d => getNodeColor(d))
            .attr('stroke', '#ffffff')
            .attr('stroke-width', d => d.isRoot ? 3 : 2)
            // Drag only when interacting with the actual circle, not labels/space
            .call(d3.drag()
              .on('start', dragstarted)
              .on('drag', dragged)
              .on('end', dragended)
            );

          // Node labels - adjust positioning for better readability
          node.append('text')
            .attr('dx', 0)
            .attr('dy', d => d.isRoot ? 40 : 35)
            .attr('text-anchor', 'middle')
            .attr('fill', '#ffffff')
            .attr('font-size', d => d.isRoot ? '12px' : '10px')
            .attr('font-weight', 'bold')
            .style('pointer-events', 'none') // prevent text from triggering hover/drag
            .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name); // Truncate long names

          // Position nodes based on coordinate signs - left/right of root
          const rootNode = knowledgeGraph.nodes.find(n => n.isRoot || n.name === 'Sia' || n.type === 'company');
          
          // Set initial positions based on x coordinate sign
          knowledgeGraph.nodes.forEach(node => {
            const pos = node.position || { x: 0, y: 0 };
            
            if (node === rootNode || node.isRoot) {
              // Keep root node at center (fully fixed)
              node.x = centerX;
              node.fx = centerX;
              node.y = centerY;
              node.fy = centerY;
            } else {
              // Position based on x coordinate sign; fix X, free Y to allow natural spreading
              const offsetX = Math.abs(pos.x) > 0.5 ? 300 : 250;
              const offsetY = pos.y * 100;
              
              if (pos.x < 0) {
                node.x = centerX - offsetX;
                node.fx = centerX - offsetX;
              } else if (pos.x > 0) {
                node.x = centerX + offsetX;
                node.fx = centerX + offsetX;
              } else {
                node.x = centerX;
                node.fx = centerX;
              }
              
              node.y = centerY + offsetY;
              node.fy = null; // Let simulation adjust Y to avoid overlap
            }
          });

          // Create a gentler force simulation that respects fixed positioning and reduces initial drift
          simulation = d3.forceSimulation(knowledgeGraph.nodes)
            .force('link', d3.forceLink(knowledgeGraph.edges)
              .id(d => d.id)
              .distance(180)
              .strength(0.6)
            )
            .force('charge', d3.forceManyBody().strength(-80))
            .force('collision', d3.forceCollide().radius(40))
            .alpha(0.3)
            .alphaDecay(0.06)

          // Run a few synchronous ticks to get a stable initial layout before first paint
          try {
            for (let i = 0; i < 60; i++) simulation.tick();
          } catch (_) {}

          // Apply one-time position update immediately
          link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

          node.attr('transform', d => `translate(${d.x},${d.y})`);

          // Zoom-to-fit immediately after initial ticks
          (function zoomToFitInitial(){
            const bounds = g.node().getBBox();
            const fullWidth = containerWidth;
            const fullHeight = containerHeight;
            const width = bounds.width;
            const height = bounds.height;
            if (width === 0 || height === 0) return;
            const midX = bounds.x + width / 2;
            const midY = bounds.y + height / 2;
            const scale = 0.9 / Math.max(width / fullWidth, height / fullHeight);
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
            zoom.transform(svg, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
          })();

          if (simulation) {
            simulation.on('tick', () => {
              link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

              node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
          }

          // Mouse events - only on circles, not edges or empty space
          nodeCircles.on('mouseenter', function(event, d) {
            if (!d) {
              console.error('Mouseover with undefined node');
              return;
            }
            
            // Clear any existing timeout
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            if (globalTooltipTimeout) {
              clearTimeout(globalTooltipTimeout);
              globalTooltipTimeout = null;
            }
            
            // Highlight the circle
            d3.select(this)
              .attr('stroke-width', 4)
              .attr('stroke', '#f1d85b');

            // Show tooltip with metadata
            let tooltipContent = `
              <div style="max-width: 560px; word-wrap: break-word; line-height: 1.4;">
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #ffffff;">${d.name}</div>
                <div style="font-size: 12px; margin-bottom: 8px; color: #e5e5e5;">${d.hover_info || d.description || 'No description available'}</div>
                ${d.relationship ? `<div style="font-size: 12px; color: #f1d85b; margin-bottom: 8px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><strong>Relationship:</strong><br/>${d.relationship}</div>` : ''}
                ${d.news && d.news.length > 0 ? `
                  <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                    <div style="font-weight: bold; color: #f1d85b; margin-bottom: 4px; font-size: 12px;">Recent News:</div>
                    ${d.news.slice(0, 3).map(news => `
                      <div style="font-size: 11px; margin-bottom: 4px;">
                        <a href="${news.link}" target="_blank" style="color: #60a5fa; text-decoration: underline;">${news.title}</a>
                        <div style="color: #9ca3af; font-size: 10px;">${news.source} - ${news.date}</div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${d.market_data ? `
                  <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                    <div style="font-weight: bold; color: #f1d85b; margin-bottom: 4px; font-size: 12px;">Market Data:</div>
                    ${d.market_data.stock_ticker ? `<div style="font-size: 12px; margin-bottom: 2px;">Ticker: ${d.market_data.stock_ticker}</div>` : ''}
                    ${d.market_data.stock_price ? `<div style="font-size: 12px; margin-bottom: 2px;">Price: ${d.market_data.stock_price}</div>` : ''}
                    ${d.market_data.market_info ? `
                      <div style="max-height: 150px; overflow-y: auto; margin-top: 4px; padding-right: 8px;">
                        <div class="markdown-content" style="font-size: 11px; line-height: 1.3;">${typeof marked !== 'undefined' ? marked.parse(d.market_data.market_info) : d.market_data.market_info}</div>
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            `;

            // Set content first, then position
            tooltip.html(tooltipContent);
            
            // Use setTimeout to ensure content is rendered before measuring
            setTimeout(() => {
              const tooltipRect = tooltip.node().getBoundingClientRect();
              const viewportWidth = window.innerWidth;
              const viewportHeight = window.innerHeight;
              
              // Calculate initial position (prefer top-left of cursor)
              let left = event.clientX + 15;
              let top = event.clientY - 15;
              
              // Adjust if tooltip would go off the right edge
              if (left + tooltipRect.width > viewportWidth - 20) {
                left = event.clientX - tooltipRect.width - 15;
              }
              
              // Adjust if tooltip would go off the bottom edge
              if (top + tooltipRect.height > viewportHeight - 20) {
                top = event.clientY - tooltipRect.height - 15;
              }
              
              // Ensure tooltip doesn't go off the top or left edges
              left = Math.max(10, left);
              top = Math.max(10, top);
              
              // Apply positioning and show tooltip
              tooltip
                .style('left', left + 'px')
                .style('top', top + 'px')
                .style('opacity', 1);
                
              tooltipVisible = true;
            }, 0);
          })
          .on('mouseleave', function() {
            // Remove highlight from circle
            d3.select(this)
              .attr('stroke-width', 2)
              .attr('stroke', '#ffffff');

            // Clear any existing timeout
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            if (globalTooltipTimeout) {
              clearTimeout(globalTooltipTimeout);
              globalTooltipTimeout = null;
            }

            // Set timeout to hide tooltip with delay
            tooltipTimeout = setTimeout(() => {
              if (tooltipVisible) {
                tooltip.style('opacity', 0);
                tooltipVisible = false;
              }
            }, 200); // 200ms delay before hiding
          });

          // Tooltip event handlers for hover interaction
          tooltip.on('mouseenter', function() {
            // Clear any pending timeout when hovering over tooltip
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            if (globalTooltipTimeout) {
              clearTimeout(globalTooltipTimeout);
              globalTooltipTimeout = null;
            }
            tooltip.style('opacity', 1);
            tooltipVisible = true;
          });

          tooltip.on('mouseleave', function() {
            // Hide tooltip when mouse leaves tooltip
            tooltip.style('opacity', 0);
            tooltipVisible = false;
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            if (globalTooltipTimeout) {
              clearTimeout(globalTooltipTimeout);
              globalTooltipTimeout = null;
            }
          });

          // Global cleanup: hide tooltip when cursor leaves graph area or on scroll/click outside
          function isInsideGraph(target) {
            const graphEl = document.getElementById('knowledgeGraph');
            if (!graphEl) return false;
            return graphEl.contains(target) || (tooltip.node() && tooltip.node().contains(target));
          }

          const outsideHideHandler = (e) => {
            if (!isInsideGraph(e.target)) {
              tooltip.style('opacity', 0);
              tooltipVisible = false;
              if (tooltipTimeout) { clearTimeout(tooltipTimeout); tooltipTimeout = null; }
              if (globalTooltipTimeout) { clearTimeout(globalTooltipTimeout); globalTooltipTimeout = null; }
            }
          };

          document.addEventListener('mousemove', outsideHideHandler, { passive: true });
          document.addEventListener('scroll', outsideHideHandler, { passive: true });
          document.addEventListener('click', outsideHideHandler, { passive: true });
          window.addEventListener('blur', () => { tooltip.style('opacity', 0); tooltipVisible = false; }, { passive: true });

          // Zoom controls
          document.getElementById('zoomIn')?.addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
          });

          document.getElementById('zoomOut')?.addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.67);
          });

          document.getElementById('resetView')?.addEventListener('click', () => {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            
            // Reset to left/right positioning based on coordinates
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            
            knowledgeGraph.nodes.forEach(node => {
              const pos = node.position || { x: 0, y: 0 };
              
              if (node === rootNode) {
                // Keep root node at center
                node.fx = centerX;
                node.fy = centerY;
              } else {
                // Reposition based on x coordinate sign
                const offsetX = Math.abs(pos.x) > 0.5 ? 250 : 200;
                const offsetY = pos.y * 80;
                
                if (pos.x < 0) {
                  // Negative x = left side
                  node.fx = centerX - offsetX;
                } else if (pos.x > 0) {
                  // Positive x = right side  
                  node.fx = centerX + offsetX;
                } else {
                  // x = 0 = center
                  node.fx = centerX;
                }
                
                node.fy = null; // Allow vertical movement
                node.y = centerY + offsetY;
              }
            });
            
            if (simulation) {
              simulation.alpha(0.5).restart();
            }
          });

          // Graph Info button
          document.getElementById('graphInfoBtn')?.addEventListener('click', () => {
            openGraphInfoModal();
          });

          // Legend control buttons: delegate to main controls
          document.getElementById('legendZoomIn')?.addEventListener('click', () => {
            document.getElementById('zoomIn')?.click();
          });
          document.getElementById('legendZoomOut')?.addEventListener('click', () => {
            document.getElementById('zoomOut')?.click();
          });
          document.getElementById('legendReset')?.addEventListener('click', () => {
            document.getElementById('resetView')?.click();
          });
        }
      }

      // Open graph info modal
      function openGraphInfoModal() {
        const modal = document.getElementById('graphInfoModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      }

      // Close graph info modal
      function closeGraphInfoModal() {
        const modal = document.getElementById('graphInfoModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }
      }

      // Initialize graph info modal
      function initializeGraphInfoModal() {
        const graphInfoBtn = document.getElementById('graphInfoBtn');
        const closeBtn = document.getElementById('closeGraphInfo');
        const modal = document.getElementById('graphInfoModal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeGraphInfoModal);
        }
        
        if (modal) {
          // Close modal when clicking outside
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeGraphInfoModal();
            }
          });
          
          // Close modal with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeGraphInfoModal();
            }
          });
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Initialize tabs
        initializeTabs();
        initializeGrowthPotentialInfo();
        initializeDocumentationModal();
        initializeGraphInfoModal();
        initializeShareDropdown();
        initializePDFDownload();
        initializePPTXDownload();
        initializeEmailShare();
        initializeFileViewToggle();
        initializeFollowUpTab();
        initializeChat();
        
        // Initialize news/documents tab switching
        const industryNewsTab = document.getElementById('industryNewsTab');
        const internetDocumentsTab = document.getElementById('internetDocumentsTab');
        
        if (industryNewsTab) {
          industryNewsTab.addEventListener('click', () => switchNewsTab('news'));
        }
        
        if (internetDocumentsTab) {
          internetDocumentsTab.addEventListener('click', () => switchNewsTab('documents'));
        }
        
        // Show page loader initially
        showPageLoader();
        
        // Fallback: hide page loader after 10 seconds to prevent blank page
        setTimeout(() => {
          hidePageLoader();
        }, 10000);
        
        // Check authentication and load data
      fetch('/api/auth/me').then(r=>r.json()).then(d=>{
          if(!d.user){ 
            window.location.href='/auth.html'; 
          } else {
            // Load user email in tooltip
            const userEmailText = document.getElementById('userEmailText');
            if (userEmailText) {
              userEmailText.textContent = d.user.email;
            }
            // Load report data after authentication check
            fetchReportData();
          }
        }).catch(()=> {
          // Hide page loader even on auth error
          hidePageLoader();
          window.location.href='/auth.html';
        });
      });
      
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async ()=>{
          await fetch('/api/auth/logout',{method:'POST'});
          window.location.href='/auth.html';
        });
      }
      // Charts (initialize after layout)
      window.addEventListener('load', () => {
        if (!window.Chart) return;
        // Search expand/collapse
        const btn = document.getElementById('searchBtn');
        const inp = document.getElementById('searchInput');
        if (btn && inp) {
          btn.addEventListener('click', () => {
            const expanded = inp.classList.contains('opacity-100');
            if (expanded) {
              inp.classList.remove('opacity-100'); inp.style.width='0px'; inp.style.paddingLeft='0px'; inp.style.paddingRight='0px'; inp.classList.add('opacity-0');
            } else {
              inp.style.width='180px'; inp.style.paddingLeft='12px'; inp.style.paddingRight='12px'; inp.classList.remove('opacity-0'); inp.classList.add('opacity-100'); inp.focus();
            }
          });
        }
        // Market value chart will be created dynamically from API data
        // The old static income chart code has been replaced with createMarketValueChart()

        // Donut chart
        const donutCanvas = document.getElementById('donutChart');
        if (donutCanvas) {
          const rect = donutCanvas.parentElement.getBoundingClientRect();
          donutCanvas.width = rect.width; donutCanvas.height = rect.height;
          const dctx = donutCanvas.getContext('2d');
          new Chart(dctx, { type: 'doughnut', data: { datasets: [{ data: [65,25,10], backgroundColor: ['#f1d85b','#ffffff','#ff6b6b'], borderWidth: 0, cutout: '68%' }]}, options: { plugins: { legend: { display:false } }, responsive: true, maintainAspectRatio: false } });
        }
      });

      // Sidebar sign out
      const signout = document.getElementById('signoutBtn');
      if (signout) {
        signout.addEventListener('click', async ()=>{
          try { await fetch('/api/auth/logout',{method:'POST'}); } catch(e) {}
          window.location.href='/auth.html';
        });
      }

      // Feedback Form Functionality
      function initializeFeedbackForm() {
        const toggleBtn = document.getElementById('toggleFeedbackForm');
        const feedbackModal = document.getElementById('feedbackModal');
        const closeBtn = document.getElementById('closeFeedbackModal');
        const cancelBtn = document.getElementById('cancelFeedback');
        const submitBtn = document.getElementById('submitFeedback');
        const feedbackNote = document.getElementById('feedbackNote');

        // Store feedback ratings
        const feedbackRatings = {};

        // Populate modal with existing feedback data
        function populateExistingFeedback(feedback) {
          // Clear existing ratings
          Object.keys(feedbackRatings).forEach(key => delete feedbackRatings[key]);
          
          // Set feedback ratings
          const categories = [
            'overall_feedback',
            'risk_indicator_feedback', 
            'got_what_looking_for',
            'content_quality',
            'scores_satisfaction',
            'copilot_feedback',
            'ecosystem_feedback'
          ];
          
          categories.forEach(category => {
            if (feedback[category]) {
              feedbackRatings[category] = feedback[category];
            }
          });
          
          // Set feedback note
          const feedbackNote = document.getElementById('feedbackNote');
          if (feedbackNote && feedback.feedback_note) {
            feedbackNote.value = feedback.feedback_note;
          }
          
          console.log('Populated existing feedback:', feedback);
        }

        // Reset feedback form to start fresh
        function resetFeedbackForm() {
          // Clear existing ratings
          Object.keys(feedbackRatings).forEach(key => delete feedbackRatings[key]);
          
          // Clear feedback note
          const feedbackNote = document.getElementById('feedbackNote');
          if (feedbackNote) {
            feedbackNote.value = '';
          }
          
          console.log('Reset feedback form for fresh start');
        }

        // Initialize star ratings
        function initializeStarRatings() {
          const starRatings = document.querySelectorAll('.star-rating');
          
          starRatings.forEach(ratingContainer => {
            const category = ratingContainer.getAttribute('data-category');
            const stars = ratingContainer.querySelectorAll('.star');
            
            // Set initial state based on existing feedback
            const existingRating = feedbackRatings[category] || 0;
            stars.forEach((s, i) => {
              if (i < existingRating) {
                s.classList.add('rated');
              } else {
                s.classList.remove('rated', 'active');
              }
            });
            
            stars.forEach((star, index) => {
              star.addEventListener('click', () => {
                const rating = index + 1;
                feedbackRatings[category] = rating;
                
                // Update star display
                stars.forEach((s, i) => {
                  if (i < rating) {
                    s.classList.add('rated');
                    s.classList.remove('active');
                  } else {
                    s.classList.remove('rated', 'active');
                  }
                });
              });
              
              star.addEventListener('mouseenter', () => {
                stars.forEach((s, i) => {
                  if (i <= index) {
                    s.classList.add('active');
                  } else {
                    s.classList.remove('active');
                  }
                });
              });
            });
            
            ratingContainer.addEventListener('mouseleave', () => {
              const currentRating = feedbackRatings[category] || 0;
              stars.forEach((s, i) => {
                if (i < currentRating) {
                  s.classList.add('rated');
                } else {
                  s.classList.remove('rated', 'active');
                }
              });
            });
          });
        }

        // Store current tab state before opening feedback modal
        let savedTabState = null;
        
        function saveCurrentTabState() {
          // Find the currently active tab button (exclude feedback and documentation buttons)
          const activeTabButton = document.querySelector('.tab-button.active:not([data-tab="news"]):not([data-tab="documents"]):not([id="toggleFeedbackForm"]):not([id="documentationTab"])');
          if (activeTabButton) {
            savedTabState = {
              tabId: activeTabButton.id,
              tabData: activeTabButton.getAttribute('data-tab')
            };
            console.log('Saved tab state:', savedTabState);
          } else {
            // Fallback: look for any active tab content to determine current tab
            const activeContent = document.querySelector('.tab-content.active:not(.news-tab-content)');
            if (activeContent) {
              // Determine tab from content ID
              let tabData = null;
              let tabId = null;
              
              if (activeContent.id === 'overallAnalysisContent') {
                tabData = 'overall';
                tabId = 'overallAnalysisTab';
              } else if (activeContent.id === 'detailedAnalysisContent') {
                tabData = 'detailed';
                tabId = 'detailedAnalysisTab';
              } else if (activeContent.id === 'qnaContent') {
                tabData = 'qna';
                tabId = 'qnaTab';
              } else if (activeContent.id === 'dependencyContent') {
                tabData = 'dependency';
                tabId = 'dependencyTab';
              } else if (activeContent.id === 'uploadedFilesContent') {
                tabData = 'files';
                tabId = 'uploadedFilesTab';
              } else if (activeContent.id === 'followUpContent') {
                tabData = 'followup';
                tabId = 'followUpTab';
              }
              
              if (tabData && tabId) {
                savedTabState = { tabId, tabData };
                console.log('Saved tab state (fallback):', savedTabState);
              }
            }
          }
        }
        
        function restoreTabState() {
          if (savedTabState) {
            console.log('Restoring tab state:', savedTabState);
            
            // Find the tab button to restore
            const tabButton = document.getElementById(savedTabState.tabId);
            if (tabButton) {
              // Remove active class from all tab buttons and contents
              const tabButtons = document.querySelectorAll('.tab-button:not([data-tab="news"]):not([data-tab="documents"])');
              const tabContents = document.querySelectorAll('.tab-content');
              
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabContents.forEach(content => content.classList.add('hidden'));
              
              // Add active class to the saved tab button
              tabButton.classList.add('active');
              
              // Show corresponding content
              let targetContent;
              const targetTab = savedTabState.tabData;
              if (targetTab === 'files') {
                targetContent = document.getElementById('uploadedFilesContent');
              } else if (targetTab === 'qna') {
                targetContent = document.getElementById('qnaContent');
              } else if (targetTab === 'dependency') {
                targetContent = document.getElementById('dependencyContent');
              } else if (targetTab === 'followup') {
                targetContent = document.getElementById('followUpContent');
              } else {
                targetContent = document.getElementById(`${targetTab}AnalysisContent`);
              }
              if (targetContent) {
                targetContent.classList.remove('hidden');
              }
            }
            savedTabState = null; // Clear saved state after restoration
          }
        }

        // Check for existing feedback and open modal
        async function openFeedbackModal() {
          // Save current tab state before opening modal
          saveCurrentTabState();
          
          // Authentication check removed for now
          
          try {
            // Get current report ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report_id');
            
            if (!reportId) {
              Swal.fire({
                title: 'Error',
                text: 'Report ID not found. Please refresh the page and try again.',
                icon: 'error',
                confirmButtonColor: '#f1d85b',
                confirmButtonText: 'OK'
              });
              return;
            }

            // Check for existing feedback
            console.log('Making feedback API call...');
            const response = await fetch(`/api/feedback/${reportId}`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json'
              },
              credentials: 'include'
            });

            console.log('Feedback check response status:', response.status);
            console.log('Feedback check response headers:', response.headers);

            if (response.ok) {
              // Check if response is JSON
              const contentType = response.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                
                if (result.exists && result.feedback) {
                  // Existing feedback found - populate modal with existing data
                  populateExistingFeedback(result.feedback);
                } else {
                  // No existing feedback - start fresh
                  resetFeedbackForm();
                }
              } else {
                // Response is not JSON, likely an error page
                const responseText = await response.text();
                console.error('Non-JSON response:', responseText);
                throw new Error('Server returned non-JSON response');
              }
              
              // Open the modal
              if (feedbackModal) {
                feedbackModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Ensure main content stays visible
                const mainContent = document.getElementById('app');
                if (mainContent) {
                  mainContent.classList.remove('hidden');
                }
                
                initializeStarRatings();
              }
            } else {
              const errorText = await response.text();
              console.error('Error response:', errorText);
              throw new Error(`Failed to check existing feedback: ${response.status}`);
            }
          } catch (error) {
            console.error('Error checking existing feedback:', error);
            
            // Fallback: open modal with fresh form if API call fails
            resetFeedbackForm();
            
            if (feedbackModal) {
              feedbackModal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
              
              // Ensure main content stays visible
              const mainContent = document.getElementById('app');
              if (mainContent) {
                mainContent.classList.remove('hidden');
              }
              
              initializeStarRatings();
            }
            
            // Silently handle the case - no error message needed
          }
        }

        // Close feedback modal
        function closeFeedbackModal() {
          if (feedbackModal) {
            feedbackModal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Ensure main content is visible and force it to show
            const mainContent = document.getElementById('app');
            if (mainContent) {
              mainContent.classList.remove('hidden');
              mainContent.style.display = 'flex'; // Force display
              mainContent.style.visibility = 'visible'; // Ensure visibility
            }
            
            // Also ensure the page loader is hidden
            const pageLoader = document.getElementById('pageLoader');
            if (pageLoader) {
              pageLoader.classList.add('hidden');
              pageLoader.style.display = 'none'; // Force hide
            }
            
            // Reset form
            resetFeedbackForm();
            
            // Reset star ratings
            document.querySelectorAll('.star').forEach(star => {
              star.classList.remove('rated', 'active');
            });
            
            // Restore the tab state that was saved before opening the modal
            restoreTabState();
          }
        }

        // Toggle feedback modal
        if (toggleBtn) {
          toggleBtn.addEventListener('click', openFeedbackModal);
        }

        // Close feedback modal
        if (closeBtn) {
          closeBtn.addEventListener('click', closeFeedbackModal);
        }

        // Cancel feedback form
        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeFeedbackModal);
        }

        // Submit feedback
        if (submitBtn) {
          submitBtn.addEventListener('click', async () => {
            // Validate that all ratings are provided
            const requiredFields = [
              'overall_feedback',
              'risk_indicator_feedback', 
              'got_what_looking_for',
              'content_quality',
              'scores_satisfaction',
              'copilot_feedback',
              'ecosystem_feedback'
            ];
            
            const missingFields = requiredFields.filter(field => !feedbackRatings[field]);
            
            if (missingFields.length > 0) {
              Swal.fire({
                title: 'Incomplete Feedback',
                text: 'Please provide ratings for all categories before submitting.',
                icon: 'warning',
                confirmButtonColor: '#f1d85b',
                confirmButtonText: 'OK'
              });
              return;
            }

            try {
              // Get current report ID from URL parameters
              const urlParams = new URLSearchParams(window.location.search);
              const reportId = urlParams.get('report_id');
              
              if (!reportId) {
                Swal.fire({
                  title: 'Error',
                  text: 'Report ID not found. Please refresh the page and try again.',
                  icon: 'error',
                  confirmButtonColor: '#f1d85b',
                  confirmButtonText: 'OK'
                });
                return;
              }
              
              const feedbackData = {
                ...feedbackRatings,
                feedback_note: feedbackNote.value.trim() || null
              };

              const response = await fetch('/api/feedback', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                  report_id: reportId,
                  ...feedbackData
                })
              });

              if (response.ok) {
                // Show success message and close modal
                closeFeedbackModal();
                
                // Ensure main content is visible after successful submission
                const mainContent = document.getElementById('app');
                if (mainContent) {
                  mainContent.classList.remove('hidden');
                  mainContent.style.display = 'flex';
                }
                
                // Hide page loader if it's showing
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader) {
                  pageLoader.classList.add('hidden');
                }
                
                Swal.fire({
                  title: 'Feedback Submitted!',
                  text: 'Thank you for your valuable feedback.',
                  icon: 'success',
                  confirmButtonColor: '#f1d85b',
                  confirmButtonText: 'OK'
                }).then(() => {
                  // Additional check after SweetAlert closes
                  if (mainContent) {
                    mainContent.classList.remove('hidden');
                    mainContent.style.display = 'flex';
                  }
                });
              } else if (response.status === 401) {
                // Handle authentication error
                Swal.fire({
                  title: 'Session Expired',
                  text: 'Your session has expired. Please log in again to submit feedback.',
                  icon: 'warning',
                  confirmButtonColor: '#f1d85b',
                  confirmButtonText: 'Go to Login'
                }).then(() => {
                  window.location.href = '/auth.html';
                });
              } else {
                throw new Error('Failed to submit feedback');
              }
            } catch (error) {
              console.error('Error submitting feedback:', error);
              Swal.fire({
                title: 'Error',
                text: 'Failed to submit feedback. Please try again.',
                icon: 'error',
                confirmButtonColor: '#f1d85b',
                confirmButtonText: 'OK'
              });
            }
          });
        }

        // Close modal when clicking outside
        if (feedbackModal) {
          feedbackModal.addEventListener('click', (e) => {
            if (e.target === feedbackModal) {
              closeFeedbackModal();
            }
          });
          
          // Close modal with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !feedbackModal.classList.contains('hidden')) {
              closeFeedbackModal();
            }
          });
        }
      }

      // Initialize feedback form when DOM is loaded
      document.addEventListener('DOMContentLoaded', initializeFeedbackForm);

      // Follow-up Questions Tab Functions
      function initializeFollowUpTab() {
        const generateFollowUpBtn = document.getElementById('generateFollowUpBtn');
        const askFounderBtn = document.getElementById('askFounderBtn');
        const retryFollowUp = document.getElementById('retryFollowUp');

        // Generate follow-up questions
        if (generateFollowUpBtn) {
          generateFollowUpBtn.addEventListener('click', generateFollowUpQuestions);
        }

        // Clear questions
        const clearQuestionsBtn = document.getElementById('clearQuestionsBtn');
        if (clearQuestionsBtn) {
          clearQuestionsBtn.addEventListener('click', clearQuestions);
        }

        // Ask founder for follow up
        if (askFounderBtn) {
          askFounderBtn.addEventListener('click', askFounderForFollowUp);
        }

        // Retry follow-up questions
        if (retryFollowUp) {
          retryFollowUp.addEventListener('click', generateFollowUpQuestions);
        }

        // Load existing follow-up queries
        loadExistingFollowUpQueries();
      }

      // Load existing follow-up queries
      async function loadExistingFollowUpQueries() {
        try {
          const reportId = new URLSearchParams(window.location.search).get('report_id');
          if (!reportId) return;

          const response = await fetch(`/api/reports/${reportId}/follow-up-queries`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to fetch follow-up queries');
          }

          const data = await response.json();
          displayFollowUpQueries(data.queries);

        } catch (error) {
          console.error('Error loading follow-up queries:', error);
        }
      }

      // Display follow-up queries as cards
      function displayFollowUpQueries(queries) {
        const grid = document.getElementById('followUpQueriesGrid');
        const emptyState = document.getElementById('noExistingQueries');
        const followUpEmpty = document.getElementById('followUpEmpty');

        if (!queries || queries.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        // Also hide the generated questions empty state when showing existing queries
        if (followUpEmpty) {
          followUpEmpty.classList.add('hidden');
        }
        
        // Clear the grid and populate with query cards
        grid.innerHTML = '';

        queries.forEach(query => {
          const card = createFollowUpQueryCard(query);
          grid.appendChild(card);
        });
      }

      // Create follow-up query card
      function createFollowUpQueryCard(query) {
        const card = document.createElement('div');
        card.className = 'bg-[#1E1E21] border border-white/10 rounded-lg p-4 hover:border-white/20 transition-colors cursor-pointer';
        card.onclick = () => openFollowUpQueryDetail(query.id);

        const createdDate = new Date(query.created_at).toLocaleDateString();
        const updatedDate = new Date(query.updated_at).toLocaleDateString();

        card.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div>
                <h4 class="text-white font-medium">Follow-up Query</h4>
                <p class="text-white/60 text-sm">${query.question_count} questions</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              ${query.has_video ? '<span class="w-2 h-2 bg-green-500 rounded-full" title="Video Available"></span>' : ''}
              ${query.has_transcript ? '<span class="w-2 h-2 bg-blue-500 rounded-full" title="Transcript Available"></span>' : ''}
            </div>
          </div>
          
          <div class="space-y-2 text-sm text-white/70">
            <div class="flex justify-between">
              <span>Created:</span>
              <span>${createdDate}</span>
            </div>
            <div class="flex justify-between">
              <span>Updated:</span>
              <span>${updatedDate}</span>
            </div>
          </div>
          
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="flex items-center justify-between text-sm">
              <span class="text-white/60">Click to view details</span>
              <svg class="w-4 h-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        `;

        return card;
      }

      // Open follow-up query detail view
      async function openFollowUpQueryDetail(queryId) {
        try {
          // Show loading state
          const loadingModal = createLoadingModal();
          document.body.appendChild(loadingModal);

          // Fetch follow-up query details
          const response = await fetch(`/api/follow-up-queries/${queryId}`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to fetch follow-up query details');
          }

          const queryData = await response.json();
          
          // Remove loading modal
          document.body.removeChild(loadingModal);

          // Show detail modal
          showFollowUpQueryDetailModal(queryData, queryId);

        } catch (error) {
          console.error('Error opening follow-up query detail:', error);
          // Remove loading modal if it exists
          const loadingModal = document.getElementById('loadingModal');
          if (loadingModal) {
            document.body.removeChild(loadingModal);
          }
          showToast('Failed to load follow-up query details', 'red');
        }
      }

      // Create loading modal
      function createLoadingModal() {
        const modal = document.createElement('div');
        modal.id = 'loadingModal';
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-[#2E3137] border border-white/10 rounded-lg p-6">
            <div class="flex items-center gap-3">
              <div class="w-6 h-6 border-2 border-accent border-t-transparent rounded-full animate-spin"></div>
              <span class="text-white">Loading follow-up query details...</span>
            </div>
          </div>
        `;
        return modal;
      }

      // Show follow-up query detail modal
      function showFollowUpQueryDetailModal(queryData, queryId) {
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
        overlay.id = 'followUpDetailModal';
        
        // Create modal content
        const modal = document.createElement('div');
        modal.className = 'bg-[#2E3137] border border-white/10 rounded-lg w-full max-w-6xl h-full max-h-[90vh] flex flex-col';
        modal.innerHTML = `
          <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="text-xl font-semibold text-white">Follow-up Query Details</h3>
            <button onclick="closeFollowUpDetailModal()" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="flex-1 flex overflow-hidden">
            <!-- Left Side - Video Player -->
            <div class="w-1/2 border-r border-white/10 flex flex-col items-center justify-center">
              <div class="p-4 w-full">
                <h4 class="text-lg font-medium text-white mb-2 text-center">Video Response</h4>
                <div id="videoContainer" class="bg-black rounded-lg overflow-hidden mx-auto max-w-md">
                  <!-- Video player will be loaded here -->
                </div>
              </div>
            </div>
            
            <!-- Right Side - Questions/Answers and Transcript -->
            <div class="w-1/2 flex flex-col h-full min-h-0">
              <div class="p-4 flex-1 flex flex-col min-h-0">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                  <h4 class="text-lg font-medium text-white">Questions & Answers</h4>
                  <div class="flex items-center gap-2">
                    <button id="toggleTranscript" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                      Show Transcript
                    </button>
                  </div>
                </div>
                
                <!-- Questions/Answers Content -->
                <div id="questionsAnswersContent" class="space-y-4 flex-1 overflow-y-auto min-h-0">
                  <!-- Questions and answers will be populated here -->
                </div>
                
                <!-- Transcript Content -->
                <div id="transcriptContent" class="hidden flex-1 overflow-y-auto min-h-0">
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4 h-full">
                    <h5 class="text-white font-medium mb-2">Full Transcript</h5>
                    <p class="text-white/80 text-sm leading-relaxed" id="transcriptText">
                      <!-- Transcript will be loaded here -->
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Load video and content
        loadFollowUpQueryContent(queryData, queryId);
        
        // Add event listener for toggle transcript button
        const toggleBtn = document.getElementById('toggleTranscript');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleTranscript);
        }
        
        // Close modal when clicking outside
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeFollowUpDetailModal();
          }
        });
      }

      // Load follow-up query content
      async function loadFollowUpQueryContent(queryData, queryId) {
        try {
          // Load video if available
          const videoContainer = document.getElementById('videoContainer');
          if (queryData.video_path) {
            await loadVideoPlayer(queryData.video_path, videoContainer, queryId);
          } else {
            videoContainer.innerHTML = `
              <div class="flex items-center justify-center h-64 text-white/60">
                <div class="text-center">
                  <svg class="w-16 h-16 mx-auto mb-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                  <p class="text-lg">No Video Available</p>
                  <p class="text-sm">Video response has not been recorded yet.</p>
                </div>
              </div>
            `;
          }

          // Load questions and answers
          const questionsAnswersContent = document.getElementById('questionsAnswersContent');
          if (queryData.answers && queryData.answers.length > 0) {
            displayQuestionsAndAnswers(queryData.answers, questionsAnswersContent);
          } else if (queryData.questions && queryData.questions.length > 0) {
            // If no answers but questions exist, show questions only
            const questionsOnly = queryData.questions.map(q => ({ question: q, answer: 'No answer provided yet' }));
            displayQuestionsAndAnswers(questionsOnly, questionsAnswersContent);
          } else {
            questionsAnswersContent.innerHTML = `
              <div class="text-center text-white/60 py-8">
                <p>No questions available</p>
              </div>
            `;
          }

          // Load transcript if available
          if (queryData.transcript) {
            document.getElementById('transcriptText').textContent = queryData.transcript;
          } else {
            document.getElementById('transcriptText').textContent = 'No transcript available';
          }

        } catch (error) {
          console.error('Error loading follow-up query content:', error);
        }
      }

      // Load video player
      async function loadVideoPlayer(videoPath, container, queryId) {
        try {
          // Use the provided query ID
          const videoQueryId = queryId || window.currentQueryId || 'unknown';
          
          container.innerHTML = `
            <div class="relative group">
              <video id="followUpVideo" class="w-full h-64 bg-black rounded-lg">
                <source src="/api/follow-up-queries/${videoQueryId}/video" type="video/webm">
                Your browser does not support the video tag.
              </video>
              
              <!-- Custom Video Controls - Always Visible -->
              <div id="customVideoControls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 rounded-b-lg opacity-100 transition-opacity duration-300">
                <div class="flex items-center gap-4">
                  <!-- Play/Pause Button -->
                  <button id="playPauseBtn" class="text-white hover:text-accent transition-colors">
                    <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>
                  </button>
                  
                  <!-- Restart Button -->
                  <button id="restartBtn" class="text-white hover:text-accent transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  </button>
                  
                  <!-- Volume Control -->
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-20">
                  </div>
                  
                  <!-- Time Display -->
                  <div class="flex items-center gap-2 text-white text-sm">
                    <span id="currentTime">0:00</span>
                    <span>/</span>
                    <span id="duration">0:00</span>
                  </div>
                  
                  <!-- Fullscreen Button -->
                  <button id="fullscreenBtn" class="text-white hover:text-accent transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `;

          // Setup video controls
          setupVideoControls();
          
          // Add CSS to ensure custom controls are always visible
          const style = document.createElement('style');
          style.textContent = `
            #customVideoControls {
              opacity: 1 !important;
              visibility: visible !important;
              display: flex !important;
            }
            #followUpVideo::-webkit-media-controls {
              display: none !important;
            }
            #followUpVideo::-webkit-media-controls-enclosure {
              display: none !important;
            }
          `;
          document.head.appendChild(style);

        } catch (error) {
          console.error('Error loading video player:', error);
          container.innerHTML = `
            <div class="flex items-center justify-center h-64 text-white/60">
              <div class="text-center">
                <svg class="w-16 h-16 mx-auto mb-4 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-lg">Error Loading Video</p>
                <p class="text-sm">Failed to load video player</p>
              </div>
            </div>
          `;
        }
      }

      // Setup video controls
      function setupVideoControls() {
        const video = document.getElementById('followUpVideo');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const restartBtn = document.getElementById('restartBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        if (!video || !playPauseBtn) return;

        // Play/Pause functionality
        playPauseBtn.addEventListener('click', () => {
          if (video.paused) {
            video.play();
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
          } else {
            video.pause();
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
          }
        });

        // Video play/pause event listeners
        video.addEventListener('play', () => {
          playIcon.classList.add('hidden');
          pauseIcon.classList.remove('hidden');
        });

        video.addEventListener('pause', () => {
          playIcon.classList.remove('hidden');
          pauseIcon.classList.add('hidden');
        });

        // Restart functionality
        restartBtn.addEventListener('click', () => {
          video.currentTime = 0;
          video.play();
        });

        // Volume control
        volumeSlider.addEventListener('input', (e) => {
          video.volume = e.target.value;
        });

        // Fullscreen functionality
        fullscreenBtn.addEventListener('click', () => {
          if (video.requestFullscreen) {
            video.requestFullscreen();
          } else if (video.webkitRequestFullscreen) {
            video.webkitRequestFullscreen();
          } else if (video.mozRequestFullScreen) {
            video.mozRequestFullScreen();
          } else if (video.msRequestFullscreen) {
            video.msRequestFullscreen();
          }
        });

        // Time display updates
        video.addEventListener('timeupdate', () => {
          currentTimeEl.textContent = formatTime(video.currentTime);
        });

        video.addEventListener('loadedmetadata', () => {
          durationEl.textContent = formatTime(video.duration);
        });

        // Set initial volume
        video.volume = volumeSlider.value;
      }

      // Format time in MM:SS format
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      // Display questions and answers
      function displayQuestionsAndAnswers(questions, container) {
        container.innerHTML = '';
        
        questions.forEach((qa, index) => {
          const qaElement = document.createElement('div');
          qaElement.className = 'bg-[#1E1E21] border border-white/10 rounded-lg p-4';
          qaElement.innerHTML = `
            <div class="mb-3">
              <div class="flex items-start gap-2 mb-2">
                <span class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs font-medium flex-shrink-0">${index + 1}</span>
                <p class="text-accent text-sm">${qa.question}</p>
              </div>
            </div>
            <div class="pl-8">
              <p class="text-white text-sm">${qa.answer}</p>
            </div>
          `;
          container.appendChild(qaElement);
        });
      }

      // Close follow-up detail modal
      function closeFollowUpDetailModal() {
        const modal = document.getElementById('followUpDetailModal');
        if (modal) {
          document.body.removeChild(modal);
        }
      }

      // Toggle transcript visibility
      function toggleTranscript() {
        const questionsContent = document.getElementById('questionsAnswersContent');
        const transcriptContent = document.getElementById('transcriptContent');
        const toggleBtn = document.getElementById('toggleTranscript');

        if (transcriptContent.classList.contains('hidden')) {
          transcriptContent.classList.remove('hidden');
          questionsContent.classList.add('hidden');
          toggleBtn.textContent = 'Show Q&A';
        } else {
          transcriptContent.classList.add('hidden');
          questionsContent.classList.remove('hidden');
          toggleBtn.textContent = 'Show Transcript';
        }
      }

      // Generate follow-up questions
      async function generateFollowUpQuestions() {
        const loadingDiv = document.getElementById('followUpLoading');
        const questionsDiv = document.getElementById('followUpQuestions');
        const errorDiv = document.getElementById('followUpError');
        const emptyDiv = document.getElementById('followUpEmpty');

        // Show loading state
        loadingDiv.classList.remove('hidden');
        questionsDiv.classList.add('hidden');
        errorDiv.classList.add('hidden');
        emptyDiv.classList.add('hidden');
        
        // Hide existing queries section when generating new questions
        const existingQueriesDiv = document.getElementById('existingFollowUpQueries');
        if (existingQueriesDiv) {
          existingQueriesDiv.classList.add('hidden');
        }

        try {
          // Get current report ID from URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const reportId = urlParams.get('report_id');
          
          if (!reportId) {
            throw new Error('Report ID not found');
          }

          // Call the API to generate follow-up questions
          const response = await fetch('/api/reports/follow-up-questions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              report_id: reportId
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to generate follow-up questions');
          }

          const data = await response.json();
          
          // Hide loading and show questions
          loadingDiv.classList.add('hidden');
          questionsDiv.classList.remove('hidden');
          
          // Ensure existing queries section stays hidden when showing generated questions
          const existingQueriesDiv = document.getElementById('existingFollowUpQueries');
          if (existingQueriesDiv) {
            existingQueriesDiv.classList.add('hidden');
          }
          
          // Populate questions grid
          populateFollowUpQuestions(data.questions);
          
          // Show the "Ask Founder for Follow Up" button when questions are generated
          const askFounderBtn = document.getElementById('askFounderBtn');
          if (askFounderBtn && data.questions && data.questions.length > 0) {
            askFounderBtn.classList.remove('hidden');
          }
          
          // Show the "Clear Questions" button when questions are generated
          const clearQuestionsBtn = document.getElementById('clearQuestionsBtn');
          if (clearQuestionsBtn && data.questions && data.questions.length > 0) {
            clearQuestionsBtn.classList.remove('hidden');
          }

        } catch (error) {
          console.error('Error generating follow-up questions:', error);
          
          // Hide loading and show error
          loadingDiv.classList.add('hidden');
          errorDiv.classList.remove('hidden');
        }
      }

      // Clear questions and show existing follow-up queries
      function clearQuestions() {
        // Hide questions table
        const questionsDiv = document.getElementById('followUpQuestions');
        questionsDiv.classList.add('hidden');
        
        // Show existing follow-up queries
        const existingQueriesDiv = document.getElementById('existingFollowUpQueries');
        existingQueriesDiv.classList.remove('hidden');
        
        // Hide clear and ask founder buttons
        const clearQuestionsBtn = document.getElementById('clearQuestionsBtn');
        const askFounderBtn = document.getElementById('askFounderBtn');
        if (clearQuestionsBtn) clearQuestionsBtn.classList.add('hidden');
        if (askFounderBtn) askFounderBtn.classList.add('hidden');
        
        // Clear the questions table body
        const questionsBody = document.getElementById('followUpQuestionsBody');
        if (questionsBody) {
          questionsBody.innerHTML = '';
        }
      }

      // Populate follow-up questions table
      function populateFollowUpQuestions(questions) {
        const questionsBody = document.getElementById('followUpQuestionsBody');
        
        if (!questions || questions.length === 0) {
          questionsBody.innerHTML = `
            <tr>
              <td colspan="3" class="px-4 py-8 text-center text-white/70">
                No follow-up questions generated. Please try again.
              </td>
            </tr>
          `;
          return;
        }

        questionsBody.innerHTML = questions.map((question, index) => `
          <tr class="hover:bg-white/5 transition-colors">
            <td class="px-4 py-3 text-sm text-white/70 font-medium">${index + 1}</td>
            <td class="px-4 py-3 text-sm text-white leading-relaxed">${question}</td>
            <td class="px-4 py-3 text-center">
              <div class="flex items-center justify-center gap-2">
                <button onclick="editQuestion(this)" class="p-1 text-blue-400 hover:text-blue-300 hover:bg-blue-400/10 rounded-md transition-colors" title="Edit question">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button onclick="deleteQuestion(this)" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded-md transition-colors" title="Delete question">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Edit question in table
      function editQuestion(button) {
        const row = button.closest('tr');
        const questionCell = row.querySelector('td:nth-child(2)');
        const currentText = questionCell.textContent.trim();
        
        // Create input field
        const input = document.createElement('textarea');
        input.value = currentText;
        input.className = 'w-full p-2 bg-[#2E3137] border border-white/20 rounded-md text-white text-sm resize-none focus:outline-none focus:border-accent';
        input.rows = 2;
        
        // Replace cell content with input
        questionCell.innerHTML = '';
        questionCell.appendChild(input);
        input.focus();
        input.select();
        
        // Handle save on blur or Enter
        const saveEdit = () => {
          const newText = input.value.trim();
          if (newText && newText !== currentText) {
            questionCell.textContent = newText;
            showToast('Question updated!', 'green');
          } else if (newText) {
            questionCell.textContent = newText;
          } else {
            questionCell.textContent = currentText; // Restore original if empty
          }
        };
        
        const cancelEdit = () => {
          questionCell.textContent = currentText;
        };
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            saveEdit();
          } else if (e.key === 'Escape') {
            cancelEdit();
          }
        });
      }

      // Add new question to table
      function addNewQuestion() {
        const questionsBody = document.getElementById('followUpQuestionsBody');
        const currentRowCount = questionsBody.querySelectorAll('tr').length;
        
        // Create new row
        const newRow = document.createElement('tr');
        newRow.className = 'hover:bg-white/5 transition-colors';
        newRow.innerHTML = `
          <td class="px-4 py-3 text-sm text-white/70 font-medium">${currentRowCount + 1}</td>
          <td class="px-4 py-3 text-sm text-white leading-relaxed">
            <textarea class="w-full p-2 bg-[#2E3137] border border-white/20 rounded-md text-white text-sm resize-none focus:outline-none focus:border-accent" rows="2" placeholder="Enter your question here..."></textarea>
          </td>
          <td class="px-4 py-3 text-center">
            <div class="flex items-center justify-center gap-2">
              <button onclick="saveNewQuestion(this)" class="p-1 text-green-400 hover:text-green-300 hover:bg-green-400/10 rounded-md transition-colors" title="Save question">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </button>
              <button onclick="cancelNewQuestion(this)" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded-md transition-colors" title="Cancel">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </td>
        `;
        
        questionsBody.appendChild(newRow);
        
        // Focus on the textarea
        const textarea = newRow.querySelector('textarea');
        textarea.focus();
        
        // Show the "Ask Founder for Follow Up" button when questions are present
        const askFounderBtn = document.getElementById('askFounderBtn');
        if (askFounderBtn) {
          askFounderBtn.classList.remove('hidden');
        }
      }

      // Save new question
      function saveNewQuestion(button) {
        const row = button.closest('tr');
        const textarea = row.querySelector('textarea');
        const questionText = textarea.value.trim();
        
        if (!questionText) {
          showToast('Please enter a question!', 'red');
          textarea.focus();
          return;
        }
        
        // Replace textarea with regular text
        const questionCell = row.querySelector('td:nth-child(2)');
        questionCell.textContent = questionText;
        
        // Replace action buttons with edit/delete
        const actionCell = row.querySelector('td:nth-child(3)');
        actionCell.innerHTML = `
          <div class="flex items-center justify-center gap-2">
            <button onclick="editQuestion(this)" class="p-1 text-blue-400 hover:text-blue-300 hover:bg-blue-400/10 rounded-md transition-colors" title="Edit question">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            <button onclick="deleteQuestion(this)" class="p-1 text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded-md transition-colors" title="Delete question">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        
        showToast('Question added successfully!', 'green');
      }

      // Cancel new question
      function cancelNewQuestion(button) {
        const row = button.closest('tr');
        row.remove();
        
        // Hide the "Ask Founder for Follow Up" button if no questions remain
        const remainingRows = document.querySelectorAll('#followUpQuestionsBody tr');
        const askFounderBtn = document.getElementById('askFounderBtn');
        if (askFounderBtn && remainingRows.length === 0) {
          askFounderBtn.classList.add('hidden');
        }
      }

      // Ask founder for follow up
      async function askFounderForFollowUp() {
        try {
          // Get current report ID from URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const reportId = urlParams.get('report_id');
          
          if (!reportId) {
            throw new Error('Report ID not found');
          }

          // Collect all questions from the table
          const questionsBody = document.getElementById('followUpQuestionsBody');
          const questionRows = questionsBody.querySelectorAll('tr');
          
          if (questionRows.length === 0) {
            showToast('No questions available to send. Please generate or add questions first.', 'red');
            return;
          }

          const questions = [];
          questionRows.forEach((row, index) => {
            const questionCell = row.querySelector('td:nth-child(2)');
            if (questionCell) {
              const questionText = questionCell.textContent.trim();
              if (questionText) {
                questions.push(questionText);
              }
            }
          });

          if (questions.length === 0) {
            showToast('No valid questions found. Please add some questions first.', 'red');
            return;
          }

          // Show loading state
          const askFounderBtn = document.getElementById('askFounderBtn');
          const originalText = askFounderBtn.textContent;
          askFounderBtn.textContent = 'Saving...';
          askFounderBtn.disabled = true;

          // Call the API to save follow-up queries
          const response = await fetch('/api/reports/follow-up-queries', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              report_id: reportId,
              questions: questions
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save follow-up queries');
          }

          const data = await response.json();
          
          // Show success popup
          showSuccessPopup(data.query_id);

        } catch (error) {
          console.error('Error saving follow-up queries:', error);
          showToast(`Failed to save follow-up queries: ${error.message}`, 'red');
        } finally {
          // Restore button state
          const askFounderBtn = document.getElementById('askFounderBtn');
          if (askFounderBtn) {
            askFounderBtn.textContent = 'Ask Founder for Follow Up';
            askFounderBtn.disabled = false;
          }
        }
      }

      // Show success popup for follow-up queries
      function showSuccessPopup(queryId) {
        // Store queryId globally for email function
        window.currentQueryId = queryId;
        
        // Create popup overlay
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        overlay.id = 'successPopupOverlay';
        
        // Create popup content
        const popup = document.createElement('div');
        popup.className = 'bg-[#2E3137] border border-white/10 rounded-lg p-6 max-w-md mx-4 shadow-lg';
        popup.innerHTML = `
          <div class="text-center">
            <h3 class="text-xl font-semibold text-white mb-4">Follow-up Questions Sent!</h3>
            
            <!-- Video Recording Options -->
            <div class="space-y-3 mb-4">
              <!-- Traditional Video Link -->
              <div class="bg-[#1E1E21] border border-white/10 rounded-md p-3">
                <p class="text-sm text-white/60 mb-2">📹 Traditional Video Recording:</p>
                <div class="flex items-center gap-2">
                  <input type="text" id="videoLink" value="${window.location.origin}/video.html?id=${queryId}" readonly class="flex-1 bg-[#2E3137] border border-white/20 rounded px-2 py-1 text-xs text-white">
                  <button onclick="copyVideoLink()" class="px-2 py-1 bg-accent text-[#1E1E21] rounded text-xs hover:bg-accent/80 transition-colors">
                    Copy
                  </button>
                </div>
              </div>

              <!-- AI Chat Link -->
              <div class="bg-[#1E1E21] border border-white/10 rounded-md p-3">
                <!-- <p class="text-sm text-white/60 mb-2">🤖 AI Chat Interview:</p> -->
                <div class="flex items-center gap-2">
                  <input type="text" id="aiChatLink" value="${window.location.origin}/ai-chat.html?id=${queryId}" readonly class="flex-1 bg-[#2E3137] border border-white/20 rounded px-2 py-1 text-xs text-white">
                  <button onclick="copyAiChatLink()" class="px-2 py-1 bg-accent text-[#1E1E21] rounded text-xs hover:bg-accent/80 transition-colors">
                    Copy
                  </button>
                </div>
              </div>
            </div>

            <!-- Email Sharing -->
            <div class="bg-[#1E1E21] border border-white/10 rounded-md p-3 mb-4">
              <p class="text-sm text-white/60 mb-2">Share via Email:</p>
              <div class="flex items-center gap-2 mb-2">
                <input type="email" id="emailInput" placeholder="Founder's email" class="flex-1 bg-[#2E3137] border border-white/20 rounded px-2 py-1 text-xs text-white placeholder-white/40">
                <button onclick="sendEmailInvite()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors">
                  Send
                </button>
              </div>
            </div>
            
            <p class="text-white/60 text-sm mb-6">Choose between traditional video recording or AI-powered chat interview. Share the preferred link with the founder.</p>
            <button onclick="closeSuccessPopup()" class="px-6 py-2 bg-accent text-[#1E1E21] rounded-lg hover:bg-accent/80 transition-colors font-medium">
              Got it!
            </button>
          </div>
        `;
        
        overlay.appendChild(popup);
        document.body.appendChild(overlay);
        
        // Close popup when clicking outside
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeSuccessPopup();
          }
        });
        
        // Close popup with Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeSuccessPopup();
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Store the event listener for cleanup
        overlay._escapeHandler = handleEscape;
      }

      // Copy video link to clipboard
      function copyVideoLink() {
        const videoLinkInput = document.getElementById('videoLink');
        if (videoLinkInput) {
          videoLinkInput.select();
          document.execCommand('copy');
          showToast('Video link copied to clipboard!', 'green');
        }
      }

      function copyAiChatLink() {
        const aiChatLinkInput = document.getElementById('aiChatLink');
        if (aiChatLinkInput) {
          aiChatLinkInput.select();
          document.execCommand('copy');
          showToast('AI Chat link copied to clipboard!', 'green');
        }
      }

      // Send email invite
      async function sendEmailInvite() {
        const emailInput = document.getElementById('emailInput');
        const videoLinkInput = document.getElementById('videoLink');
        
        if (!emailInput || !videoLinkInput) return;
        
        const email = emailInput.value.trim();
        const videoLink = videoLinkInput.value;
        
        if (!email) {
          showToast('Please enter an email address', 'red');
          return;
        }
        
        if (!email.includes('@')) {
          showToast('Please enter a valid email address', 'red');
          return;
        }

        try {
          const response = await fetch('/api/follow-up-queries/send-email-invite', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              email: email,
              videoLink: videoLink,
              queryId: window.currentQueryId // Use the stored queryId
            })
          });

          if (!response.ok) {
            throw new Error('Failed to send email');
          }

          showToast('Email invitation sent successfully!', 'green');
          emailInput.value = '';
          
        } catch (error) {
          console.error('Error sending email:', error);
          showToast('Failed to send email. Please try again.', 'red');
        }
      }

      // Close success popup
      function closeSuccessPopup() {
        const overlay = document.getElementById('successPopupOverlay');
        if (overlay) {
          // Remove escape key listener
          if (overlay._escapeHandler) {
            document.removeEventListener('keydown', overlay._escapeHandler);
          }
          document.body.removeChild(overlay);
        }
      }

      // Show toast notification
      function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-opacity text-white ${
          type === 'green' ? 'bg-green-500' : type === 'red' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 2000);
      }

      // Delete question from table
      function deleteQuestion(button) {
        const row = button.closest('tr');
        if (row) {
          // Add fade out animation
          row.style.opacity = '0';
          row.style.transition = 'opacity 0.3s ease-out';
          
          setTimeout(() => {
            row.remove();
            
            // Renumber remaining rows
            const remainingRows = document.querySelectorAll('#followUpQuestionsBody tr');
            remainingRows.forEach((row, index) => {
              const numberCell = row.querySelector('td:first-child');
              if (numberCell) {
                numberCell.textContent = index + 1;
              }
            });
            
            showToast('Question deleted!', 'red');
            
            // Hide the "Ask Founder for Follow Up" button if no questions remain
            const askFounderBtn = document.getElementById('askFounderBtn');
            if (askFounderBtn && remainingRows.length === 0) {
              askFounderBtn.classList.add('hidden');
            }
          }, 300);
        }
      }

      // Initialize edit modal event listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Close modal buttons
        const closeModalBtn = document.getElementById('closeEditModal');
        const cancelBtn = document.getElementById('cancelEditAnalysis');
        const saveBtn = document.getElementById('saveEditAnalysis');

        if (closeModalBtn) {
          closeModalBtn.addEventListener('click', closeEditModal);
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeEditModal);
        }

        if (saveBtn) {
          saveBtn.addEventListener('click', saveEditedAnalysis);
        }

        // Close modal when clicking outside
        const modal = document.getElementById('editAnalysisModal');
        if (modal) {
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              closeEditModal();
            }
          });
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeEditModal();
          }
        });
      });

    </script>
    
    <!-- Edit Analysis Modal -->
    <div id="editAnalysisModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#1E1E21] border border-white/10 rounded-lg w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h3 class="text-xl font-semibold text-white">Edit Analysis</h3>
            <button id="closeEditModal" class="text-white/70 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6 overflow-y-auto flex-1">
            <form id="editAnalysisForm">
              <div class="space-y-6">
                <!-- Analysis Name -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Analysis Name</label>
                  <input type="text" id="editAnalysisName" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent" readonly>
                </div>
                
                <!-- Summary -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Summary</label>
                  <textarea id="editAnalysisSummary" rows="3" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent resize-none"></textarea>
                </div>
                
                <!-- Detailed Analysis -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Detailed Analysis</label>
                  <textarea id="editAnalysisResult" rows="8" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent resize-none"></textarea>
                </div>
                
                <!-- Risk Level -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Risk Level</label>
                  <select id="editRiskLevel" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-accent" style="color: white; background-color: rgba(255, 255, 255, 0.05);">
                    <option value="low" style="background-color: #1E1E21; color: white;">Low</option>
                    <option value="medium" style="background-color: #1E1E21; color: white;">Medium</option>
                    <option value="high" style="background-color: #1E1E21; color: white;">High</option>
                    <option value="critical" style="background-color: #1E1E21; color: white;">Critical</option>
                  </select>
                </div>
                
                <!-- Category Score -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Category Score (0-10)</label>
                  <input type="number" id="editCategoryScore" min="0" max="10" step="0.1" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent">
                </div>
                
                <!-- Overall Score -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">Overall Score (0-100)</label>
                  <input type="number" id="editOverallScore" min="0" max="100" step="0.1" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent">
                </div>
              </div>
            </form>
          </div>
          
          <div class="flex items-center justify-end gap-3 p-6 border-t border-white/10">
            <button id="cancelEditAnalysis" class="px-4 py-2 text-white/70 hover:text-white transition-colors">Cancel</button>
            <button id="saveEditAnalysis" class="px-6 py-2 bg-accent text-[#1E1E21] font-medium rounded-lg hover:bg-accent/90 transition-colors">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    
    
      // Mobile menu functionality
      document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
        const navbar = document.getElementById('pitchlense-navbar');
        if (navbar) {
          navbar.classList.toggle('hidden');
          navbar.classList.toggle('flex');
        }
      });
    <script src="/static/navbar.js"></script>
  </body>
</html>


