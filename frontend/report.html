<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PitchLense — Report</title>
    <script>tailwind=config={};</script>
    <script>
      tailwind.config = { theme: { extend: { colors: { background:'#1E1E21', surface:'#2E3137', text:'#ffffff', secondary:'#cfd4dd', accent:'#f1d85b' }}}}
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        color: #f1d85b;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }
      .markdown-content h1 { font-size: 1.25rem; }
      .markdown-content h2 { font-size: 1.125rem; }
      .markdown-content h3 { font-size: 1rem; }
      .markdown-content p {
        margin-bottom: 0.75rem;
        line-height: 1.5;
      }
      .markdown-content ul, .markdown-content ol {
        margin-left: 1rem;
        margin-bottom: 0.75rem;
      }
      .markdown-content li {
        margin-bottom: 0.25rem;
      }
      .markdown-content strong {
        color: #f1d85b;
        font-weight: 600;
      }
      .markdown-content code {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
      }
      .markdown-content pre {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
      }
      .markdown-content pre code {
        background: none;
        padding: 0;
      }
      .markdown-content blockquote {
        border-left: 3px solid #f1d85b;
        padding-left: 1rem;
        margin-left: 0;
        margin-bottom: 0.75rem;
        color: #cfd4dd;
      }
      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        background-color: rgba(255, 255, 255, 0.02);
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .markdown-content th, .markdown-content td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .markdown-content th {
        background-color: rgba(255, 255, 255, 0.05);
        font-weight: 600;
        color: #f1d85b;
      }
      .markdown-content tr:hover {
        background-color: rgba(255, 255, 255, 0.02);
      }
      .markdown-content hr {
        border: none;
        height: 1px;
        background-color: rgba(255, 255, 255, 0.1);
        margin: 1.5rem 0;
      }
      .markdown-content a {
        color: #f1d85b;
        text-decoration: underline;
      }
      .markdown-content a:hover {
        color: #f1d85b;
        opacity: 0.8;
      }
      
      /* Ensure send button is visible */
      #sendButton {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* Custom scrollbar for tooltip */
      .knowledge-graph-tooltip ::-webkit-scrollbar {
        width: 6px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-thumb {
        background: #f1d85b;
        border-radius: 3px;
      }
      .knowledge-graph-tooltip ::-webkit-scrollbar-thumb:hover {
        background: #e6c547;
      }
      
      /* File view toggle button styles */
      #fileViewToggle {
        transition: background-color 0.3s ease;
      }
      
      #fileViewToggle.bg-accent {
        background-color: #f1d85b;
      }
      
      #toggleThumb {
        transition: transform 0.3s ease;
      }
      
      .file-viewer {
        display: flex;
        flex-direction: column;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body class="bg-background text-text font-sans antialiased overflow-hidden bg-solid h-screen">
    <!-- Page Level Loader -->
    <div id="pageLoader" class="fixed inset-0 bg-background flex items-center justify-center z-50">
      <div class="flex flex-col items-center gap-6">
        <div class="relative">
          <!-- Outer ring -->
          <div class="w-16 h-16 border-4 border-accent/20 border-t-accent rounded-full animate-spin"></div>
          <!-- Inner ring -->
          <div class="absolute inset-2 w-12 h-12 border-4 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
          <!-- Center dot -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-2 h-2 bg-accent rounded-full animate-pulse"></div>
          </div>
        </div>
        <div class="text-center">
          <div class="text-lg font-semibold text-white mb-2">Loading Report</div>
          <div class="text-sm text-secondary">Fetching your report data...</div>
        </div>
      </div>
    </div>

    <div id="app" class="h-screen flex flex-col p-3 gap-3 hidden overflow-hidden">
      <header class="h-16 bg-[#2E3137] border border-white/10 rounded-[22px] flex items-center justify-between px-6 mobile-header">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-accent grid place-items-center"><img src="/static/logo.svg" class="w-5 h-5"/></div>
          <div class="text-base font-semibold">PitchLense</div>
        </div>
        <div class="flex items-center gap-3">
          <div id="searchWrap" class="flex items-center gap-2">
            <button id="searchBtn" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21]">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </button>
            <input id="searchInput" type="text" placeholder="Search" class="h-9 w-0 opacity-0 px-0 bg-[#1E1E21] border border-white/10 rounded-full text-sm text-white/80 outline-none transition-all duration-200" />
          </div>
          <div id="userProfileIcon" class="w-9 h-9 rounded-full border border-white/10 bg-[#FFF27A] grid place-items-center text-[#1E1E21] relative group">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
            </svg>
            <!-- User email tooltip -->
            <div id="userEmailTooltip" class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              <span id="userEmailText">Loading...</span>
              <!-- Tooltip arrow -->
              <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-[#1E1E21]"></div>
            </div>
          </div>
        </div>
      </header>
      
      <div class="grid flex-1 min-h-0 overflow-hidden mobile-navbar" style="grid-template-columns: 84px 1fr; gap:12px;">
      <aside class="bg-[#2C2F34] border border-white/10 rounded-[18px] flex flex-col items-center py-4 gap-3 h-full">
        <nav class="flex flex-col gap-2 text-white/80 w-full items-center">
          <a class="w-10 h-10 grid place-items-center rounded-lg hover:bg-white/10" href="/create-report.html" title="Create">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </a>
          <a class="w-10 h-10 grid place-items-center rounded-lg bg-white/10 hover:bg-white/10" href="/view-report.html" title="Report">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <line x1="9" y1="17" x2="9" y2="11"/>
              <line x1="13" y1="17" x2="13" y2="7"/>
              <line x1="17" y1="17" x2="17" y2="13"/>
            </svg>
          </a>
          <a class="w-10 h-10 grid place-items-center rounded-lg hover:bg-white/10 relative group" href="/extension.html" title="Extension">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
            <!-- Tooltip -->
            <div class="absolute left-full ml-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              Extension
              <!-- Tooltip arrow -->
              <div class="absolute right-full top-1/2 transform -translate-y-1/2 w-0 h-0 border-t-4 border-b-4 border-r-4 border-transparent border-r-[#1E1E21]"></div>
            </div>
          </a>
          <a class="w-10 h-10 grid place-items-center rounded-lg hover:bg-white/10 relative group" href="https://youtu.be/XUuLeXaEIdI" target="_blank" title="How to use PitchLense">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
            <!-- Tooltip -->
            <div class="absolute left-full ml-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
              How to use PitchLense
              <!-- Tooltip arrow -->
              <div class="absolute right-full top-1/2 transform -translate-y-1/2 w-0 h-0 border-t-4 border-b-4 border-r-4 border-transparent border-r-[#1E1E21]"></div>
            </div>
          </a>
        </nav>
        <div class="flex-1"></div>
        <button id="signoutBtn" class="w-10 h-10 grid place-items-center rounded-lg hover:bg-white/10 text-white/80" title="Sign out">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </aside>
      <main class="h-full flex flex-col overflow-hidden mobile-main">
        <!-- Secondary Navigation Bar -->
        <nav class="bg-[#2E3137] border border-white/10 rounded-[18px] mx-2 mb-3 flex-shrink-0 mobile-nav">
          <div class="flex items-center px-6 py-3">
            <button id="overallAnalysisTab" class="tab-button active px-4 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="overall">
              Overall Analysis
            </button>
            <button id="detailedAnalysisTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="detailed">
              Detailed Analysis
            </button>
            <button id="qnaTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="qna">
              QnA
            </button>
            <button id="dependencyTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="dependency">
              Ecosystem Graph
            </button>
            <button id="uploadedFilesTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2" data-tab="files">
              Uploaded Files
            </button>
            <!-- Share Button with Dropdown -->
            <div class="relative ml-auto">
              <button id="shareButton" class="w-9 h-9 grid place-items-center rounded-full bg-[#FFF27A] border border-white/10 text-[#1E1E21] hover:bg-accent/80 transition-colors" title="Share">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                  <polyline points="16,6 12,2 8,6"/>
                  <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
              </button>
              
              <!-- Share Dropdown -->
              <div id="shareDropdown" class="absolute right-0 top-full mt-2 w-48 bg-[#2E3137] border border-white/10 rounded-lg shadow-lg opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                <div class="py-2">
                  <button id="downloadPdfBtn" class="w-full px-4 py-3 text-left text-sm text-white hover:bg-white/5 flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <path d="M16 13H8"/>
                      <path d="M16 17H8"/>
                      <path d="M10 9H8"/>
                    </svg>
                    Download (PDF)
                  </button>
                  <button id="downloadPptxBtn" class="w-full px-4 py-3 text-left text-sm text-white/60 hover:bg-white/5 flex items-center gap-3 cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                      <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    Download (pptx)
                  </button>
                  <button class="w-full px-4 py-3 text-left text-sm text-white/60 hover:bg-white/5 flex items-center gap-3 cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                      <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    Share Email
                  </button>
                </div>
              </div>
            </div>
            
            <button id="documentationTab" class="tab-button px-4 py-2 text-sm font-medium rounded-lg transition-colors ml-2 flex items-center gap-2" data-tab="documentation">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Documentation
            </button>
          </div>
        </nav>
        
        <!-- Tab Content Container -->
        <div class="flex-1 min-h-0 overflow-hidden">
          <!-- Overall Analysis Tab (Default) -->
          <div id="overallAnalysisContent" class="tab-content active overall-analysis h-full overflow-y-auto">
            <section class="p-2 grid gap-3 items-start grid-cols-[2fr_1fr] h-full overflow-hidden">
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div class="card p-0">
                <div class="rounded-xl border border-white/10 relative overflow-hidden" style="height:320px">
                  <canvas id="radarChart" style="width:100%;height:100%;display:block;position:absolute;top:0;left:0;z-index:1"></canvas>
                </div>
              </div>
              <div class="card p-0">
                <div class="rounded-xl border border-white/10 relative overflow-hidden" style="height:320px">
                  <canvas id="marketValueChart" style="width:100%;height:100%;display:block;position:absolute;top:0;left:0;z-index:1;height:100%"></canvas>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="card p-4 flex flex-col" style="height: 360px;">
                <div class="text-sm mb-3">Startup Analysis</div>
                <div class="flex-1 overflow-y-auto">
                  <ul id="startupAnalysisList" class="divide-y divide-white/10">
                    <!-- Startup analysis items will be populated here -->
                </ul>
                    </div>
              </div>
              <div class="card p-4 flex flex-col" style="height: 360px;">
                <div class="flex items-center justify-between">
                  <div class="text-sm">Growth Potential</div>
                  <div class="relative">
                    <button class="px-3 py-1 pill bg-[#1E1E21] border border-white/10 text-white/70 text-sm" id="growthPotentialInfo">i</button>
                    <!-- Tooltip -->
                    <div id="growthPotentialTooltip" class="absolute bottom-full right-0 mb-2 w-80 bg-[#2E3137] border border-white/10 rounded-lg p-4 opacity-0 pointer-events-none transition-all duration-200 z-50">
                      <div class="text-xs text-white/80 mb-2 font-semibold">Growth Potential Calculation</div>
                      <div class="space-y-1 text-xs" id="growthPotentialTooltipContent">
                        <!-- Dynamic content will be populated here -->
                      </div>
                    </div>
              </div>
                </div>
                <div class="flex-1 mt-2"><canvas id="growthPotentialChart" style="width:100%;height:100%;display:block"></canvas></div>
                <div class="mt-3 flex items-center justify-center text-xs">
                  <span class="flex items-center gap-2"><i class="inline-block w-2.5 h-2.5 rounded-full" id="growthPotentialLegend" style="background:#FFF27A"></i> Growth Potential: <span id="growthPotentialScore" class="font-semibold">6.4/10</span></span>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <!-- <div class="card p-4">
              <div class="text-sm mb-3">Your cards</div>
              <div class="rounded-xl p-4" style="background:linear-gradient(135deg,#6b70ff,#b286ff)">
                <div class="text-xs">National WBank</div>
                <div class="mt-6 text-lg tracking-widest">1253 5432 3521 3090</div>
                <div class="mt-2 text-xs">Exp 09/24</div>
              </div>
            </div> -->
            <div class="card p-4" style="height: 320px;">
              <div class="text-sm mb-2">Market Share</div>
              <div id="marketShareContainer" class="h-full overflow-y-auto">
                <!-- Market share data will be populated here -->
                    </div>
                  </div>
            <div class="card p-4 flex flex-col" style="height: 360px;">
              <!-- Tab Navigation -->
              <div class="flex items-center gap-2 mb-4">
                <button id="industryNewsTab" class="tab-button active px-3 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="news">
                  Industry News
                </button>
                <button id="internetDocumentsTab" class="tab-button px-3 py-2 text-sm font-medium rounded-lg transition-colors" data-tab="documents">
                  Internet Documents
                </button>
              </div>
              
              <div class="flex-1 overflow-y-auto">
                <!-- Industry News Content -->
                <div id="industryNewsContent" class="news-tab-content">
                  <!-- Loading State -->
                  <div id="newsLoader" class="flex items-center justify-center py-8">
                    <div class="flex flex-col items-center gap-3">
                      <div class="relative">
                        <div class="w-8 h-8 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 w-8 h-8 border-2 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
                      </div>
                      <div class="text-xs text-secondary">Loading news...</div>
                    </div>
                  </div>
                  <!-- News Content -->
                  <ul id="newsList" class="space-y-3 hidden">
                    <!-- News items will be populated here -->
                  </ul>
                </div>

                <!-- Internet Documents Content -->
                <div id="internetDocumentsContent" class="news-tab-content hidden">
                  <!-- Loading State -->
                  <div id="documentsLoader" class="flex items-center justify-center py-8">
                    <div class="flex flex-col items-center gap-3">
                      <div class="relative">
                        <div class="w-8 h-8 border-2 border-accent/30 border-t-accent rounded-full animate-spin"></div>
                        <div class="absolute inset-0 w-8 h-8 border-2 border-transparent border-t-accent/60 rounded-full animate-spin" style="animation-delay: 0.15s; animation-duration: 0.8s;"></div>
                      </div>
                      <div class="text-xs text-secondary">Loading documents...</div>
                    </div>
                  </div>
                  <!-- Documents Content -->
                  <ul id="documentsList" class="space-y-3 hidden">
                    <!-- Document items will be populated here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
          </div>
          
          <!-- Detailed Analysis Tab -->
          <div id="detailedAnalysisContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Left Sidebar - Analysis Types (20%) -->
                <div class="w-1/5 h-full">
                  <div class="card p-4 h-full flex flex-col">
                    <h3 class="text-sm font-semibold mb-4 text-white flex-shrink-0">Analysis Types</h3>
                    <div id="analysisTypesList" class="space-y-2 flex-1 overflow-y-auto">
                      <!-- Analysis types will be populated here -->
            </div>
                    </div>
                  </div>
                
                <!-- Right Content Area (80%) -->
                <div class="w-4/5 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div id="detailedAnalysisContentArea" class="flex-1 overflow-y-auto">
                      <!-- Content will be populated here -->
                    </div>
                  </div>
                    </div>
                  </div>
            </section>
          </div>
          
          <!-- QnA Tab -->
          <div id="qnaContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Chatbot Card -->
                <div class="flex-1 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-6">
                      <div class="w-10 h-10 rounded-full bg-accent grid place-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                      </div>
                      <div>
                        <h3 class="text-lg font-semibold text-white">Ask Pitchlense</h3>
                      </div>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-4 pr-2">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                          </svg>
                        </div>
                        <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%]">
                          <p class="text-sm text-white">Hello! I'm your AI assistant. I can help you understand your report data, answer questions about the analysis, and provide insights. What would you like to know?</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div class="flex gap-3">
                      <div class="flex-1 relative">
                        <input 
                          id="chatInput" 
                          type="text" 
                          placeholder="Ask a question about your report..." 
                          class="w-full h-12 px-4 pr-12 bg-[#1E1E21] border border-white/10 rounded-lg text-white placeholder:text-white/50 outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
                        />
                        <button 
                          id="sendButton" 
                          class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-accent hover:bg-accent/80 rounded-lg flex items-center justify-center text-white transition-colors z-10 border-2 border-accent"
                          title="Send message"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
          
          <!-- Uploaded Files Tab -->
          <div id="uploadedFilesContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="flex h-full gap-4">
                <!-- Left Sidebar - File Names (20%) -->
                <div class="w-1/5 h-full">
                  <div class="card p-4 h-full flex flex-col">
                    <h3 class="text-sm font-semibold mb-4 text-white flex-shrink-0">Uploaded Files</h3>
                    <div id="uploadedFilesList" class="space-y-2 flex-1 overflow-y-auto">
                      <!-- File names will be populated here -->
                    </div>
                    </div>
                  </div>
                
                <!-- Right Content Area (80%) -->
                <div class="w-4/5 h-full">
                  <div class="card p-6 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                      <h3 class="text-lg font-semibold text-white">File Content</h3>
                      <div class="flex items-center gap-2">
                        <span id="viewModeText" class="text-sm text-white/60">Content View</span>
                        <button id="fileViewToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-gray-800" role="switch">
                          <span id="toggleThumb" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                        </button>
                        <span class="text-sm text-white/60">File View</span>
                      </div>
                    </div>
                    <div id="uploadedFileContentArea" class="flex-1 overflow-y-auto">
                      <!-- File content will be populated here -->
            </div>
              </div>
            </div>
          </div>
        </section>
          </div>
        </div>

          <!-- Dependency Tab -->
          <div id="dependencyContent" class="tab-content hidden h-full overflow-hidden">
            <section class="p-2 h-full">
              <div class="card p-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-white">Knowledge Graph</h3>
                  <div class="flex gap-2">
                    <button id="graphInfoBtn" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">What is this Graph?</button>
                    <button id="zoomIn" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Zoom In</button>
                    <button id="zoomOut" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Zoom Out</button>
                    <button id="resetView" class="px-3 py-1 bg-[#2E3137] text-white rounded text-sm hover:bg-[#3E4147]">Reset</button>
                  </div>
                </div>
                <div class="flex-1 overflow-hidden relative">
                  <div id="knowledgeGraph" class="w-full h-full bg-[#1E1E21] rounded-lg border border-white/10">
                    <!-- D3.js Knowledge Graph will be rendered here -->
                  </div>
                  
                  <!-- Legend Card -->
                  <div class="absolute top-3 left-3 bg-[#2E3137] border border-white/10 rounded-lg p-3 shadow-lg z-10">
                    <div class="text-xs text-white/60 mb-2 font-semibold">Legend</div>
                    <div class="space-y-2">
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Your startup or company name positioned at the center of the graph, representing the focal point of all business relationships.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #f1d85b;"></div>
                        <span class="text-white/80 text-xs">Company</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Your startup or company name positioned at the center of the graph, representing the focal point of all business relationships.</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #3B82F6;"></div>
                        <span class="text-white/80 text-xs">Dependencies</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate.</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-2 cursor-pointer group relative" data-tooltip="Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services.">
                        <div class="w-3 h-3 rounded-full" style="background-color: #10B981;"></div>
                        <span class="text-white/80 text-xs">Customers</span>
                        <!-- Tooltip -->
                        <div class="absolute top-full left-0 mt-2 w-64 bg-[#1E1E21] border border-white/20 rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 shadow-lg">
                          <div class="text-xs text-white/90">Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
      </main>
    </div>

    <!-- Documentation Modal -->
    <div id="documentationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2E3137] border border-white/10 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-semibold text-white flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              PitchLense Documentation
            </h2>
            <button id="closeDocumentation" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="space-y-6">
              <!-- Overview Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Overview</h3>
                <p class="text-white/80 text-sm leading-relaxed">
                  PitchLense is an AI-powered startup analysis platform that provides comprehensive risk assessment and growth potential evaluation for early-stage ventures. Our platform analyzes multiple dimensions of startup risk and provides actionable insights for investors, founders, and stakeholders.
                </p>
              </div>

              <!-- Features Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Key Features</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Overall Analysis</h4>
                    <p class="text-white/70 text-sm">Comprehensive dashboard showing market value trends, risk analysis, growth potential, and startup metrics.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Detailed Analysis</h4>
                    <p class="text-white/70 text-sm">In-depth risk assessment across 9 key dimensions including market, team, product, and financial risks.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Uploaded Files</h4>
                    <p class="text-white/70 text-sm">View and analyze uploaded documents including pitch decks, founder profiles, and business plans.</p>
                  </div>
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2">Industry News</h4>
                    <p class="text-white/70 text-sm">Stay updated with the latest industry news and market trends relevant to your analysis.</p>
                  </div>
                </div>
              </div>

              <!-- Risk Analysis Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Risk Analysis Framework</h3>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#FB5D5D] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">High Risk (7-10)</h4>
                      <p class="text-white/70 text-sm">Critical areas requiring immediate attention and mitigation strategies.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#FFF27A] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">Medium Risk (5-6)</h4>
                      <p class="text-white/70 text-sm">Areas that need monitoring and potential improvement over time.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-[#10B981] mt-2 flex-shrink-0"></div>
                    <div>
                      <h4 class="text-white font-medium">Low Risk (1-4)</h4>
                      <p class="text-white/70 text-sm">Strong areas that represent competitive advantages.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Key Risk Indicators Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Key Risk Indicators Investors Look For</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  Understanding these risk categories helps investors make informed decisions. PitchLense analyzes each of these dimensions to provide comprehensive risk assessment.
                </p>
                
                <div class="space-y-4">
                  <!-- Market Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Market Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Small or overstated TAM (Total Addressable Market)</li>
                      <li>• Weak growth rate in target industry</li>
                      <li>• Overcrowded space with strong incumbents</li>
                      <li>• Lack of differentiation → startup doesn't stand out</li>
                      <li>• Overdependence on a niche (market too narrow)</li>
                    </ul>
                  </div>

                  <!-- Product Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Product Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Product still at idea/MVP stage, no working version</li>
                      <li>• Unclear product–market fit → no proof customers want it</li>
                      <li>• High technical uncertainty → feasibility doubts</li>
                      <li>• Weak IP protection → easily copied by competitors</li>
                      <li>• Poor scalability of product/tech stack</li>
                    </ul>
                  </div>

                  <!-- Team/Founder Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Team / Founder Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Single founder (no co-founders or leadership depth)</li>
                      <li>• High founder churn risk (no vesting, unstable commitment)</li>
                      <li>• Skill gaps in key areas (tech, sales, operations)</li>
                      <li>• Past credibility issues (bad track record, lawsuits)</li>
                      <li>• Misaligned incentives or founder–investor conflicts</li>
                    </ul>
                  </div>

                  <!-- Financial Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Financial Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Inconsistent financial metrics (revenues don't match user growth)</li>
                      <li>• High burn rate with short runway (<12 months)</li>
                      <li>• Overly optimistic projections (inflated TAM, hockey-stick forecasts)</li>
                      <li>• High CAC vs LTV ratio → customer acquisition unsustainable</li>
                      <li>• Low or negative margins with no path to profitability</li>
                      <li>• Dependence on continuous external funding to survive</li>
                    </ul>
                  </div>

                  <!-- Customer & Traction Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Customer & Traction Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Low or no traction despite long time in market</li>
                      <li>• High churn rate (customers dropping off)</li>
                      <li>• Low retention/engagement (DAU/MAU weak)</li>
                      <li>• Lack of marquee customers or paying clients</li>
                      <li>• Dependence on one or two large customers (concentration risk)</li>
                    </ul>
                  </div>

                  <!-- Operational Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Operational Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Weak supply chain or vendor dependencies</li>
                      <li>• No clear go-to-market (GTM) strategy</li>
                      <li>• Inefficient operations → high costs for low output</li>
                      <li>• Poor execution history → delays, missed milestones</li>
                    </ul>
                  </div>

                  <!-- Competitive Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Competitive Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Strong incumbent competitors with deep pockets</li>
                      <li>• Low entry barriers → anyone can replicate</li>
                      <li>• Unclear defensibility (no moat: IP, network effects, brand)</li>
                    </ul>
                  </div>

                  <!-- Legal & Regulatory Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Legal & Regulatory Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Unregulated/grey areas (crypto, healthtech, fintech)</li>
                      <li>• Potential compliance issues (data privacy, labor laws, financial regulations)</li>
                      <li>• Pending lawsuits or legal disputes</li>
                    </ul>
                  </div>

                  <!-- Exit Risks -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#FB5D5D]"></span>
                      Exit Risks
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Unclear exit pathways (IPO, M&A)</li>
                      <li>• Sector with low historical exit activity</li>
                      <li>• Unlikely to attract late-stage investors</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Investment Analysis Framework Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Investment Analysis Framework</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  Investors evaluate startups across multiple dimensions to create a comprehensive risk profile. Here's how PitchLense structures this analysis:
                </p>
                
                <div class="space-y-4">
                  <!-- Market Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Market Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>TAM, SAM, SOM:</strong> Total, Serviceable, and Obtainable markets</li>
                      <li>• <strong>Growth potential:</strong> CAGR, trends, adoption curve</li>
                      <li>• <strong>Competitive landscape:</strong> Incumbents, market crowding</li>
                      <li>• <strong>Differentiation:</strong> Unique value proposition</li>
                    </ul>
                  </div>

                  <!-- Product Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Product Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Stage:</strong> Idea, MVP, early traction, or product–market fit (PMF)</li>
                      <li>• <strong>Technology:</strong> Scalability, defensibility, innovation</li>
                      <li>• <strong>Moat:</strong> Patents, IP, data advantage, network effects</li>
                      <li>• <strong>Customer feedback:</strong> NPS, testimonials, early adoption signals</li>
                    </ul>
                  </div>

                  <!-- Team Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Team Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Founders' background:</strong> Prior startups, industry expertise, network</li>
                      <li>• <strong>Team balance:</strong> Tech, business, ops → complementary skills</li>
                      <li>• <strong>Commitment:</strong> Full-time vs side-project, long-term vision</li>
                      <li>• <strong>Execution ability:</strong> Track record of delivering milestones</li>
                    </ul>
                  </div>

                  <!-- Financial Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Financial Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Unit economics:</strong> CAC (Customer Acquisition Cost), LTV (Lifetime Value)</li>
                      <li>• <strong>Margins:</strong> Gross and net profitability</li>
                      <li>• <strong>Burn rate & runway:</strong> How long till cash runs out</li>
                      <li>• <strong>Revenue quality:</strong> Recurring vs one-off revenue</li>
                      <li>• <strong>Financial projections:</strong> Realistic vs over-optimistic forecasts</li>
                    </ul>
                  </div>

                  <!-- Traction Analysis -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                      <span class="w-2 h-2 rounded-full bg-[#10B981]"></span>
                      Traction Analysis
                    </h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• <strong>Customer base:</strong> Paying vs free users, marquee clients</li>
                      <li>• <strong>Growth rates:</strong> MoM or YoY revenue/users</li>
                      <li>• <strong>Retention & churn:</strong> Product stickiness</li>
                      <li>• <strong>Sales pipeline:</strong> Strong, weak, or non-existent</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Red Flags Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">🚩 Red Flags Investors Look For</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  These warning signs can significantly impact investment decisions and should be carefully evaluated:
                </p>
                
                <div class="space-y-3">
                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Market Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Tiny market or TAM exaggerated by founder</li>
                      <li>• No clear competitive advantage → "me-too startup"</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Product Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• No working MVP after long time</li>
                      <li>• Easily replicable → no moat</li>
                      <li>• Heavy dependence on buzzwords (AI, blockchain) without substance</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Team Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Solo founder → lack of diversity in leadership</li>
                      <li>• Frequent founder conflicts or departures</li>
                      <li>• Lack of skin in the game (founder not full-time or heavily diluted)</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Financial Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Burning too fast with <6 months runway</li>
                      <li>• Unrealistic projections ("10x in 1 year" with no evidence)</li>
                      <li>• Unit economics broken → CAC > LTV</li>
                      <li>• Overly complex or unclear cap table</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Traction Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• No paying customers despite years of work</li>
                      <li>• High churn → customers not staying</li>
                      <li>• Inflated vanity metrics (downloads, signups) without engagement</li>
                    </ul>
                  </div>

                  <div class="bg-[#1E1E21] border border-red-500/20 rounded-lg p-4">
                    <h4 class="text-red-400 font-medium mb-2">Founder / Soft Red Flags</h4>
                    <ul class="text-white/70 text-sm space-y-1">
                      <li>• Lack of transparency in data shared with investors</li>
                      <li>• Pivoting too often without clear rationale</li>
                      <li>• Overconfidence / arrogance → "We don't have competitors" (big red flag)</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Growth Potential Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Growth Potential Calculation</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-3">
                  Our growth potential score is calculated using a weighted formula that considers key startup dimensions:
                </p>
                <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                  <div class="text-sm text-white/80 font-mono">
                    Growth Score = ∑(Dimension Score × Weightage)
                  </div>
                  <div class="mt-3 space-y-1 text-sm">
                    <div class="flex justify-between">
                      <span class="text-white/60">Market Potential</span>
                      <span class="text-white">30%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Product Strength</span>
                      <span class="text-white">10%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Team Quality</span>
                      <span class="text-white">20%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Financial Health</span>
                      <span class="text-white">10%</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-white/60">Traction & Growth</span>
                      <span class="text-white">30%</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Getting Started Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Getting Started</h3>
                <div class="space-y-3">
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">1</div>
                    <div>
                      <h4 class="text-white font-medium">Upload Documents</h4>
                      <p class="text-white/70 text-sm">Upload your pitch deck, founder profile, and other relevant documents for analysis.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">2</div>
                    <div>
                      <h4 class="text-white font-medium">Review Analysis</h4>
                      <p class="text-white/70 text-sm">Examine the overall analysis dashboard for key insights and risk assessments.</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full bg-[#FFF27A] text-[#1E1E21] flex items-center justify-center text-xs font-bold flex-shrink-0">3</div>
                    <div>
                      <h4 class="text-white font-medium">Deep Dive</h4>
                      <p class="text-white/70 text-sm">Use the detailed analysis section to explore specific risk dimensions and recommendations.</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Graph Info Modal -->
    <div id="graphInfoModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-[#2E3137] border border-white/10 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-semibold text-white flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              What is this Graph?
            </h2>
            <button id="closeGraphInfo" class="text-white/60 hover:text-white transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="space-y-6">
              <!-- Overview Section -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Business Logic Overview</h3>
                <p class="text-white/80 text-sm leading-relaxed mb-4">
                  This Ecosystem Graph visualizes the business relationships and dependencies of your company within its market ecosystem. The graph helps you understand how your business connects with other entities in your industry.
                </p>
              </div>

              <!-- Graph Structure -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Graph Structure</h3>
                <div class="space-y-4">
                  <!-- Center Node -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #f1d85b;"></div>
                      <h4 class="text-white font-medium">Center (Yellow)</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Your startup or company name is positioned at the center of the graph, representing the focal point of all business relationships.
                    </p>
                  </div>

                  <!-- Left Side -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #3B82F6;"></div>
                      <h4 class="text-white font-medium">Left Side (Blue) - Dependencies</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Companies, sectors, and industries that your business depends on. These are entities that provide essential services, infrastructure, or resources that your company needs to operate. Examples include suppliers, service providers, technology partners, or industry platforms.
                    </p>
                  </div>

                  <!-- Right Side -->
                  <div class="bg-[#1E1E21] border border-white/10 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                      <div class="w-4 h-4 rounded-full" style="background-color: #10B981;"></div>
                      <h4 class="text-white font-medium">Right Side (Green) - Customers</h4>
                    </div>
                    <p class="text-white/70 text-sm">
                      Companies, sectors, and industries that your business serves or sells its products to. These represent your customer base, target markets, or the entities that purchase your services. Examples include enterprise clients, end consumers, or other businesses in your value chain.
                    </p>
                  </div>
                </div>
              </div>

              <!-- How to Use -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">How to Use</h3>
                <ul class="text-white/70 text-sm space-y-2">
                  <li>• <strong>Hover</strong> over any node to see detailed information about that entity</li>
                  <li>• <strong>Drag</strong> nodes to rearrange the layout (center node cannot be moved)</li>
                  <li>• <strong>Zoom</strong> in/out to focus on specific areas of the graph</li>
                  <li>• <strong>Reset</strong> view to return to the default layout</li>
                </ul>
              </div>

              <!-- Legend -->
              <div>
                <h3 class="text-lg font-semibold text-white mb-3">Legend</h3>
                <div class="grid grid-cols-1 gap-3">
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #f1d85b;"></div>
                    <span class="text-white/70 text-sm">Company - Your business at the center</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #3B82F6;"></div>
                    <span class="text-white/70 text-sm">Dependencies - Entities your business relies on</span>
                  </div>
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: #10B981;"></div>
                    <span class="text-white/70 text-sm">Customers - Entities your business serves</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- Circular Footer with Heart Icon -->
      <footer class="fixed bottom-4 right-4 z-50">
        <!-- Expanded Footer Content (Hidden by default) -->
        <div class="footer-expanded bg-[#2E3137] border border-white/10 rounded-[22px] px-4 py-3 mb-2 opacity-0 transform translate-y-2 pointer-events-none transition-all duration-300 ease-out">
        <div class="flex items-center justify-center gap-2 text-sm text-white/80 whitespace-nowrap overflow-x-auto">
          <span>Created with</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="#ef4444"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <span>by</span>
          <a href="https://amanulla.in/" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors font-medium">Aman Ulla</a>
          <span>,</span>
          <a href="#" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors font-medium">Srinivas Alva</a>
          <span class="text-white/40">|</span>
          <a href="https://vision.hack2skill.com/event/genaiexchangehackathon/?utm_source=hack2skill&utm_medium=homepage#overview" target="_blank" rel="noopener noreferrer" class="text-[#60a5fa] hover:text-white transition-colors">Hack2Skill‑Google Hackathon</a>
          <span class="text-white/40">|</span>
          <div class="flex items-center gap-2">
            <a href="https://github.com/connectaman/PitchLense" target="_blank" rel="noopener noreferrer" title="GitHub" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2C6.48 2 2 6.58 2 12.26c0 4.52 2.87 8.35 6.84 9.71.5.09.68-.22.68-.49 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.37-3.37-1.37-.46-1.2-1.13-1.52-1.13-1.52-.92-.65.07-.64.07-.64 1.02.07 1.56 1.06 1.56 1.06.9 1.58 2.36 1.12 2.94.86.09-.67.35-1.12.63-1.38-2.22-.26-4.56-1.14-4.56-5.08 0-1.12.39-2.04 1.04-2.76-.1-.26-.45-1.32.1-2.75 0 0 .84-.27 2.76 1.05.8-.23 1.66-.35 2.52-.35s1.72.12 2.52.35c1.92-1.32 2.76-1.05 2.76-1.05.55 1.43.2 2.49.1 2.75.65.72 1.04 1.64 1.04 2.76 0 3.95-2.34 4.82-4.57 5.07.36.31.68.93.68 1.88 0 1.35-.01 2.45-.01 2.78 0 .27.18.58.69.48A10.03 10.03 0 0 0 22 12.26C22 6.58 17.52 2 12 2Z"/></svg>
            </a>
            <a href="https://pypi.org/project/pitchlense-mcp/" target="_blank" rel="noopener noreferrer" title="PyPI" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 3a4 4 0 0 1 4 4v3a2 2 0 0 1-2 2H8a4 4 0 0 1-4-4V5a2 2 0 0 1 2-2h6Zm-2 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2Zm2 14a4 4 0 0 1-4-4v-3a2 2 0 0 1 2-2h6a4 4 0 0 1 4 4v3a2 2 0 0 1-2 2h-6Zm2-4a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"/></svg>
            </a>
            <a href="https://pitchlense-mcp.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer" title="Read the Docs" class="w-8 h-8 grid place-items-center rounded-full bg-[#FFF27A] text-[#1E1E21] hover:opacity-80">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 3h12a2 2 0 0 1 2 2v14l-3-2-3 2-3-2-3 2-3-2V5a2 2 0 0 1 2-2Zm2 4v2h8V7H7Zm0 4v2h8v-2H7Z"/></svg>
            </a>
          </div>
          </div>
        </div>
        
        <!-- Circular Heart Icon Button -->
        <div class="footer-circle w-12 h-12 bg-[#2E3137] border border-white/10 rounded-full flex items-center justify-center cursor-pointer hover:bg-[#3a3d44] transition-all duration-300 ease-out shadow-lg hover:shadow-xl">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="#ef4444" class="transition-transform duration-300 ease-out">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </div>
      </footer>
    </div>

    <script>
      // Global variables
      let reportData = null;

      // Tab functionality
      function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button:not([data-tab="news"]):not([data-tab="documents"])');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Handle documentation tab separately
            if (targetTab === 'documentation') {
              openDocumentationModal();
              return;
            }
            
            // Remove active class from all main navigation buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Add active class to clicked button
            button.classList.add('active');
            
            // Show corresponding content
            let targetContent;
            if (targetTab === 'files') {
              targetContent = document.getElementById('uploadedFilesContent');
            } else if (targetTab === 'qna') {
              targetContent = document.getElementById('qnaContent');
            } else if (targetTab === 'dependency') {
              targetContent = document.getElementById('dependencyContent');
            } else {
              targetContent = document.getElementById(`${targetTab}AnalysisContent`);
            }
            if (targetContent) {
              targetContent.classList.remove('hidden');
            }
          });
        });
      }

      // Open documentation modal
      function openDocumentationModal() {
        const modal = document.getElementById('documentationModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      }

      // Close documentation modal
      function closeDocumentationModal() {
        const modal = document.getElementById('documentationModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }
      }

      // Initialize documentation modal
      function initializeDocumentationModal() {
        const documentationBtn = document.getElementById('documentationTab');
        const closeBtn = document.getElementById('closeDocumentation');
        const modal = document.getElementById('documentationModal');
        
        if (documentationBtn) {
          documentationBtn.addEventListener('click', openDocumentationModal);
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeDocumentationModal);
        }
        
        if (modal) {
          // Close modal when clicking outside
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeDocumentationModal();
            }
          });
          
          // Close modal with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeDocumentationModal();
            }
          });
        }
      }

      // PDF Export Functionality
      async function exportToPDF() {
        // Check if jsPDF is available
        if (!window.jspdf || !window.jspdf.jsPDF) {
          throw new Error('jsPDF library not loaded. Please refresh the page and try again.');
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Set up fonts and colors
        doc.setFont('helvetica');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        let yPosition = margin;
        
        // Helper function to add text with word wrapping
        function addText(text, x, y, maxWidth, fontSize = 10, color = '#000000') {
          doc.setFontSize(fontSize);
          doc.setTextColor(color);
          const lines = doc.splitTextToSize(text, maxWidth);
          doc.text(lines, x, y);
          return y + (lines.length * fontSize * 0.35);
        }
        
        // Helper function to add a new page if needed
        function checkNewPage(requiredSpace) {
          if (yPosition + requiredSpace > pageHeight - margin) {
            doc.addPage();
            yPosition = margin;
            return true;
          }
          return false;
        }
        
        
        // Title
        doc.setFontSize(24);
        doc.setTextColor('#1E1E21');
        doc.text('PitchLense Analysis Report', margin, yPosition);
        yPosition += 15;
        
        // Report metadata
        if (window.reportData) {
          const reportData = window.reportData;
          doc.setFontSize(12);
          doc.setTextColor('#666666');
          doc.text(`Generated on: ${new Date().toLocaleDateString()}`, margin, yPosition);
          yPosition += 8;
          
          if (reportData.company_name) {
            doc.text(`Company: ${reportData.company_name}`, margin, yPosition);
            yPosition += 8;
          }
          
          if (reportData.industry) {
            doc.text(`Industry: ${reportData.industry}`, margin, yPosition);
            yPosition += 8;
          }
        }
        
        yPosition += 10;
        
        // Overall Analysis Section
        if (window.analyses) {
          doc.setFontSize(18);
          doc.setTextColor('#1E1E21');
          doc.text('Overall Analysis', margin, yPosition);
          yPosition += 12;
          
          // Overall score
          if (window.overallScore !== undefined) {
            doc.setFontSize(14);
            doc.setTextColor('#f1d85b');
            doc.text(`Overall Risk Score: ${window.overallScore}/10`, margin, yPosition);
            yPosition += 10;
          }
          
          // Risk level
          if (window.overallRiskLevel) {
            doc.setFontSize(12);
            doc.setTextColor('#666666');
            doc.text(`Risk Level: ${window.overallRiskLevel.toUpperCase()}`, margin, yPosition);
            yPosition += 8;
          }
          
          yPosition += 10;
          
          // Analysis categories with scores
          const analysisArray = Object.entries(window.analyses)
            .map(([key, analysis]) => ({
              name: key,
              ...analysis
            }))
            .filter(analysis => analysis.category_score !== undefined && analysis.category_score !== null)
            .sort((a, b) => b.category_score - a.category_score);
          
          doc.setFontSize(14);
          doc.setTextColor('#1E1E21');
          doc.text('Analysis Categories', margin, yPosition);
          yPosition += 10;
          
          analysisArray.forEach((analysis, index) => {
            checkNewPage(15);
            
            // Category name and score
            doc.setFontSize(12);
            doc.setTextColor('#1E1E21');
            doc.text(`${index + 1}. ${analysis.category_name || 'Unknown Category'}`, margin, yPosition);
            
            // Score on the right
            const scoreText = `${analysis.category_score}/10`;
            const scoreWidth = doc.getTextWidth(scoreText);
            doc.text(scoreText, pageWidth - margin - scoreWidth, yPosition);
            
            // Risk level
            if (analysis.overall_risk_level) {
              doc.setFontSize(10);
              doc.setTextColor('#666666');
              doc.text(`Risk: ${analysis.overall_risk_level.toUpperCase()}`, margin + 10, yPosition + 6);
            }
            
            yPosition += 12;
          });
          
          yPosition += 15;
        }
        
        
        
        // Detailed Analysis Section - NEW PAGE
        if (window.analyses) {
          doc.addPage(); // New page for detailed analysis
          yPosition = margin;
          
          doc.setFontSize(18);
          doc.setTextColor('#1E1E21');
          doc.text('Detailed Analysis', margin, yPosition);
          yPosition += 12;
          
          const analysisArray = Object.entries(window.analyses)
            .map(([key, analysis]) => ({
              name: key,
              ...analysis
            }))
            .sort((a, b) => {
              // Put LV-Analysis first
              const aIsLV = a.category_name && a.category_name.toLowerCase().includes('lv-analysis');
              const bIsLV = b.category_name && b.category_name.toLowerCase().includes('lv-analysis');
              if (aIsLV && !bIsLV) return -1;
              if (!aIsLV && bIsLV) return 1;
              return 0;
            });
          
          analysisArray.forEach((analysis, index) => {
            checkNewPage(30);
            
            // Category header
            doc.setFontSize(14);
            doc.setTextColor('#1E1E21');
            doc.text(`${analysis.category_name || 'Analysis'}`, margin, yPosition);
            yPosition += 8;
            
            // Score and risk level
            if (analysis.category_score !== undefined) {
              doc.setFontSize(10);
              doc.setTextColor('#666666');
              doc.text(`Score: ${analysis.category_score}/10`, margin, yPosition);
              if (analysis.overall_risk_level) {
                doc.text(`Risk Level: ${analysis.overall_risk_level.toUpperCase()}`, margin + 50, yPosition);
              }
              yPosition += 6;
            }
            
            // Summary
            if (analysis.summary) {
              doc.setFontSize(10);
              doc.setTextColor('#333333');
              yPosition = addText(`Summary: ${analysis.summary}`, margin, yPosition, pageWidth - 2 * margin, 10, '#333333');
              yPosition += 5;
            }
            
            // Detailed analysis result (for LV-Analysis and detailed business notes)
            const isLVAnalysis = analysis.category_name && analysis.category_name.toLowerCase().includes('lv-analysis');
            const isDetailedBusinessNote = analysis.analysis_type === 'detailed_business_note';
            
            if ((isLVAnalysis || isDetailedBusinessNote) && analysis.result && analysis.result.analysis_result) {
              doc.setFontSize(10);
              doc.setTextColor('#1E1E21');
              doc.text('Detailed Analysis:', margin, yPosition);
              yPosition += 6;
              
              // Convert markdown to plain text for PDF
              const plainText = analysis.result.analysis_result
                .replace(/#{1,6}\s+/g, '') // Remove markdown headers
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold formatting
                .replace(/\*(.*?)\*/g, '$1') // Remove italic formatting
                .replace(/`(.*?)`/g, '$1') // Remove code formatting
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to plain text
                .replace(/\n\n/g, '\n') // Reduce multiple newlines
                .trim();
              
              yPosition = addText(plainText, margin, yPosition, pageWidth - 2 * margin, 9, '#333333');
              yPosition += 10;
            }
            
            // Risk indicators
            if (analysis.indicators && analysis.indicators.length > 0) {
              doc.setFontSize(10);
              doc.setTextColor('#1E1E21');
              doc.text('Risk Indicators:', margin, yPosition);
              yPosition += 6;
              
              analysis.indicators.forEach((indicator, idx) => {
                checkNewPage(20);
                
                doc.setFontSize(9);
                doc.setTextColor('#333333');
                
                // Indicator name
                doc.text(`• ${indicator.indicator || 'Unknown Indicator'}`, margin + 5, yPosition);
                yPosition += 5;
                
                // Description
                if (indicator.description) {
                  yPosition = addText(`  ${indicator.description}`, margin + 5, yPosition, pageWidth - 2 * margin - 10, 8, '#666666');
                  yPosition += 3;
                }
                
                // Recommendation
                if (indicator.recommendation) {
                  doc.setTextColor('#1E1E21');
                  yPosition = addText(`  Recommendation: ${indicator.recommendation}`, margin + 5, yPosition, pageWidth - 2 * margin - 10, 8, '#1E1E21');
                  yPosition += 5;
                }
                
                yPosition += 3;
              });
            }
            
            yPosition += 15;
          });
        }
        
        // Footer
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor('#999999');
          doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
          doc.text('Generated by PitchLense', margin, pageHeight - 10);
        }
        
        // Save the PDF
        const fileName = `PitchLense_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
      }
      
      // Initialize PDF download button
      function initializePDFDownload() {
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        console.log('PDF button found:', downloadPdfBtn); // Debug log
        console.log('jsPDF library available:', !!window.jspdf); // Debug log
        
        if (downloadPdfBtn) {
          downloadPdfBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Close dropdown
            const shareDropdown = document.getElementById('shareDropdown');
            if (shareDropdown) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
            
            // Show loading state
            const originalText = downloadPdfBtn.innerHTML;
            downloadPdfBtn.innerHTML = `
              <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating PDF...
            `;
            downloadPdfBtn.disabled = true;
            
            // Generate PDF
            setTimeout(async () => {
              try {
                await exportToPDF();
              } catch (error) {
                console.error('Error generating PDF:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                alert(`Error generating PDF: ${errorMessage}`);
              } finally {
                // Restore button state
                downloadPdfBtn.innerHTML = originalText;
                downloadPdfBtn.disabled = false;
              }
            }, 100);
          });
        }
      }

      // Initialize share dropdown
      function initializeShareDropdown() {
        const shareButton = document.getElementById('shareButton');
        const shareDropdown = document.getElementById('shareDropdown');
        
        if (shareButton && shareDropdown) {
          // Toggle dropdown on button click
          shareButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = !shareDropdown.classList.contains('invisible');
            
            if (isVisible) {
              // Hide dropdown
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            } else {
              // Show dropdown
              shareDropdown.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!shareButton.contains(e.target) && !shareDropdown.contains(e.target)) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
          
          // Close dropdown with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !shareDropdown.classList.contains('invisible')) {
              shareDropdown.classList.add('opacity-0', 'invisible', 'pointer-events-none');
            }
          });
        }
      }

      // Page loader functions
      function showPageLoader() {
        const loader = document.getElementById('pageLoader');
        if (loader) loader.classList.remove('hidden');
      }

      function hidePageLoader() {
        const loader = document.getElementById('pageLoader');
        const app = document.getElementById('app');
        if (loader) loader.classList.add('hidden');
        if (app) app.classList.remove('hidden');
      }

      // Get report ID from URL
      function getReportIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('report_id');
      }

      // Format date for news items
      function formatNewsDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return dateString;
        }
      }

      // Show loading state
      function showNewsLoader() {
        const loader = document.getElementById('newsLoader');
        const newsList = document.getElementById('newsList');
        if (loader) loader.classList.remove('hidden');
        if (newsList) newsList.classList.add('hidden');
      }

      // Hide loading state
      function hideNewsLoader() {
        const loader = document.getElementById('newsLoader');
        const newsList = document.getElementById('newsList');
        if (loader) loader.classList.add('hidden');
        if (newsList) newsList.classList.remove('hidden');
      }

      // Populate market share section
      function populateMarketShare(marketSizeData) {
        const marketShareContainer = document.getElementById('marketShareContainer');
        if (!marketSizeData || !Array.isArray(marketSizeData) || marketSizeData.length === 0) {
          marketShareContainer.innerHTML = '<div class="text-sm text-secondary text-center py-4">No market data available</div>';
          return;
        }

        marketShareContainer.innerHTML = marketSizeData.map((segment, index) => {
          const colors = ['#f1d85b', '#78e6d0', '#ff6b6b', '#9a8cff', '#60a5fa'];
          const color = colors[index % colors.length];
          
          return `
            <div class="mb-3 last:mb-0">
              <div class="flex items-center justify-between text-xs text-secondary mb-1">
                <span>${segment.segment}</span>
                <span>${segment.share_percent}%</span>
              </div>
              <div class="progress">
                <span style="width:${segment.share_percent}%; background-color:${color};"></span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Create radar chart
      function createRadarChart(radarData) {
        const canvas = document.getElementById('radarChart');
        if (!canvas || !radarData || !radarData.dimensions || !radarData.scores) {
          return;
        }

        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext('2d');

        // Create base connected radar chart with DCDCDD fill
        const baseDataset = {
          label: 'Risk Analysis',
          data: radarData.scores,
          backgroundColor: 'rgba(220, 220, 221, 0.3)',
          borderColor: '#DCDCDD',
          borderWidth: 2,
          pointBackgroundColor: 'transparent',
          pointBorderColor: 'transparent',
          pointBorderWidth: 0,
          pointRadius: 0
        };

        // Create color-coded datasets for individual risk points
        const colorCodedDatasets = radarData.scores.map((score, index) => {
          let color;
          if (score <= 4) {
            color = '#4ade80'; // Green
          } else if (score <= 6) {
            color = '#f1d85b'; // Yellow
          } else {
            color = '#FB5D5D'; // Red
          }
          
          return {
            label: radarData.dimensions[index],
            data: Array(radarData.dimensions.length).fill(0).map((_, i) => i === index ? score : 0),
            backgroundColor: 'transparent',
            borderColor: 'transparent',
            borderWidth: 0,
            pointBackgroundColor: color,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
          };
        });

        // Combine base and color-coded datasets
        const datasets = [baseDataset, ...colorCodedDatasets];

        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: radarData.dimensions,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
              padding: 0
            },
            animation: {
              duration: 2500,
              easing: 'easeOutQuart',
              delay: function(context) {
                if (context.type === 'data' && context.mode === 'default') {
                  return context.dataIndex * 200; // Staggered animation for each dataset
                }
                return 0;
              }
            },
            plugins: {
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255,255,255,0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.parsed.r}/${radarData.scale}`;
                  }
                }
              },
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 11
                  },
                  generateLabels: function(chart) {
                    return [
                      {
                        text: 'Risk Profile',
                        fillStyle: '#DCDCDD',
                        strokeStyle: '#DCDCDD',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 0
                      },
                      {
                        text: 'Low Risk (1-4)',
                        fillStyle: '#4ade80',
                        strokeStyle: '#4ade80',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 1
                      },
                      {
                        text: 'Medium Risk (5-6)',
                        fillStyle: '#f1d85b',
                        strokeStyle: '#f1d85b',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 2
                      },
                      {
                        text: 'High Risk (7-10)',
                        fillStyle: '#FB5D5D',
                        strokeStyle: '#FB5D5D',
                        lineWidth: 2,
                        pointStyle: 'circle',
                        hidden: false,
                        index: 3
                      }
                    ];
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: radarData.scale,
                min: 0,
                ticks: {
                  stepSize: 2,
                  color: '#ffffff',
                  font: {
                    size: 12,
                    weight: 'bold'
                  },
                  backdropColor: 'rgba(0,0,0,0.8)',
                  backdropPadding: 4
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                },
                angleLines: {
                  color: 'rgba(255,255,255,0.1)'
                },
                pointLabels: {
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 10
                  }
                }
              }
            }
          }
        });
      }

      // Helper function to determine risk level from score
      function getOverallRiskLevel(score) {
        if (score >= 8) return 'low';
        if (score >= 6) return 'medium';
        if (score >= 4) return 'high';
        return 'critical';
      }

      // Calculate growth potential score from startup analysis data
      function calculateGrowthPotential(analyses) {
        if (!analyses) return { score: 0, breakdown: [] };
        
        // Define the weightage mapping for Overall Analysis dimensions only
        const weightageMap = {
          'Market Potential': 0.30,    // Market Risk Analysis -> Market Potential
          'Product Strength': 0.10,    // Product Risk Analysis -> Product Strength  
          'Team Quality': 0.20,        // Team Risk Analysis -> Team Quality
          'Financial Health': 0.10,    // Financial Risk Analysis -> Financial Health
          'Traction & Growth': 0.30    // Customer Risk Analysis -> Traction & Growth
        };
        
        // Map API category names to Overall Analysis dimension names
        const categoryMapping = {
          'Market Risks': 'Market Potential',
          'Product Risks': 'Product Strength',
          'Team & Founder Risks': 'Team Quality',
          'Financial Risks': 'Financial Health',
          'Customer & Traction Risks': 'Traction & Growth'
        };
        
        let totalScore = 0;
        const breakdown = [];
        
        // Convert analyses object to array and calculate weighted scores
        Object.entries(analyses).forEach(([key, analysis]) => {
          if (analysis.category_score !== undefined && analysis.category_score !== null) {
            const apiCategoryName = analysis.category_name || key;
            const dimensionName = categoryMapping[apiCategoryName];
            
            if (dimensionName && weightageMap[dimensionName]) {
              const weightage = weightageMap[dimensionName];
              
              // Convert risk score to growth potential score (inverse relationship)
              // Higher risk score (1-10) = Lower growth potential (1-10)
              // Formula: growthScore = 11 - riskScore
              const growthScore = Math.max(1, 11 - analysis.category_score);
              const weightedScore = growthScore * weightage;
              totalScore += weightedScore;
              
              breakdown.push({
                dimension: dimensionName,
                score: Math.round(growthScore * 10) / 10,
                weightage: weightage * 100,
                weightedScore: Math.round(weightedScore * 10) / 10
              });
            }
          }
        });
        
        return {
          score: Math.round(totalScore * 10) / 10,
          breakdown: breakdown
        };
      }

      // Create growth potential donut chart
      function createGrowthPotentialChart(score, maxScore = 10) {
        const canvas = document.getElementById('growthPotentialChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const percentage = (score / maxScore) * 100;
        
        // Destroy existing chart if it exists
        if (window.growthPotentialChartInstance) {
          window.growthPotentialChartInstance.destroy();
        }
        
        // Determine color based on score ranges (1-10 scale)
        let chartColor = '#FFF27A'; // Default yellow (3.5-6.5)
        if (score >= 6.5) {
          chartColor = '#10B981'; // Green for 6.5 and above
        } else if (score < 3.5) {
          chartColor = '#FB5D5D'; // Red for 1-3.5
        }
        
        window.growthPotentialChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: [percentage, 100 - percentage],
              backgroundColor: [chartColor, 'rgba(255,255,255,0.1)'],
              borderWidth: 0,
              cutout: '75%'
            }]
          },
          options: {
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: false
              }
            },
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              animateRotate: true,
              duration: 1000,
              easing: 'easeOutQuart'
            }
          }
        });
        
        // Update the score display and legend color
        const scoreElement = document.getElementById('growthPotentialScore');
        const legendElement = document.getElementById('growthPotentialLegend');
        if (scoreElement) {
          scoreElement.textContent = `${score}/${maxScore}`;
        }
        if (legendElement) {
          legendElement.style.background = chartColor;
        }
      }

      // Update growth potential tooltip with dynamic data
      function updateGrowthPotentialTooltip(breakdown) {
        const tooltipContent = document.getElementById('growthPotentialTooltipContent');
        if (!tooltipContent || !breakdown || breakdown.length === 0) return;
        
        const totalScore = breakdown.reduce((sum, item) => sum + item.weightedScore, 0);
        
        // Update the tooltip content with dynamic data
        const content = `
          <div class="text-xs text-white/70 mb-2 italic">Growth Score = ∑(Dimension Score × Weightage)</div>
          ${breakdown.map(item => `
            <div class="flex justify-between">
              <span class="text-white/60">${item.dimension}</span>
              <span class="text-white">${item.score} × ${item.weightage}% = ${item.weightedScore}</span>
            </div>
          `).join('')}
          <div class="border-t border-white/10 pt-1 mt-2">
            <div class="flex justify-between font-semibold">
              <span class="text-white">Total Score</span>
              <span class="text-[#f1d85b]">${Math.round(totalScore * 10) / 10} / 10</span>
            </div>
          </div>
        `;
        
        tooltipContent.innerHTML = content;
      }

      // Initialize growth potential info button hover functionality
      function initializeGrowthPotentialInfo() {
        const infoButton = document.getElementById('growthPotentialInfo');
        const tooltip = document.getElementById('growthPotentialTooltip');
        
        if (!infoButton || !tooltip) return;
        
        infoButton.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
          tooltip.style.pointerEvents = 'auto';
        });
        
        infoButton.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
          tooltip.style.pointerEvents = 'none';
        });
      }


      // Create market value chart
      function createMarketValueChart(marketValueData) {
        const canvas = document.getElementById('marketValueChart');
        if (!canvas || !marketValueData || !Array.isArray(marketValueData) || marketValueData.length === 0) {
          return;
        }

        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const ctx = canvas.getContext('2d');

        // Prepare data
        const years = marketValueData.map(item => item.year.toString());
        const values = marketValueData.map(item => item.value_usd_billion);
        const maxValue = Math.max(...values);
        
        // Create colors array - yellow for current year and before, DCDCDD for future years
        const currentYear = new Date().getFullYear();
        const barColors = values.map((value, index) => {
          const year = marketValueData[index].year;
          return year <= currentYear ? '#f1d85b' : '#DCDCDD';
        });

        new Chart(ctx, {
          type: 'bar',
          data: { 
            labels: years, 
            datasets: [{ 
              data: values, 
              backgroundColor: barColors, 
              borderRadius: 10, 
              borderSkipped: false 
            }]
          },
          options: {
            responsive: true, 
            maintainAspectRatio: false,
            layout: {
              padding: 0
            },
            animation: {
              duration: 2000,
              easing: 'easeOutQuart',
              delay: function(context) {
                return context.dataIndex * 100; // Staggered animation
              }
            },
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: 'rgba(255,255,255,0.2)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                  title: function(context) {
                    return `Year: ${context[0].label}`;
                  },
                  label: function(context) {
                    return `Market Value: $${context.parsed.y.toFixed(1)}B`;
                  }
                }
              } 
            },
            scales: {
              x: { 
                grid: { display: false }, 
                ticks: { 
                  color: 'rgba(255,255,255,0.6)',
                  maxTicksLimit: years.length,
                  font: {
                    size: 10
                  }
                },
                title: {
                  display: true,
                  text: 'Year',
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              },
              y: { 
                beginAtZero: true, 
                max: Math.ceil(maxValue * 1.1), 
                grid: { color: 'rgba(255,255,255,0.08)' }, 
                ticks: { 
                  callback: (v) => `$${v}B`, 
                  color: 'rgba(255,255,255,0.6)' 
                },
                title: {
                  display: true,
                  text: 'Market Value (USD Billion)',
                  color: 'rgba(255,255,255,0.8)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }

      // Populate news section
      function populateNews(newsData) {
        const newsList = document.getElementById('newsList');
        if (!newsData || !newsData.results || newsData.results.length === 0) {
          newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No news available</li>';
          hideNewsLoader();
          return;
        }

        // Show all news items
        const newsItems = newsData.results;
        newsList.innerHTML = newsItems.map(news => {
          const title = news.title;
          const source = news.source.name;
          const date = formatNewsDate(news.date);
          const sourceIcon = news.source.icon || '📰'; // Use source icon or fallback to news icon
          const link = news.link || '#';
          
          return `
            <li class="group">
              <a href="${link}" target="_blank" rel="noopener noreferrer" class="flex items-start gap-2 text-sm hover:bg-white/5 rounded-lg p-2 transition-colors">
                <div class="w-8 h-8 grid place-items-center rounded-lg bg-white/10 overflow-hidden flex-shrink-0">
                  <img src="${sourceIcon}" alt="${source}" class="w-6 h-6 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <span class="text-xs" style="display:none;">📰</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-white group-hover:text-accent transition-colors leading-tight">${title}</div>
                  <div class="text-xs text-secondary mt-1">${source} • ${date}</div>
                </div>
                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </div>
              </a>
            </li>
          `;
        }).join('');
        
        hideNewsLoader();
      }

      // Populate documents section
      function populateDocuments(documentsData) {
        const documentsList = document.getElementById('documentsList');
        if (!documentsData || !documentsData.results || documentsData.results.length === 0) {
          documentsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No documents available</li>';
          hideDocumentsLoader();
          return;
        }

        // Show all document items
        const documentItems = documentsData.results;
        documentsList.innerHTML = documentItems.map(doc => {
          const title = doc.title;
          const link = doc.link || '#';
          const snippet = doc.snippet || '';
          const displayedLink = doc.displayed_link || link;
          const fileFormat = doc.file_format || 'PDF';
          
          return `
            <li class="group">
              <a href="${link}" target="_blank" rel="noopener noreferrer" class="flex items-start gap-2 text-sm hover:bg-white/5 rounded-lg p-2 transition-colors">
                <div class="w-8 h-8 grid place-items-center rounded-lg bg-white/10 overflow-hidden flex-shrink-0">
                  <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-white group-hover:text-accent transition-colors leading-tight">${title}</div>
                  <div class="text-xs text-secondary mt-1">${displayedLink}</div>
                  ${snippet ? `<div class="text-xs text-white/60 mt-1 line-clamp-2">${snippet}</div>` : ''}
                  <div class="flex items-center gap-2 mt-1">
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-accent/20 text-accent">${fileFormat}</span>
                  </div>
                </div>
                <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </div>
              </a>
            </li>
          `;
        }).join('');
        
        hideDocumentsLoader();
      }

      // Show documents loader
      function showDocumentsLoader() {
        const loader = document.getElementById('documentsLoader');
        const documentsList = document.getElementById('documentsList');
        
        if (loader) loader.classList.remove('hidden');
        if (documentsList) documentsList.classList.add('hidden');
      }

      // Hide documents loader
      function hideDocumentsLoader() {
        const loader = document.getElementById('documentsLoader');
        const documentsList = document.getElementById('documentsList');
        
        if (loader) loader.classList.add('hidden');
        if (documentsList) documentsList.classList.remove('hidden');
      }

      // Tab switching functionality for news/documents
      function switchNewsTab(tabName) {
        const industryNewsTab = document.getElementById('industryNewsTab');
        const internetDocumentsTab = document.getElementById('internetDocumentsTab');
        const industryNewsContent = document.getElementById('industryNewsContent');
        const internetDocumentsContent = document.getElementById('internetDocumentsContent');

        if (tabName === 'news') {
          // Activate news tab
          industryNewsTab.classList.add('active');
          internetDocumentsTab.classList.remove('active');
          
          industryNewsContent.classList.remove('hidden');
          internetDocumentsContent.classList.add('hidden');
        } else if (tabName === 'documents') {
          // Activate documents tab
          internetDocumentsTab.classList.add('active');
          industryNewsTab.classList.remove('active');
          
          internetDocumentsContent.classList.remove('hidden');
          industryNewsContent.classList.add('hidden');
        }
      }

      // Fetch report data
      async function fetchReportData() {
        const reportId = getReportIdFromUrl();
        if (!reportId) {
          console.log('No report ID found in URL');
          // Show content even without report ID
          hidePageLoader();
          return;
        }

        // Show news loader when starting API call
        showNewsLoader();

        try {
          const response = await fetch(`/api/reports/${reportId}/data`, {
            credentials: 'include'
          });

          if (response.status === 401) {
            window.location.href = '/auth.html';
            return;
          }

          if (!response.ok) {
            console.log('Failed to fetch report data');
            // Show error state
            const newsList = document.getElementById('newsList');
            if (newsList) {
              newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">Failed to load news</li>';
              hideNewsLoader();
            }
            hidePageLoader();
            return;
          }

          const result = await response.json();
          reportData = result;
          
          // Store report data globally for PDF export
          window.reportData = result;
          
          // Populate news if available
          if (result.data && result.data.news) {
            populateNews(result.data.news);
          } else {
            // No news data available
            const newsList = document.getElementById('newsList');
            if (newsList) {
              newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No news data available</li>';
              hideNewsLoader();
            }
          }

          // Populate documents if available
          if (result.data && result.data.internet_documents) {
            populateDocuments(result.data.internet_documents);
          } else {
            // No documents data available
            const documentsList = document.getElementById('documentsList');
            if (documentsList) {
              documentsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">No documents data available</li>';
              hideDocumentsLoader();
            }
          }

          // Populate market share if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.market_size) {
            populateMarketShare(result.data.startup_analysis.market_size);
          } else {
            // No market share data available
            const marketShareContainer = document.getElementById('marketShareContainer');
            if (marketShareContainer) {
              marketShareContainer.innerHTML = '<div class="text-sm text-secondary text-center py-4">No market data available</div>';
            }
          }

          // Create market value chart if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.market_value) {
            createMarketValueChart(result.data.startup_analysis.market_value);
          }

          // Create radar chart if available
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.radar_chart) {
            createRadarChart(result.data.startup_analysis.radar_chart);
          }

          // Populate startup analysis data
          if (result.data && result.data.startup_analysis && result.data.startup_analysis.analyses) {
            populateStartupAnalysis(result.data.startup_analysis.analyses);
            populateDetailedAnalysisTypes(result.data.startup_analysis.analyses);
            
            // Calculate and display growth potential
            const growthPotential = calculateGrowthPotential(result.data.startup_analysis.analyses);
            createGrowthPotentialChart(growthPotential.score);
            updateGrowthPotentialTooltip(growthPotential.breakdown);
            
            // Store overall score and risk level globally for PDF export
            window.overallScore = growthPotential.score;
            window.overallRiskLevel = getOverallRiskLevel(growthPotential.score);
          }

          // Populate uploaded files data
          if (result.data && result.data.files && Array.isArray(result.data.files)) {
            populateUploadedFiles(result.data.files);
          }

          
          // Hide page loader after successful data fetch
          hidePageLoader();
        } catch (error) {
          console.error('Error fetching report data:', error);
          // Show error state
          const newsList = document.getElementById('newsList');
          if (newsList) {
            newsList.innerHTML = '<li class="text-sm text-secondary text-center py-4">Error loading news</li>';
            hideNewsLoader();
          }
          hidePageLoader();
        }
      }

      // Function to populate startup analysis data
      function populateStartupAnalysis(analyses) {
        // Store analyses data globally for PDF export
        window.analyses = analyses;
        
        const analysisList = document.getElementById('startupAnalysisList');
        if (!analysisList || !analyses) {
          return;
        }

        // Clear existing content
        analysisList.innerHTML = '';

        // Define colors for different risk levels
        const getRiskColor = (riskLevel) => {
          switch (riskLevel) {
            case 'low': return '#4ade80'; // Green
            case 'medium': return '#f1d85b'; // Yellow
            case 'high': return '#ff6b6b'; // Red
            case 'critical': return '#ef4444'; // Dark red
            default: return '#9a8cff'; // Purple
          }
        };

        // Convert analyses object to array, filter out undefined ratings, and sort by category score
        const analysisArray = Object.entries(analyses)
          .map(([key, analysis]) => ({
            name: key,
            ...analysis
          }))
          .filter(analysis => analysis.category_score !== undefined && analysis.category_score !== null)
          .sort((a, b) => b.category_score - a.category_score);

        // Create list items for each analysis
        analysisArray.forEach(analysis => {
          const percentage = (analysis.category_score / 10) * 100;
          const color = getRiskColor(analysis.overall_risk_level);
          
          // Create main analysis item
          const listItem = document.createElement('li');
          listItem.className = 'py-3';
          
          // Main analysis header
          const headerDiv = document.createElement('div');
          headerDiv.className = 'flex items-center gap-3 mb-2';
          headerDiv.innerHTML = `
            <span class="relative inline-grid place-items-center w-10 h-10 rounded-full" style="background:conic-gradient(${color} 0 ${percentage}%, transparent ${percentage}% 100%);">
              <span class="w-7 h-7 rounded-full bg-[#2E3137] grid place-items-center text-xs">${analysis.category_score}</span>
            </span>
            <div class="flex-1">
              <div class="text-sm">${analysis.category_name}</div>
              <div class="text-xs text-secondary">Risk: ${analysis.overall_risk_level}</div>
            </div>
            <div class="text-right text-xs">
              <div class="text-secondary">Score</div>
              <div class="text-white">${analysis.category_score}/10</div>
            </div>
          `;
          
          listItem.appendChild(headerDiv);
          
          // Add indicators if they exist
          if (analysis.indicators && Array.isArray(analysis.indicators)) {
            const indicatorsDiv = document.createElement('div');
            indicatorsDiv.className = 'ml-13 space-y-1';
            
            analysis.indicators.forEach(indicator => {
              if (indicator.score !== undefined && indicator.score !== null) {
                const indicatorPercentage = (indicator.score / 10) * 100;
                const indicatorColor = getRiskColor(indicator.risk_level);
                
                const indicatorItem = document.createElement('div');
                indicatorItem.className = 'flex items-center gap-2 text-xs';
                indicatorItem.innerHTML = `
                  <span class="relative inline-grid place-items-center w-6 h-6 rounded-full" style="background:conic-gradient(${indicatorColor} 0 ${indicatorPercentage}%, transparent ${indicatorPercentage}% 100%);">
                    <span class="w-4 h-4 rounded-full bg-[#2E3137] grid place-items-center text-xs" style="font-size: 8px;">${indicator.score}</span>
                  </span>
                  <div class="flex-1">
                    <div class="text-xs text-white/80">${indicator.indicator}</div>
                    <div class="text-xs text-white/50">${indicator.risk_level} (${indicator.score}/10)</div>
                  </div>
                `;
                
                indicatorsDiv.appendChild(indicatorItem);
              }
            });
            
            if (indicatorsDiv.children.length > 0) {
              listItem.appendChild(indicatorsDiv);
            }
          }
          
          analysisList.appendChild(listItem);
        });
      }

      // Function to populate detailed analysis types
      function populateDetailedAnalysisTypes(analyses) {
        const analysisTypesList = document.getElementById('analysisTypesList');
        if (!analysisTypesList || !analyses) {
          return;
        }

        // Clear existing content
        analysisTypesList.innerHTML = '';

        // Convert analyses object to array and prioritize LV-Analysis
        const analysisArray = Object.entries(analyses).map(([key, analysis]) => ({
          name: key,
          ...analysis
        })).sort((a, b) => {
          // Put LV-Analysis first
          const aIsLV = a.category_name && a.category_name.toLowerCase().includes('lv-analysis');
          const bIsLV = b.category_name && b.category_name.toLowerCase().includes('lv-analysis');
          
          if (aIsLV && !bIsLV) return -1;
          if (!aIsLV && bIsLV) return 1;
          return 0; // Keep original order for non-LV analyses
        });

        // Create analysis type buttons
        analysisArray.forEach((analysis, index) => {
          const button = document.createElement('button');
          button.className = `analysis-type-btn w-full text-left px-3 py-2 rounded-lg text-sm transition-all duration-200 ${index === 0 ? 'active' : ''}`;
          button.textContent = analysis.category_name;
          button.setAttribute('data-analysis-key', analysis.name);
          
          button.addEventListener('click', () => {
            // Remove active class from all buttons
            document.querySelectorAll('.analysis-type-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Show detailed content
            showDetailedAnalysisContent(analysis);
          });
          
          analysisTypesList.appendChild(button);
        });

        // Show first analysis by default
        if (analysisArray.length > 0) {
          showDetailedAnalysisContent(analysisArray[0]);
        }
      }

      // Function to show detailed analysis content
      function showDetailedAnalysisContent(analysis) {
        const contentArea = document.getElementById('detailedAnalysisContentArea');
        if (!contentArea) {
          return;
        }

        // Create content with animation
        contentArea.style.opacity = '0';
        contentArea.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
          // Debug: Log the analysis object to see its structure
          console.log('Analysis object:', analysis);
          console.log('Analysis type:', analysis.analysis_type);
          console.log('Analysis result:', analysis.result);
          
          // Check if this is a detailed business note with analysis_result
          let analysisResultContent = '';
          
          // Check for LV-Analysis specifically or detailed business note
          const isLVAnalysis = analysis.category_name && analysis.category_name.toLowerCase().includes('lv-analysis');
          const hasAnalysisResult = analysis.result && analysis.result.analysis_result;
          const isDetailedBusinessNote = analysis.analysis_type === 'detailed_business_note';
          
          if ((isLVAnalysis || isDetailedBusinessNote) && hasAnalysisResult) {
            try {
              // Render the analysis_result as markdown
              const markdownContent = marked.parse(analysis.result.analysis_result);
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                  <div class="markdown-content text-white/80 leading-relaxed">
                    ${markdownContent}
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Error parsing markdown:', error);
              // Fallback to plain text if markdown parsing fails
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                  <div class="text-white/80 leading-relaxed whitespace-pre-wrap">
                    ${analysis.result.analysis_result}
                  </div>
                </div>
              `;
            }
          } else if (isLVAnalysis) {
            // Additional fallback for LV-Analysis - check other possible data structures
            console.log('LV-Analysis detected but no analysis_result found. Checking other fields...');
            
            // Check if the analysis result is directly in the result object
            if (analysis.result && typeof analysis.result === 'string') {
              try {
                const markdownContent = marked.parse(analysis.result);
                analysisResultContent = `
                  <div class="mb-6">
                    <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                    <div class="markdown-content text-white/80 leading-relaxed">
                      ${markdownContent}
                    </div>
                  </div>
                `;
              } catch (error) {
                analysisResultContent = `
                  <div class="mb-6">
                    <h3 class="text-lg font-medium text-white mb-4">Detailed Analysis</h3>
                    <div class="text-white/80 leading-relaxed whitespace-pre-wrap">
                      ${analysis.result}
                    </div>
                  </div>
                `;
              }
            }
            // Check if there's a summary or other content we can display
            else if (analysis.summary) {
              analysisResultContent = `
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-4">Analysis Summary</h3>
                  <div class="text-white/80 leading-relaxed">
                    ${analysis.summary}
                  </div>
                </div>
              `;
            }
          }

          contentArea.innerHTML = `
            <div class="analysis-content">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h2 class="text-xl font-semibold text-white mb-2">${analysis.category_name || 'Analysis'}</h2>
                  <div class="flex items-center gap-4">
                    ${analysis.overall_risk_level ? `
                      <span class="px-3 py-1 rounded-full text-xs font-medium ${getRiskLevelClass(analysis.overall_risk_level)}">
                        ${analysis.overall_risk_level.toUpperCase()} RISK
                      </span>
                    ` : ''}
                    <span class="text-sm text-white/70">Score: ${analysis.category_score || 'N/A'}/10</span>
                  </div>
                </div>
              </div>
              
              <div class="mb-6">
                <h3 class="text-lg font-medium text-white mb-3">Summary</h3>
                <p class="text-white/80 leading-relaxed">${analysis.summary || 'No summary available'}</p>
              </div>
              
              ${analysisResultContent}
              
              <div class="mb-6">
                <h3 class="text-lg font-medium text-white mb-4">Risk Indicators</h3>
                <div class="space-y-4">
                  ${analysis.indicators ? analysis.indicators.map(indicator => `
                    <div class="indicator-card p-4 rounded-lg border border-white/10">
                      <div class="flex items-start justify-between mb-3">
                        <h4 class="font-medium text-white">${indicator.indicator || 'Unknown Indicator'}</h4>
                        <div class="flex items-center gap-2">
                          ${indicator.risk_level ? `
                            <span class="px-2 py-1 rounded text-xs font-medium ${getRiskLevelClass(indicator.risk_level)}">
                              ${indicator.risk_level.toUpperCase()}
                            </span>
                          ` : ''}
                          <span class="text-sm text-white/70">${indicator.score || 'N/A'}/10</span>
                        </div>
                      </div>
                      <p class="text-white/70 text-sm mb-3">${indicator.description || 'No description available'}</p>
                      <div class="recommendation p-3 bg-white/5 rounded border-l-4 border-accent">
                        <p class="text-sm text-white/80"><strong>Recommendation:</strong> ${indicator.recommendation || 'No recommendation available'}</p>
                      </div>
                    </div>
                  `).join('') : '<p class="text-white/70">No indicators available</p>'}
                </div>
              </div>
            </div>
          `;
          
          // Animate in
          contentArea.style.transition = 'all 0.3s ease-out';
          contentArea.style.opacity = '1';
          contentArea.style.transform = 'translateX(0)';
        }, 150);
      }

      // Helper function to get risk level CSS class
      function getRiskLevelClass(riskLevel) {
        switch (riskLevel) {
          case 'low': return 'bg-green-500/20 text-green-400 border border-green-500/30';
          case 'medium': return 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
          case 'high': return 'bg-red-500/20 text-red-400 border border-red-500/30';
          case 'critical': return 'bg-red-600/20 text-red-300 border border-red-600/30';
          default: return 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
        }
      }

      // Global variables for file viewing
      let isFileViewMode = false;
      let currentFileData = null;
      let fileUrls = null;

      // Initialize file view toggle
      function initializeFileViewToggle() {
        const toggleButton = document.getElementById('fileViewToggle');
        const toggleThumb = document.getElementById('toggleThumb');
        const viewModeText = document.getElementById('viewModeText');

        if (toggleButton && toggleThumb && viewModeText) {
          toggleButton.addEventListener('click', async () => {
            isFileViewMode = !isFileViewMode;
            
            // Update toggle appearance
            if (isFileViewMode) {
              toggleButton.classList.remove('bg-gray-600');
              toggleButton.classList.add('bg-accent');
              toggleThumb.classList.remove('translate-x-1');
              toggleThumb.classList.add('translate-x-6');
              viewModeText.textContent = 'File View';
            } else {
              toggleButton.classList.remove('bg-accent');
              toggleButton.classList.add('bg-gray-600');
              toggleThumb.classList.remove('translate-x-6');
              toggleThumb.classList.add('translate-x-1');
              viewModeText.textContent = 'Content View';
            }

            // Refresh current file display
            if (currentFileData) {
              await showUploadedFileContent(currentFileData);
            }
          });
        }
      }

      // Function to fetch file URLs for current report
      async function fetchFileUrls() {
        try {
          const reportId = window.location.search.match(/report_id=([^&]+)/)?.[1];
          if (!reportId) return null;

          const response = await fetch(`/api/reports/${reportId}/uploads`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('Failed to fetch file URLs');
          }

          const data = await response.json();
          return data.files;
        } catch (error) {
          console.error('Error fetching file URLs:', error);
          return null;
        }
      }

      // Function to render file viewer based on file type
      function renderFileViewer(file) {
        const extension = file.filename.split('.').pop()?.toLowerCase();
        
        if (!file.public_url) {
          return `
            <div class="flex items-center justify-center h-full">
              <div class="text-center">
                <p class="text-red-400 mb-2">Unable to load file</p>
                <p class="text-white/60 text-sm">${file.error || 'File URL not available'}</p>
              </div>
            </div>
          `;
        }

        switch (extension) {
          case 'pdf':
            return `
              <div class="h-full">
                <iframe 
                  src="${file.public_url}" 
                  class="w-full h-full border-0 rounded-lg"
                  title="${file.filename}">
                </iframe>
              </div>
            `;
          
          case 'png':
          case 'jpg':
          case 'jpeg':
          case 'gif':
          case 'webp':
            return `
              <div class="flex items-center justify-center h-full">
                <img 
                  src="${file.public_url}" 
                  alt="${file.filename}"
                  class="max-w-full max-h-full object-contain rounded-lg"
                />
              </div>
            `;
          
          case 'pptx':
          case 'docx':
          case 'doc':
          case 'ppt':
            return `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-accent mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-white mb-2">${file.filename}</h3>
                  <p class="text-white/60 mb-4">This file type cannot be previewed directly in the browser.</p>
                  <a 
                    href="${file.public_url}" 
                    target="_blank" 
                    class="inline-flex items-center px-4 py-2 bg-accent text-black rounded-lg font-medium hover:bg-accent/90 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download & Open
                  </a>
                </div>
              </div>
            `;
          
          default:
            return `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <div class="mb-4">
                    <svg class="w-16 h-16 mx-auto text-accent mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-white mb-2">${file.filename}</h3>
                  <p class="text-white/60 mb-4">File preview not available for this file type.</p>
                  <a 
                    href="${file.public_url}" 
                    target="_blank" 
                    class="inline-flex items-center px-4 py-2 bg-accent text-black rounded-lg font-medium hover:bg-accent/90 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Download File
                  </a>
                </div>
              </div>
            `;
        }
      }

      // Function to populate uploaded files list
      function populateUploadedFiles(files) {
        const uploadedFilesList = document.getElementById('uploadedFilesList');
        if (!uploadedFilesList || !files || !Array.isArray(files)) {
          return;
        }

        // Clear existing content
        uploadedFilesList.innerHTML = '';

        // Check if files array is empty
        if (files.length === 0) {
          uploadedFilesList.innerHTML = '<p class="text-white/60 text-sm">No files uploaded yet</p>';
          return;
        }

        // Create file buttons
        files.forEach((file, index) => {
          const button = document.createElement('button');
          button.className = `file-btn w-full text-left px-3 py-2 rounded-lg text-sm transition-all duration-200 ${index === 0 ? 'active' : ''}`;
          button.textContent = file.filename;
          button.setAttribute('data-file-index', index);
          
          button.addEventListener('click', async () => {
            // Remove active class from all buttons
            document.querySelectorAll('.file-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Show file content
            await showUploadedFileContent(file);
          });
          
          uploadedFilesList.appendChild(button);
        });

        // Show first file by default
        if (files.length > 0) {
          showUploadedFileContent(files[0]).catch(console.error);
        } else {
          // Show empty state message
          const contentArea = document.getElementById('uploadedFileContentArea');
          if (contentArea) {
            contentArea.innerHTML = `
              <div class="flex items-center justify-center h-full">
                <div class="text-center">
                  <p class="text-white/60 text-lg mb-2">No files uploaded</p>
                  <p class="text-white/40 text-sm">Upload files to view their content here</p>
                </div>
              </div>
            `;
          }
        }
      }

      // Function to show uploaded file content
      async function showUploadedFileContent(file) {
        const contentArea = document.getElementById('uploadedFileContentArea');
        if (!contentArea) {
          return;
        }

        // Store current file data
        currentFileData = file;

        // Create content with animation
        contentArea.style.opacity = '0';
        contentArea.style.transform = 'translateX(20px)';
        
        setTimeout(async () => {
          let contentHtml = '';

          if (isFileViewMode) {
            // File view mode - show actual file
            if (!fileUrls) {
              fileUrls = await fetchFileUrls();
            }

            // Find the matching file URL data
            const fileUrlData = fileUrls?.find(f => f.filename === file.filename);
            
            if (fileUrlData) {
              contentHtml = `
                <div class="file-viewer h-full">
                  <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <div>
                      <h2 class="text-xl font-semibold text-white mb-2">${file.filename}</h2>
                      <div class="flex items-center gap-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">
                          ${file.filetype.toUpperCase()}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-500/20 text-gray-400 border border-gray-500/30">
                          ${file.file_extension.toUpperCase()}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="flex-1 overflow-hidden">
                    ${renderFileViewer({ ...file, public_url: fileUrlData.public_url, error: fileUrlData.error })}
                  </div>
                </div>
              `;
            } else {
              contentHtml = `
                <div class="flex items-center justify-center h-full">
                  <div class="text-center">
                    <p class="text-red-400 mb-2">File not found</p>
                    <p class="text-white/60 text-sm">Unable to retrieve file URL</p>
                  </div>
                </div>
              `;
            }
          } else {
            // Content view mode - show file content as before
            contentHtml = `
              <div class="file-content">
                <div class="flex items-center justify-between mb-6">
                  <div>
                    <h2 class="text-xl font-semibold text-white mb-2">${file.filename}</h2>
                    <div class="flex items-center gap-4">
                      <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 border border-blue-500/30">
                        ${file.filetype.toUpperCase()}
                      </span>
                      <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-500/20 text-gray-400 border border-gray-500/30">
                        ${file.file_extension.toUpperCase()}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="mb-6">
                  <h3 class="text-lg font-medium text-white mb-3">File Content</h3>
                  <div class="bg-white/5 rounded-lg p-4 border border-white/10">
                    <div class="text-white/80 leading-relaxed whitespace-pre-wrap">${file.content}</div>
                  </div>
                </div>
              </div>
            `;
          }

          contentArea.innerHTML = contentHtml;
          
          // Animate in
          contentArea.style.transition = 'all 0.3s ease-out';
          contentArea.style.opacity = '1';
          contentArea.style.transform = 'translateX(0)';
        }, 150);
      }

      // Initialize page
      // Chat functionality
      function initializeChat() {
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        function addMessage(message, isUser = false) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
          
          if (isUser) {
            messageDiv.innerHTML = `
              <div class="bg-accent text-white rounded-lg p-3 max-w-[80%]">
                <p class="text-sm">${message}</p>
              </div>
              <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
                </svg>
              </div>
            `;
          } else {
            // Render markdown for AI responses
            const htmlContent = marked.parse(message);
            messageDiv.innerHTML = `
              <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%] prose prose-invert prose-sm max-w-none">
                <div class="text-sm text-white markdown-content">${htmlContent}</div>
              </div>
            `;
          }
          
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
          const message = chatInput.value.trim();
          if (!message) return;

          // Add user message
          addMessage(message, true);
          chatInput.value = '';

          // Show loading indicator
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'flex items-start gap-3';
          loadingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-accent/20 grid place-items-center flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <div class="bg-[#2E3137] border border-white/10 rounded-lg p-3 max-w-[80%]">
              <div class="flex items-center gap-2">
                <span class="text-sm text-white/70">Generating answer</span>
                <div class="flex gap-1">
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce"></div>
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                  <div class="w-1 h-1 bg-accent rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                </div>
              </div>
            </div>
          `;
          chatMessages.appendChild(loadingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          try {
            // Get report ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report_id');
            
            if (!reportId) {
              throw new Error('Report ID not found');
            }

            // Call the QnA API
            const response = await fetch('/api/qna/ask', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'include',
              body: JSON.stringify({
                report_id: reportId,
                question: message
              })
            });

            // Remove loading indicator
            chatMessages.removeChild(loadingDiv);

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Failed to get response');
            }

            const data = await response.json();
            addMessage(data.response);

          } catch (error) {
            // Remove loading indicator
            chatMessages.removeChild(loadingDiv);
            addMessage(`Sorry, I encountered an error: ${error.message}`);
          }
        }

        // Load chat history
        async function loadChatHistory() {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report_id');
            
            if (!reportId) return;

            const response = await fetch(`/api/qna/history/${reportId}`, {
              credentials: 'include'
            });

            if (response.ok) {
              const data = await response.json();
              if (data.success && data.chats.length > 0) {
                // Clear existing messages except the welcome message
                const welcomeMessage = chatMessages.querySelector('.flex.items-start.gap-3');
                chatMessages.innerHTML = '';
                if (welcomeMessage) {
                  chatMessages.appendChild(welcomeMessage);
                }

                // Add chat history
                data.chats.forEach(chat => {
                  addMessage(chat.user_message, true);
                  addMessage(chat.ai_response, false);
                });
              }
            }
          } catch (error) {
            console.error('Failed to load chat history:', error);
          }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });

        // Load chat history when QnA tab is opened
        const qnaTab = document.getElementById('qnaTab');
        if (qnaTab) {
          qnaTab.addEventListener('click', loadChatHistory);
        }

        // Initialize knowledge graph when Dependency tab is opened
        const dependencyTab = document.getElementById('dependencyTab');
        if (dependencyTab) {
          dependencyTab.addEventListener('click', () => {
            // Wait a bit for any pending data loading, then initialize
            setTimeout(() => {
              console.log('Initializing knowledge graph - checking data availability');
              console.log('window.reportData:', window.reportData);
              initializeKnowledgeGraph();
            }, 200);
          });
        }
      }

      // Knowledge Graph Visualization
      function initializeKnowledgeGraph() {
        const container = document.getElementById('knowledgeGraph');
        if (!container) return;

        // Clear any existing content
        container.innerHTML = '';

        // Set up SVG dimensions - use full container width
        const width = container.clientWidth || 800;
        const height = container.clientHeight || 600;

        // Create SVG that fills the container
        const svg = d3.select('#knowledgeGraph')
          .append('svg')
          .attr('width', '100%')
          .attr('height', '100%')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .attr('preserveAspectRatio', 'xMidYMid meet')
          .style('display', 'block');

        // Create tooltip div
        const tooltip = d3.select('body')
          .append('div')
          .attr('class', 'knowledge-graph-tooltip')
          .style('position', 'fixed') // Changed to fixed for better positioning
          .style('background-color', '#2E3137')
          .style('color', '#ffffff')
          .style('padding', '12px')
          .style('border-radius', '8px')
          .style('border', '1px solid #f1d85b')
          .style('font-size', '12px')
          .style('pointer-events', 'auto') // Allow interaction with tooltip
          .style('opacity', 0)
          .style('z-index', 1000)
          .style('max-width', '600px') // Limit width (2x increase)
          .style('word-wrap', 'break-word') // Handle long text
          .style('box-shadow', '0 4px 12px rgba(0, 0, 0, 0.3)'); // Add shadow for better visibility

        // Tooltip state management
        let tooltipTimeout;
        let tooltipVisible = false;

        // Zoom behavior
        const zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on('zoom', function(event) {
            g.attr('transform', event.transform);
          });

        svg.call(zoom);

        // Main group for all elements
        const g = svg.append('g');

        // Use actual API data or fallback to sample data
        let apiKnowledgeGraph = window.reportData?.data?.knowledge_graph;

        console.log('=== KNOWLEDGE GRAPH DEBUG INFO ===');
        console.log('window.reportData:', window.reportData);
        console.log('window.reportData exists:', !!window.reportData);
        console.log('window.reportData structure:', window.reportData ? Object.keys(window.reportData) : 'No reportData');
        console.log('window.reportData.startup_analysis exists:', !!window.reportData?.startup_analysis);
        console.log('window.reportData.data.knowledge_graph exists:', !!window.reportData?.data?.knowledge_graph);
        console.log('Raw API knowledge graph data:', apiKnowledgeGraph);
        console.log('API data type:', typeof apiKnowledgeGraph);
        console.log('API data keys:', apiKnowledgeGraph ? Object.keys(apiKnowledgeGraph) : 'No API data');

        if (apiKnowledgeGraph) {
          console.log('API data structure check:');
          console.log('  - root exists:', !!apiKnowledgeGraph.root);
          console.log('  - root id:', apiKnowledgeGraph.root?.id);
          console.log('  - nodes exists:', !!apiKnowledgeGraph.nodes);
          console.log('  - nodes length:', apiKnowledgeGraph.nodes?.length || 0);
          console.log('  - edges exists:', !!apiKnowledgeGraph.edges);
          console.log('  - edges length:', apiKnowledgeGraph.edges?.length || 0);

          // Check first few nodes to ensure they have proper structure
          if (apiKnowledgeGraph.nodes && apiKnowledgeGraph.nodes.length > 0) {
            console.log('First node structure:', apiKnowledgeGraph.nodes[0]);
            console.log('First node id:', apiKnowledgeGraph.nodes[0]?.id);
            console.log('First node name:', apiKnowledgeGraph.nodes[0]?.name);
          }
        }

        // If no data available, try again in a moment (data might be loading)
        if (!apiKnowledgeGraph && window.reportData) {
          console.log('No knowledge graph data yet, but report data exists - data might be loading');
        }

        // Transform API data to proper format for D3.js
        let knowledgeGraph;

        // Check if we have valid data right away
        if (apiKnowledgeGraph && apiKnowledgeGraph.nodes && apiKnowledgeGraph.nodes.length > 0) {
          console.log('Processing API data immediately - nodes found:', apiKnowledgeGraph.nodes.length);
          processApiData();
        } else if (apiKnowledgeGraph && apiKnowledgeGraph.root) {
          console.log('Processing API data immediately - root found');
          processApiData();
        } else {
          console.log('No valid knowledge graph data found, starting wait process...');

          // Wait for data if it's not available yet
          function waitForData(attempt = 0) {
            const maxAttempts = 5;
            const delayMs = 300;

            // Re-fetch the data in case it loaded while we were waiting
            apiKnowledgeGraph = window.reportData?.data?.knowledge_graph;

            console.log(`Wait attempt ${attempt + 1}: checking data availability`);

            if (apiKnowledgeGraph && apiKnowledgeGraph.nodes && apiKnowledgeGraph.nodes.length > 0) {
              console.log(`Processing API data - found ${apiKnowledgeGraph.nodes.length} nodes (attempt ${attempt + 1})`);
              processApiData();
            } else if (apiKnowledgeGraph && apiKnowledgeGraph.root) {
              console.log(`Processing API data - found root node (attempt ${attempt + 1})`);
              processApiData();
            } else if (attempt < maxAttempts && window.reportData) {
              console.log(`Waiting for knowledge graph data, attempt ${attempt + 1}/${maxAttempts}`);
              setTimeout(() => waitForData(attempt + 1), delayMs);
            } else {
              console.log('No knowledge graph data available after waiting');
              console.log('Final check - window.reportData exists:', !!window.reportData);
              console.log('Final check - knowledge_graph exists:', !!window.reportData?.data?.knowledge_graph);

              // Force show the data if it exists but condition failed
              const finalCheckGraph = window.reportData?.data?.knowledge_graph;
              if (finalCheckGraph) {
                console.log('FORCED PROCESSING - Data exists but condition failed');
                console.log('Final check graph keys:', Object.keys(finalCheckGraph));
                apiKnowledgeGraph = finalCheckGraph;
                processApiData();
                return;
              }

              showFallback();
            }
          }

          waitForData();
        }

        // Variables no longer needed since we removed position logic

        function processApiData() {
          // Transform API data structure to D3.js format with proper positioning

          knowledgeGraph = {
            nodes: [
              // Add root node if it exists
              ...(apiKnowledgeGraph.root ? [{
                id: apiKnowledgeGraph.root.id,
                name: apiKnowledgeGraph.root.name,
                type: apiKnowledgeGraph.root.type,
                description: apiKnowledgeGraph.root.description,
                category: apiKnowledgeGraph.root.type,
                position: apiKnowledgeGraph.root.position || { x: 0, y: 0 }
              }] : []),
              // Add all nodes from API - don't set x,y here, let the simulation handle it
              ...apiKnowledgeGraph.nodes.map(node => {
                console.log('Processing node:', node);
                const pos = node.position || { x: 0, y: 0 };
                return {
                  id: node.id,
                  name: node.name,
                  type: node.type,
                  category: node.category || node.type,
                  description: node.description,
                  position: pos,
                  relationship: node.relationship,
                  news: node.news,
                  market_data: node.market_data,
                  hover_info: node.hover_info
                };
              })
            ],
            edges: apiKnowledgeGraph.edges ? apiKnowledgeGraph.edges.map(edge => ({
              source: edge.from,
              target: edge.to,
              relationship: edge.relationship,
              strength: edge.strength || 0.5
            })) : []
          };

          console.log('Transformed knowledge graph:', knowledgeGraph);

          // Now that we have the data, continue with visualization
          continueWithVisualization();
        }

        function showFallback() {
          // Show fallback message if no data
          const container = document.getElementById('knowledgeGraph');
          if (container) {
            container.innerHTML = `
              <div class="flex flex-col items-center justify-center h-full text-center p-8">
                <div class="w-24 h-24 mx-auto mb-6 bg-[#2E3137] rounded-full flex items-center justify-center">
                  <svg class="w-12 h-12 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">No Knowledge Graph Data</h3>
                <p class="text-white/60 max-w-md">
                  Knowledge graph data will be available once the system processes dependency relationships and generates the visualization.
                </p>
              </div>
            `;
          }
          return;
        }

        function continueWithVisualization() {
          // Get container dimensions for centering
          const container = document.getElementById('knowledgeGraph');
          const containerWidth = container ? container.clientWidth : width;
          const containerHeight = container ? container.clientHeight : height;
          const centerX = containerWidth / 2;
          const centerY = containerHeight / 2;

          // Safety checks
          if (!knowledgeGraph || !knowledgeGraph.nodes || !knowledgeGraph.edges) {
            console.error('Knowledge graph data is missing or malformed:', knowledgeGraph);
            showFallback();
            return;
          }

          // Color function based on position: root=yellow, left=blue, right=green
          function getNodeColor(node) {
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            
            if (node === rootNode) {
              return '#f1d85b'; // Yellow for root node
            }
            
            const pos = node.position || { x: 0, y: 0 };
            if (pos.x < 0) {
              return '#3B82F6'; // Blue for left side
            } else if (pos.x > 0) {
              return '#10B981'; // Green for right side
            } else {
              return '#8B5CF6'; // Purple for center/neutral
            }
          }

          // Declare simulation variable first so drag handlers can access it
          let simulation;

          // Drag functions - define before using them
          function dragstarted(event, d) {
            if (!d) {
              console.error('Drag started with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            if (simulation && !event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            if (!d) {
              console.error('Drag with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!d) {
              console.error('Drag ended with undefined node');
              return;
            }
            // Prevent dragging of root node
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            if (d === rootNode) {
              return;
            }
            if (simulation && !event.active) simulation.alphaTarget(0);
            // Don't completely free the node, allow some movement but maintain general position
            d.fx = null;
            d.fy = null;
          }

          // Draw edges
          const link = g.selectAll('.link')
            .data(knowledgeGraph.edges)
            .enter()
            .append('line')
            .attr('class', 'link')
            .attr('stroke', '#ffffff')
            .attr('stroke-width', d => (d.strength || 0.5) * 3)
            .attr('stroke-opacity', 0.6)
            .style('pointer-events', 'none'); // Prevent hover events on edges

          // Draw nodes
          const node = g.selectAll('.node')
            .data(knowledgeGraph.nodes)
            .enter()
            .append('g')
            .attr('class', 'node')
            .style('cursor', 'pointer')
            .call(d3.drag()
              .on('start', dragstarted)
              .on('drag', dragged)
              .on('end', dragended));

          // Node circles
          const nodeCircles = node.append('circle')
            .attr('r', 20)
            .attr('fill', d => getNodeColor(d))
            .attr('stroke', '#ffffff')
            .attr('stroke-width', 2);

          // Node labels
          node.append('text')
            .attr('dx', 0)
            .attr('dy', 35)
            .attr('text-anchor', 'middle')
            .attr('fill', '#ffffff')
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .text(d => d.name);

          // Position nodes based on coordinate signs - left/right of root
          const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
          
          // Set initial positions based on x coordinate sign
          knowledgeGraph.nodes.forEach(node => {
            const pos = node.position || { x: 0, y: 0 };
            
            if (node === rootNode) {
              // Keep root node at center
              node.fx = centerX;
              node.fy = centerY;
            } else {
              // Position based on x coordinate sign
              const offsetX = Math.abs(pos.x) > 0.5 ? 250 : 200; // Increased distance from center
              const offsetY = pos.y * 80; // Vertical offset based on y coordinate
              
              if (pos.x < 0) {
                // Negative x = left side
                node.x = centerX - offsetX;
                node.fx = centerX - offsetX;
              } else if (pos.x > 0) {
                // Positive x = right side  
                node.x = centerX + offsetX;
                node.fx = centerX + offsetX;
              } else {
                // x = 0 = center
                node.x = centerX;
                node.fx = centerX;
              }
              
              node.y = centerY + offsetY;
            }
          });

          // Create a gentler force simulation that respects fixed positioning
          simulation = d3.forceSimulation(knowledgeGraph.nodes)
            .force('link', d3.forceLink(knowledgeGraph.edges)
              .id(d => d.id)
              .distance(200) // Increased edge length for better spacing
              .strength(0.3) // Link strength for connections
            )
            .force('charge', d3.forceManyBody().strength(-100)) // Light repulsion to prevent overlap
            .force('collision', d3.forceCollide().radius(40)) // Prevent overlap
            .alpha(0.5) // Start with medium energy
            .alphaDecay(0.02) // Slower decay to maintain layout

          if (simulation) {
            simulation.on('tick', () => {
              link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

              node.attr('transform', d => `translate(${d.x},${d.y})`);
            });
          }

          // Mouse events - only on circles, not edges or empty space
          nodeCircles.on('mouseover', function(event, d) {
            if (!d) {
              console.error('Mouseover with undefined node');
              return;
            }
            
            // Clear any existing timeout
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            
            // Highlight the circle
            d3.select(this)
              .attr('stroke-width', 4)
              .attr('stroke', '#f1d85b');

            // Show tooltip with metadata
            let tooltipContent = `
              <div style="max-width: 560px; word-wrap: break-word; line-height: 1.4;">
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #ffffff;">${d.name}</div>
                <div style="font-size: 12px; margin-bottom: 8px; color: #e5e5e5;">${d.hover_info || d.description || 'No description available'}</div>
                ${d.relationship ? `<div style="font-size: 12px; color: #f1d85b; margin-bottom: 8px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><strong>Relationship:</strong><br/>${d.relationship}</div>` : ''}
                ${d.news && d.news.length > 0 ? `
                  <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                    <div style="font-weight: bold; color: #f1d85b; margin-bottom: 4px; font-size: 12px;">Recent News:</div>
                    ${d.news.slice(0, 3).map(news => `
                      <div style="font-size: 11px; margin-bottom: 4px;">
                        <a href="${news.link}" target="_blank" style="color: #60a5fa; text-decoration: underline;">${news.title}</a>
                        <div style="color: #9ca3af; font-size: 10px;">${news.source} - ${news.date}</div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                ${d.market_data ? `
                  <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                    <div style="font-weight: bold; color: #f1d85b; margin-bottom: 4px; font-size: 12px;">Market Data:</div>
                    ${d.market_data.stock_ticker ? `<div style="font-size: 12px; margin-bottom: 2px;">Ticker: ${d.market_data.stock_ticker}</div>` : ''}
                    ${d.market_data.stock_price ? `<div style="font-size: 12px; margin-bottom: 2px;">Price: ${d.market_data.stock_price}</div>` : ''}
                    ${d.market_data.market_info ? `
                      <div style="max-height: 150px; overflow-y: auto; margin-top: 4px; padding-right: 8px;">
                        <div class="markdown-content" style="font-size: 11px; line-height: 1.3;">${typeof marked !== 'undefined' ? marked.parse(d.market_data.market_info) : d.market_data.market_info}</div>
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            `;

            // Set content first, then position
            tooltip.html(tooltipContent);
            
            // Use setTimeout to ensure content is rendered before measuring
            setTimeout(() => {
              const tooltipRect = tooltip.node().getBoundingClientRect();
              const viewportWidth = window.innerWidth;
              const viewportHeight = window.innerHeight;
              
              // Calculate initial position (prefer top-left of cursor)
              let left = event.clientX + 15;
              let top = event.clientY - 15;
              
              // Adjust if tooltip would go off the right edge
              if (left + tooltipRect.width > viewportWidth - 20) {
                left = event.clientX - tooltipRect.width - 15;
              }
              
              // Adjust if tooltip would go off the bottom edge
              if (top + tooltipRect.height > viewportHeight - 20) {
                top = event.clientY - tooltipRect.height - 15;
              }
              
              // Ensure tooltip doesn't go off the top or left edges
              left = Math.max(10, left);
              top = Math.max(10, top);
              
              // Apply positioning and show tooltip
              tooltip
                .style('left', left + 'px')
                .style('top', top + 'px')
                .style('opacity', 1);
                
              tooltipVisible = true;
            }, 0);
          })
          .on('mouseout', function() {
            // Remove highlight from circle
            d3.select(this)
              .attr('stroke-width', 2)
              .attr('stroke', '#ffffff');

            // Set timeout to hide tooltip with delay
            tooltipTimeout = setTimeout(() => {
              if (tooltipVisible) {
                tooltip.style('opacity', 0);
                tooltipVisible = false;
              }
            }, 200); // 200ms delay before hiding
          });

          // Tooltip event handlers for hover interaction
          tooltip.on('mouseenter', function() {
            // Clear any pending timeout when hovering over tooltip
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
            tooltip.style('opacity', 1);
            tooltipVisible = true;
          });

          tooltip.on('mouseleave', function() {
            // Hide tooltip when mouse leaves tooltip
            tooltip.style('opacity', 0);
            tooltipVisible = false;
            if (tooltipTimeout) {
              clearTimeout(tooltipTimeout);
              tooltipTimeout = null;
            }
          });

          // Zoom controls
          document.getElementById('zoomIn')?.addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
          });

          document.getElementById('zoomOut')?.addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.67);
          });

          document.getElementById('resetView')?.addEventListener('click', () => {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            
            // Reset to left/right positioning based on coordinates
            const rootNode = knowledgeGraph.nodes.find(n => n.name === 'Sia' || n.type === 'company');
            
            knowledgeGraph.nodes.forEach(node => {
              const pos = node.position || { x: 0, y: 0 };
              
              if (node === rootNode) {
                // Keep root node at center
                node.fx = centerX;
                node.fy = centerY;
              } else {
                // Reposition based on x coordinate sign
                const offsetX = Math.abs(pos.x) > 0.5 ? 250 : 200;
                const offsetY = pos.y * 80;
                
                if (pos.x < 0) {
                  // Negative x = left side
                  node.fx = centerX - offsetX;
                } else if (pos.x > 0) {
                  // Positive x = right side  
                  node.fx = centerX + offsetX;
                } else {
                  // x = 0 = center
                  node.fx = centerX;
                }
                
                node.fy = null; // Allow vertical movement
                node.y = centerY + offsetY;
              }
            });
            
            if (simulation) {
              simulation.alpha(0.5).restart();
            }
          });

          // Graph Info button
          document.getElementById('graphInfoBtn')?.addEventListener('click', () => {
            openGraphInfoModal();
          });
        }
      }

      // Open graph info modal
      function openGraphInfoModal() {
        const modal = document.getElementById('graphInfoModal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      }

      // Close graph info modal
      function closeGraphInfoModal() {
        const modal = document.getElementById('graphInfoModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = ''; // Restore scrolling
        }
      }

      // Initialize graph info modal
      function initializeGraphInfoModal() {
        const graphInfoBtn = document.getElementById('graphInfoBtn');
        const closeBtn = document.getElementById('closeGraphInfo');
        const modal = document.getElementById('graphInfoModal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closeGraphInfoModal);
        }
        
        if (modal) {
          // Close modal when clicking outside
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeGraphInfoModal();
            }
          });
          
          // Close modal with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              closeGraphInfoModal();
            }
          });
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Initialize tabs
        initializeTabs();
        initializeGrowthPotentialInfo();
        initializeDocumentationModal();
        initializeGraphInfoModal();
        initializeShareDropdown();
        initializePDFDownload();
        initializeChat();
        initializeFileViewToggle();
        
        // Initialize news/documents tab switching
        const industryNewsTab = document.getElementById('industryNewsTab');
        const internetDocumentsTab = document.getElementById('internetDocumentsTab');
        
        if (industryNewsTab) {
          industryNewsTab.addEventListener('click', () => switchNewsTab('news'));
        }
        
        if (internetDocumentsTab) {
          internetDocumentsTab.addEventListener('click', () => switchNewsTab('documents'));
        }
        
        // Show page loader initially
        showPageLoader();
        
        // Check authentication and load data
      fetch('/api/auth/me').then(r=>r.json()).then(d=>{
          if(!d.user){ 
            window.location.href='/auth.html'; 
          } else {
            // Load user email in tooltip
            const userEmailText = document.getElementById('userEmailText');
            if (userEmailText) {
              userEmailText.textContent = d.user.email;
            }
            // Load report data after authentication check
            fetchReportData();
          }
        }).catch(()=> {
          window.location.href='/auth.html';
        });
      });
      
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async ()=>{
          await fetch('/api/auth/logout',{method:'POST'});
          window.location.href='/auth.html';
        });
      }
      // Charts (initialize after layout)
      window.addEventListener('load', () => {
        if (!window.Chart) return;
        // Search expand/collapse
        const btn = document.getElementById('searchBtn');
        const inp = document.getElementById('searchInput');
        if (btn && inp) {
          btn.addEventListener('click', () => {
            const expanded = inp.classList.contains('opacity-100');
            if (expanded) {
              inp.classList.remove('opacity-100'); inp.style.width='0px'; inp.style.paddingLeft='0px'; inp.style.paddingRight='0px'; inp.classList.add('opacity-0');
            } else {
              inp.style.width='180px'; inp.style.paddingLeft='12px'; inp.style.paddingRight='12px'; inp.classList.remove('opacity-0'); inp.classList.add('opacity-100'); inp.focus();
            }
          });
        }
        // Market value chart will be created dynamically from API data
        // The old static income chart code has been replaced with createMarketValueChart()

        // Donut chart
        const donutCanvas = document.getElementById('donutChart');
        if (donutCanvas) {
          const rect = donutCanvas.parentElement.getBoundingClientRect();
          donutCanvas.width = rect.width; donutCanvas.height = rect.height;
          const dctx = donutCanvas.getContext('2d');
          new Chart(dctx, { type: 'doughnut', data: { datasets: [{ data: [65,25,10], backgroundColor: ['#f1d85b','#ffffff','#ff6b6b'], borderWidth: 0, cutout: '68%' }]}, options: { plugins: { legend: { display:false } }, responsive: true, maintainAspectRatio: false } });
        }
      });

      // Sidebar sign out
      const signout = document.getElementById('signoutBtn');
      if (signout) {
        signout.addEventListener('click', async ()=>{
          try { await fetch('/api/auth/logout',{method:'POST'}); } catch(e) {}
          window.location.href='/auth.html';
        });
      }
    </script>
  </body>
  </html>


