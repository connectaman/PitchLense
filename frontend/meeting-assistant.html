<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meeting Assistant - PitchLense</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-background text-text font-sans antialiased overflow-x-hidden bg-solid">
    <div id="app" class="h-screen flex flex-col p-3 gap-3">
        <!-- Header -->
        <header class="h-16 bg-[#2E3137] border border-white/10 rounded-[22px] flex items-center justify-between px-6 mobile-header flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full grid place-items-center">
                    <img src="/static/logo.svg" alt="PitchLense" class="w-5 h-5" />
                </div>
                <span class="text-base font-semibold">AI Meeting Assistant</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="tryAgainBtn" class="hidden bg-[#FFF27A] text-[#1E1E21] font-semibold px-4 py-2 rounded-lg hover:bg-[#f0e068] transition-colors mr-2">Try Again</button>
                <div id="userProfileIcon" class="w-9 h-9 rounded-full border border-white/15 bg-[#FFF27A] grid place-items-center text-[#1E1E21] relative group">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.31 0-6 2.69-6 6h12c0-3.31-2.69-6-6-6Z"/>
                    </svg>
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-2 bg-[#1E1E21] text-white text-sm rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50">
                        <span id="userEmailText">Loading...</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-[#1E1E21]"></div>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid flex-1 min-h-0 mobile-navbar" style="grid-template-columns: 84px 1fr; gap:12px;">
            <!-- Sidebar Navigation -->
            <aside id="pitchlense-navbar" class="bg-[#2C2F34] border border-white/10 rounded-[18px] flex flex-col items-center py-4 gap-3">
                <!-- Navigation will be loaded by navbar.js -->
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden bg-[#2E3137] border border-white/10 rounded-[14px] p-6 mobile-main">
                <div class="max-w-6xl mx-auto w-full space-y-6">
                    <!-- Connect Platforms -->
                    <div id="connect-section" class="bg-[#2C2F34] border border-white/10 rounded-xl p-6">
                        <h2 class="text-xl font-bold mb-4">Connect your meeting platform</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button disabled title="Coming soon" aria-disabled="true" class="flex items-center justify-center gap-2 bg-white/10 border border-white/10 rounded-lg py-3 opacity-50 cursor-not-allowed">
                                <img src="https://cdn.iconscout.com/icon/free/png-256/free-google-meet-logo-icon-svg-download-png-2476480.png?f=webp" alt="Google Meet" class="w-5 h-5" referrerpolicy="no-referrer" onerror="this.style.display='none'"> Google Meet
                            </button>
                            <button disabled title="Coming soon" aria-disabled="true" class="flex items-center justify-center gap-2 bg-white/10 border border-white/10 rounded-lg py-3 opacity-50 cursor-not-allowed">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/50/Microsoft_Teams.png" alt="Microsoft Teams" class="w-5 h-5" referrerpolicy="no-referrer" onerror="this.style.display='none'"> Microsoft Teams
                            </button>
                            <button disabled title="Coming soon" aria-disabled="true" class="flex items-center justify-center gap-2 bg-white/10 border border-white/10 rounded-lg py-3 opacity-50 cursor-not-allowed">
                                <img src="https://s2.googleusercontent.com/s2/favicons?domain=zoom.us" alt="Zoom" class="w-5 h-5"> Zoom
                            </button>
                        </div>
                        <p class="text-xs text-white/50 mt-2">Coming soon: direct calendar sync and auto-recording import</p>
                    </div>

                    <!-- Upload Section -->
                    <div id="upload-section" class="bg-[#2C2F34] border border-white/10 rounded-xl p-6">
                        <h2 class="text-xl font-bold mb-2">Upload meeting recording</h2>
                        <p class="text-white/70 mb-4">Supported formats: mp4, webm, mov (up to 100MB for demo)</p>
                        <div class="flex flex-col sm:flex-row gap-3 items-center">
                            <input id="videoInput" type="file" accept="video/*" class="bg-[#1E1E21] border border-white/10 rounded-lg px-4 py-3 w-full">
                            <button id="analyzeBtn" class="bg-[#FFF27A] text-[#1E1E21] font-semibold px-6 py-3 rounded-lg hover:bg-[#f0e068] disabled:bg-gray-600 disabled:text-white/40" disabled>Analyze</button>
                        </div>
                        <p id="selectedFile" class="text-white/60 mt-2"></p>
                    </div>

                    <!-- Loading -->
                    <div id="loading" class="hidden bg-[#2C2F34] border border-white/10 rounded-xl p-6 text-center">
                        <div class="animate-spin h-8 w-8 border-4 border-[#FFF27A] border-t-transparent rounded-full mx-auto mb-3"></div>
                        <p class="text-white/80">Transcribing and summarizing your meeting with AI...</p>
                    </div>

                    <!-- Results -->
                    <div id="results" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-[#2C2F34] border border-white/10 rounded-xl p-6 flex flex-col">
                            <h3 class="text-lg font-bold mb-3">Transcript</h3>
                            <div id="transcript" class="prose prose-invert max-w-none whitespace-pre-wrap text-white/80 text-sm overflow-y-auto flex-1" style="max-height: 80vh;"></div>
                        </div>
                        <div class="bg-[#2C2F34] border border-white/10 rounded-xl p-6 flex flex-col">
                            <div class="space-y-4 overflow-y-auto flex-1" style="max-height: 80vh;">
                                <h3 class="text-lg font-bold">Summary</h3>
                                <div id="summary" class="text-white/80"></div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-white">Key Takeaways</h4>
                                    <ul id="takeaways" class="list-disc list-inside text-white/80 space-y-1"></ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-white">Decisions</h4>
                                    <ul id="decisions" class="list-disc list-inside text-white/80 space-y-1"></ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-white">Action Items</h4>
                                    <ul id="actions" class="list-disc list-inside text-white/80 space-y-1"></ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold mb-2 text-white">Follow-ups</h4>
                                    <ul id="followups" class="list-disc list-inside text-white/80 space-y-1"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Bottom Dock -->
        <div id="bottomDock" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
            <div class="bg-[#2C2F34] border border-white/10 rounded-2xl px-6 py-4 flex items-center gap-4 shadow-2xl">
                <button id="downloadBtn" class="flex items-center gap-2 bg-[#FFF27A] text-[#1E1E21] font-semibold px-4 py-2 rounded-lg hover:bg-[#f0e068] transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Download Report
                </button>
                <button id="emailBtn" class="flex items-center gap-2 bg-[#FFF27A] text-[#1E1E21] font-semibold px-4 py-2 rounded-lg hover:bg-[#f0e068] transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                    Email Report
                </button>
            </div>
        </div>
    </div>

    <script src="/static/navbar.js"></script>
    <script>
        const email = localStorage.getItem('userEmail');
        if (email) document.getElementById('userEmailText').textContent = email;

        const input = document.getElementById('videoInput');
        const btn = document.getElementById('analyzeBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const selected = document.getElementById('selectedFile');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const connectSection = document.getElementById('connect-section');
        const uploadSection = document.getElementById('upload-section');
        const bottomDock = document.getElementById('bottomDock');
        const downloadBtn = document.getElementById('downloadBtn');
        const emailBtn = document.getElementById('emailBtn');

        input.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) { btn.disabled = true; selected.textContent=''; return; }
            selected.textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
            btn.disabled = false;
        });

        btn.addEventListener('click', async () => {
            const file = input.files[0];
            if (!file) return;
            btn.disabled = true; loading.classList.remove('hidden'); results.classList.add('hidden');
            // Hide setup sections during processing
            connectSection.classList.add('hidden');
            uploadSection.classList.add('hidden');
            try {
                const form = new FormData();
                form.append('video', file);
                const res = await fetch('/api/meeting-assistant/analyze', { method: 'POST', credentials: 'include', body: form });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to analyze');
                }
                const data = await res.json();
                document.getElementById('transcript').textContent = data.transcript || '—';
                document.getElementById('summary').textContent = data.summary || '—';
                renderList('takeaways', data.keyTakeaways);
                renderList('decisions', data.decisions);
                renderList('actions', data.actionItems);
                renderList('followups', data.followUps);
                results.classList.remove('hidden');
                bottomDock.classList.remove('hidden');
                tryAgainBtn.classList.remove('hidden');
            } catch (e) {
                Swal.fire({ icon:'error', title:'Analysis failed', text: e.message });
                // Show setup back on error so user can retry
                connectSection.classList.remove('hidden');
                uploadSection.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                btn.disabled = false;
            }
        });

        // Try Again handler
        tryAgainBtn.addEventListener('click', () => {
            // Reset UI to initial state
            document.getElementById('transcript').textContent = '';
            document.getElementById('summary').textContent = '';
            renderList('takeaways', []);
            renderList('decisions', []);
            renderList('actions', []);
            renderList('followups', []);
            results.classList.add('hidden');
            bottomDock.classList.add('hidden');
            tryAgainBtn.classList.add('hidden');
            connectSection.classList.remove('hidden');
            uploadSection.classList.remove('hidden');
            input.value = '';
            selected.textContent = '';
            btn.disabled = true;
        });

        function renderList(id, items) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            (items || []).forEach(i => {
                const li = document.createElement('li');
                li.textContent = i;
                el.appendChild(li);
            });
        }

        // Download button functionality
        downloadBtn.addEventListener('click', async () => {
            const transcript = document.getElementById('transcript').textContent;
            const summary = document.getElementById('summary').textContent;
            const takeaways = Array.from(document.getElementById('takeaways').children).map(li => li.textContent);
            const decisions = Array.from(document.getElementById('decisions').children).map(li => li.textContent);
            const actions = Array.from(document.getElementById('actions').children).map(li => li.textContent);
            const followups = Array.from(document.getElementById('followups').children).map(li => li.textContent);
            
            // First file: transcript.txt
            const transcriptBlob = new Blob([transcript], { type: 'text/plain' });
            const transcriptUrl = URL.createObjectURL(transcriptBlob);
            const transcriptLink = document.createElement('a');
            transcriptLink.href = transcriptUrl;
            transcriptLink.download = 'transcript.txt';
            document.body.appendChild(transcriptLink);
            transcriptLink.click();
            document.body.removeChild(transcriptLink);
            URL.revokeObjectURL(transcriptUrl);
            
            // Wait a moment before downloading the second file
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Second file: summary.txt
            const summaryContent = `SUMMARY:
${summary}

KEY TAKEAWAYS:
${takeaways.map(item => `• ${item}`).join('\n')}

DECISIONS:
${decisions.map(item => `• ${item}`).join('\n')}

ACTION ITEMS:
${actions.map(item => `• ${item}`).join('\n')}

FOLLOW-UPS:
${followups.map(item => `• ${item}`).join('\n')}`;

            const summaryBlob = new Blob([summaryContent], { type: 'text/plain' });
            const summaryUrl = URL.createObjectURL(summaryBlob);
            const summaryLink = document.createElement('a');
            summaryLink.href = summaryUrl;
            summaryLink.download = 'summary.txt';
            document.body.appendChild(summaryLink);
            summaryLink.click();
            document.body.removeChild(summaryLink);
            URL.revokeObjectURL(summaryUrl);
        });

        // Email button functionality
        emailBtn.addEventListener('click', () => {
            const summary = document.getElementById('summary').textContent;
            const takeaways = Array.from(document.getElementById('takeaways').children).map(li => li.textContent);
            const decisions = Array.from(document.getElementById('decisions').children).map(li => li.textContent);
            const actions = Array.from(document.getElementById('actions').children).map(li => li.textContent);
            const followups = Array.from(document.getElementById('followups').children).map(li => li.textContent);
            
            // Create email modal
            const emailModal = document.createElement('div');
            emailModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            emailModal.innerHTML = `
                <div class="bg-[#2C2F34] border border-white/10 rounded-xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4 text-white">Send Meeting Summary</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-white/80 mb-2">Email Address</label>
                            <input type="email" id="emailInput" placeholder="Enter email address" 
                                   class="w-full bg-[#1E1E21] border border-white/10 rounded-lg px-3 py-2 text-white placeholder-white/50 focus:outline-none focus:border-[#FFF27A]">
                        </div>
                        <div class="flex gap-3">
                            <button id="sendEmailBtn" class="flex-1 bg-[#FFF27A] text-[#1E1E21] font-semibold px-4 py-2 rounded-lg hover:bg-[#f0e068] transition-colors">
                                Send Email
                            </button>
                            <button id="cancelEmailBtn" class="flex-1 bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(emailModal);
            
            const emailInput = emailModal.querySelector('#emailInput');
            const sendBtn = emailModal.querySelector('#sendEmailBtn');
            const cancelBtn = emailModal.querySelector('#cancelEmailBtn');
            
            // Send email functionality
            sendBtn.addEventListener('click', async () => {
                const email = emailInput.value.trim();
                if (!email) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Please enter an email address' });
                    return;
                }
                
                if (!email.includes('@')) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Please enter a valid email address' });
                    return;
                }
                
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                
                try {
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
                                .header { background: linear-gradient(135deg, #f1d85b, #78e6d0); padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
                                .header h1 { color: #1e1e21; margin: 0; font-size: 28px; }
                                .section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f1d85b; }
                                .section h2 { color: #1e1e21; margin-top: 0; font-size: 20px; }
                                .section h3 { color: #1e1e21; margin-top: 0; font-size: 16px; }
                                ul { margin: 10px 0; padding-left: 20px; }
                                li { margin: 8px 0; }
                                .summary-text { background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; }
                                .footer { text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; color: #666; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>📊 Meeting Analysis Report</h1>
                                <p>Generated by PitchLense AI Meeting Assistant</p>
                            </div>
                            
                            <div class="section">
                                <h2>📝 Summary</h2>
                                <div class="summary-text">${summary}</div>
                            </div>
                            
                            ${takeaways.length > 0 ? `
                            <div class="section">
                                <h2>🎯 Key Takeaways</h2>
                                <ul>
                                    ${takeaways.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${decisions.length > 0 ? `
                            <div class="section">
                                <h2>✅ Decisions Made</h2>
                                <ul>
                                    ${decisions.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${actions.length > 0 ? `
                            <div class="section">
                                <h2>📋 Action Items</h2>
                                <ul>
                                    ${actions.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${followups.length > 0 ? `
                            <div class="section">
                                <h2>🔄 Follow-ups</h2>
                                <ul>
                                    ${followups.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            <div class="footer">
                                <p>This report was generated by PitchLense AI Meeting Assistant</p>
                                <p>For more information, visit <a href="https://pitchlense.com" style="color: #f1d85b;">pitchlense.com</a></p>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    const response = await fetch('/api/emails/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            to: email,
                            subject: 'Meeting Analysis Report - PitchLense',
                            body: htmlContent
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send email');
                    }
                    
                    Swal.fire({ 
                        icon: 'success', 
                        title: 'Email Sent!', 
                        text: `Meeting summary has been sent to ${email}` 
                    });
                    
                    document.body.removeChild(emailModal);
                    
                } catch (error) {
                    Swal.fire({ 
                        icon: 'error', 
                        title: 'Failed to send email', 
                        text: error.message 
                    });
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Email';
                }
            });
            
            // Cancel functionality
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(emailModal);
            });
            
            // Close on backdrop click
            emailModal.addEventListener('click', (e) => {
                if (e.target === emailModal) {
                    document.body.removeChild(emailModal);
                }
            });
            
            // Focus on email input
            emailInput.focus();
        });
    </script>
</body>
</html>



